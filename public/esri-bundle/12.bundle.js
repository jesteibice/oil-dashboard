(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/3d/layers/SceneLayerWorker":2123,"esri/views/3d/layers/i3s/I3SGeometryUtil":2228,"esri/views/3d/layers/i3s/I3SProjectionUtil":2229,"esri/views/3d/webgl-engine/lib/HighlightSet":2264,"esri/views/3d/layers/I3SMeshView3D":2272,"esri/views/3d/webgl-engine/materials/component/Parameters":2332,"esri/views/3d/webgl-engine/materials/component/VertexBufferLayout":2333,"esri/views/3d/layers/i3s/Highlights":2511,"esri/views/3d/layers/i3s/I3SElevationProvider":2512,"esri/views/3d/layers/i3s/IDBCache":2513,"esri/views/3d/webgl-engine/materials/component/index":2514,"esri/views/3d/webgl-engine/materials/component/ComponentMaterial":2515,"esri/views/3d/webgl-engine/materials/component/ComponentGLMaterial":2516,"esri/views/3d/webgl-engine/materials/internal/TextureBinding":2517,"esri/views/3d/webgl-engine/materials/renderers/PreinterleavedRenderer":2518})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[12,28],{2123:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(9),r(11),r(135),r(15),r(7),r(24),r(21),r(476),r(2201),r(10),r(6),r(32),r(480),r(2247),r(2184),r(2228),r(2229),r(2182),r(2195),r(38),r(828),r(22)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u,d,h,f,p,m,g,y,v,b,_,x,C,w){function I(e){return null==e.geometryIndex.header}function S(e,t){var r=new Array,n=e.layouts[0],o=e.geometryBuffer,l=new N.DecoderBuffer;l.Init(new Int8Array(o),o.byteLength);var c=new N.Decoder,u=new N.Mesh,d=c.DecodeBufferToMesh(l,u);if(!d.ok())throw N.destroy(u),N.destroy(c),N.destroy(l),new i("draco:decode_error","Error while decoding draco geometry",{message:d.error_msg()});var h=new N.DracoInt32Array,p=new N.MetadataQuerier,m=c.GetAttributeIdByMetadataEntry(u,"i3s-attribute-type","feature-index"),g=c.GetAttributeMetadata(u,m);p.GetIntEntryArray(g,"i3s-feature-ids",h);var b=h.size(),_=N._malloc(4*b);if(!h.GetArray(_,b))throw"GetArray failed";var x=new Uint32Array(N.HEAPU8.buffer,_,b).slice();N._free(_);var I=u.num_points(),S=3*u.num_faces(),O=I<65536;if(_=N._malloc(S*(O?2:4)),!(O?c.GetTrianglesUInt16Array(u,_,S):c.GetTrianglesUInt32Array(u,_,S)))throw"GetTrianglesArray failed";var E=O?new Uint16Array(N.HEAPU8.buffer,_,S).slice():new Uint32Array(N.HEAPU8.buffer,_,S).slice();N._free(_);var T=function(e,t){for(var r=new Array,n=0;n<e.length;++n){for(var a=e[n],i=t[a];r.length<=i;)r.push(new Array);r[i].push(a)}for(var o=0,s=new Uint32Array(r.length+1),n=0;n<r.length;++n){var l=r[n];s[n]=o;for(var c=0,u=l;c<u.length;c++){var a=u[c];e[o++]=a}}return s[r.length]=o,s}(E,function(e,t,r,n){var a=4*e,o=N._malloc(a),s=t.GetAttribute(r,n);if(!t.GetAttributeUInt32ArrayForAllPoints(r,s,o,e))throw new i("draco:decode_error","Error while getting attribute values",{attributeId:n});var l=new Uint32Array(N.HEAPU8.buffer,o,e).slice();return N._free(o),l}(I,c,u,m)),P=n[0].stride/Float32Array.BYTES_PER_ELEMENT,R=new Float32Array(P*I),D=new C(R,n,null,T,E),V=c.GetAttributeId(u,N.POSITION),G=M(3*I,c,u,V),B=D.getAttribute(w.VertexAttrConstants.POSITION),U=c.GetAttributeMetadata(u,V),L=p.GetDoubleEntry(U,"i3s-scale_x"),F=p.GetDoubleEntry(U,"i3s-scale_y");L=L<=0?1:L,F=F<=0?1:F;for(var k=D.getAttribute(w.VertexAttrConstants.COLOR),z=c.GetAttributeId(u,N.COLOR),H=-1!==z,q=H?function(e,t,r,n){var a=e,o=N._malloc(a),s=t.GetAttribute(r,n);if(!t.GetAttributeUInt8ArrayForAllPoints(r,s,o,e))throw new i("draco:decode_error","Error while getting attribute values",{attributeId:n});var l=new Uint8Array(N.HEAPU8.buffer,o,e).slice();return N._free(o),l}(4*I,c,u,z):a.fill(new Array(4*I),255),W=0;W<I;W++){var Y=W*B.strideIdx+B.offsetIdx;B.data[Y]=G[3*W]*L,B.data[Y+1]=G[3*W+1]*F,B.data[Y+2]=G[3*W+2];var J=W*k.strideIdx+k.offsetIdx;k.data[J]=q[4*W],k.data[J+1]=q[4*W+1],k.data[J+2]=q[4*W+2],k.data[J+3]=q[4*W+3]}var K=c.GetAttributeId(u,N.NORMAL),X=D.getAttribute(w.VertexAttrConstants.NORMAL);if(-1!==K&&X){var Z=M(3*I,c,u,K);for(W=0;W<I;W++){var Q=W*X.strideIdx+X.offsetIdx;X.data[Q]=Z[3*W],X.data[Q+1]=Z[3*W+1],X.data[Q+2]=Z[3*W+2]}}else e.needNormals&&X&&y.computeCompressedNormals({normals:D.getAttribute(w.VertexAttrConstants.NORMALCOMPRESSED),positions:D.getAttribute(w.VertexAttrConstants.POSITION),normalInd:D.getIndices(w.VertexAttrConstants.NORMALCOMPRESSED),positionInd:D.getIndices(w.VertexAttrConstants.POSITION)});var $=c.GetAttributeId(u,N.TEX_COORD),ee=D.getAttribute(w.VertexAttrConstants.UV0);if(-1!==$&&ee){var te=M(2*I,c,u,$);for(W=0;W<I;W++){Q=W*ee.strideIdx+ee.offsetIdx;ee.data[Q]=te[2*W],ee.data[Q+1]=te[2*W+1]}}var re=c.GetAttributeIdByMetadataEntry(u,"i3s-attribute-type","uv-region"),ne=D.getAttribute(w.VertexAttrConstants.REGION);if(-1!==re&&ne){var ae=function(e,t,r,n){var a=2*e,o=N._malloc(a),s=t.GetAttribute(r,n);if(!t.GetAttributeUInt16ArrayForAllPoints(r,s,o,e))throw new i("draco:decode_error","Error while getting attribute values",{attributeId:n});var l=new Uint16Array(N.HEAPU8.buffer,o,e).slice();return N._free(o),l}(4*I,c,u,re);for(W=0;W<I;W++){Q=W*ne.strideIdx+ne.offsetIdx;ne.data[Q]=ae[4*W],ne.data[Q+1]=ae[4*W+1],ne.data[Q+2]=ae[4*W+2],ne.data[Q+3]=ae[4*W+3]}}var ie=D.getAttribute(w.VertexAttrConstants.COMPONENTINDEX);ie&&A(ie,T),N.destroy(p),N.destroy(h),N.destroy(u),N.destroy(c),N.destroy(l);var oe=e.mbs,se=e.elevationOffset,le=f.fromJSON(e.indexSR),ce=f.fromJSON(e.vertexSR),ue=f.fromJSON(e.renderSR),de=v.computeGlobalTransformation(oe,se,le,ue);s.mat4.invert(j,de);var he=D.getAttribute(w.VertexAttrConstants.POSITION),fe={globalTrafo:de},pe=R.buffer;v.reprojectPoints(he,oe,j,se,le,ce,ue);var me=y.extractPositionData(pe,n,E);return r.push({layout:n,interleavedVertexData:pe,indices:E,corMatrices:fe,hasColors:H,positionData:me}),t&&(t.push(pe),t.push(E.buffer)),{geometryBuffer:o,componentOffsets:T,featureIds:x,transformedGeometries:r,obb:null}}function M(e,t,r,n){var a=4*e,o=N._malloc(a),s=t.GetAttribute(r,n);if(!t.GetAttributeFloatArrayForAllPoints(r,s,o,e))throw new i("draco:decode_error","Error while getting attribute values",{attributeId:n});var l=new Float32Array(N.HEAPU8.buffer,o,e).slice();return N._free(o),l}function O(e,t,r){if(e.halfSize[0]>0){d.vec3.subtract(V,e.center,e.halfSize),d.vec3.add(G,e.center,e.halfSize);for(var n=t.offsetIdx;n<t.data.length;n+=t.strideIdx)V[0]=Math.min(V[0],t.data[n]),V[1]=Math.min(V[1],t.data[n+1]),V[2]=Math.min(V[2],t.data[n+2]),G[0]=Math.max(G[0],t.data[n]),G[1]=Math.max(G[1],t.data[n+1]),G[2]=Math.max(G[2],t.data[n+2]);d.vec3.subtract(e.halfSize,G,V),d.vec3.scale(e.halfSize,e.halfSize,.5),d.vec3.add(e.center,V,G),d.vec3.scale(e.center,e.center,.5)}else{_.compute(t,e);var a=2*Math.sqrt(1+r[0]+r[5]+r[10]);B[0]=(r[9]-r[6])/a,B[1]=(r[2]-r[8])/a,B[2]=(r[4]-r[1])/a,B[3]=.25*a,c.quat.conjugate(B,B),c.quat.multiply(e.quaternion,B,e.quaternion)}}function E(e){for(var t=e.data,r=e.size,n=e.offsetIdx,a=e.strideIdx,i=n;i<t.length;i+=a)for(var o=0;o<r;o++)if(255!==t[i+o])return!0;return!1}function A(e,t){for(var r=e.data,n=e.offsetIdx,a=e.strideIdx,i=r.length/a,o=0,s=n,l=0;l<i;l++)l>=t[o+1]&&o++,r[s]=o,s+=a}function T(e,t,r){e.geometries[0].params.vertexAttributes=r.vertexAttributes;var n,a,i=r.featureAttributes;if(i){if(i.faceRange){var o=g.createTypedView(t,i.faceRange),s=i.faceRange.valuesPerElement,l=i.faceRange.count;n=b.convertFlatRangesToOffsets(o,l,s)}var c=i.id;if(c){a=new Uint32Array(c.count);var u=1,d=g.valueType2TypedArrayClassMap[c.valueType];"UInt64"===c.valueType&&(d=Uint32Array,u=2);for(var h=new d(t,c.byteOffset,c.count*c.valuesPerElement*u),f=0;f<c.count;f++){var p=f*c.valuesPerElement*u;if(a[f]=h[p],2===u&&0!==h[p+1])throw new Error("ID exceeded maximum range supported (2^32))")}}}return{componentOffsets:n,featureIds:a}}var P=65536,R=function(){function e(){}return e.prototype.process=function(t){return n(this,void 0,void 0,function(){var n;return r(this,function(r){switch(r.label){case 0:return[4,e.ensureDracoDecoder(t)];case 1:return r.sent(),n=[t.geometryBuffer],[2,{result:this.transform(t,n),transferList:n}]}})})},e.prototype.transform=function(e,t){return I(e)?S(e,t):function(e,t){var r=e.geometryData,n=e.geometryIndex,a=e.layouts,i=e.mbs,o=e.elevationOffset,l=f.fromJSON(e.indexSR),c=f.fromJSON(e.renderSR),u=v.computeGlobalTransformation(i,o,l,c);s.mat4.invert(j,u);var h=e.geometryBuffer,m=T(r,h,n),g=m.componentOffsets,b=m.featureIds;t&&(b&&t.push(b.buffer),g&&t.push(g.buffer));var I=e.obb?null:_.create([0,0,0],[-1,-1,-1],[0,0,0,1]);d.vec3.copy(V,i),V[2]+=o,d.vec3.copy(G,V);for(var S=!1,M=0,R=new Array,D=0,N=r.geometries;D<N.length;D++){var B=N[D],U=a[M];++M;var L=e.geometryBuffer,F=[{name:w.VertexAttrConstants.COLOR,byteValue:255}],k=[w.VertexAttrConstants.NORMAL,w.VertexAttrConstants.NORMALCOMPRESSED,w.VertexAttrConstants.SYMBOLCOLOR,w.VertexAttrConstants.COMPONENTINDEX],z=y.interleaveGeometryBuffer(B,L,U,F,k),H=new C(new Float32Array(z),U),q=H.getAttribute(w.VertexAttrConstants.POSITION),W=e.mbs,Y=e.elevationOffset,J=f.fromJSON(e.indexSR),K=f.fromJSON(e.vertexSR),X=f.fromJSON(e.renderSR);if(v.reprojectPoints(q,W,j,Y,J,K,X),I&&O(I,q,u),e.needNormals){var Z={normals:H.getAttribute(w.VertexAttrConstants.NORMALCOMPRESSED),positions:q,normalInd:H.getIndices(w.VertexAttrConstants.NORMALCOMPRESSED),positionInd:H.getIndices(w.VertexAttrConstants.POSITION)},Q=e.normalReferenceFrame;y.processAndInterleaveNormals(Q,B,L,u,Z)}var $=H.getAttribute(w.VertexAttrConstants.COMPONENTINDEX);$&&A($,g);var ee=H.getAttribute(w.VertexAttrConstants.COLOR);ee&&!S&&(S=E(ee));var te={globalTrafo:u},re=U[0].stride,ne=1-.8*re/(re+4),ae=p.default(z,re/4,null,ne);if(null!=ae){var ie=ae.uniqueCount<P?new Uint16Array(ae.indices):ae.indices,oe=y.extractPositionData(ae.buffer,U,ie);R.push({layout:U,interleavedVertexData:ae.buffer,indices:ie,corMatrices:te,hasColors:S,positionData:oe}),t&&(t.push(ae.buffer),t.push(ie.buffer),t.push(oe.data.buffer),t.push(oe.indices.buffer))}else oe=y.extractPositionData(z,U),R.push({layout:U,interleavedVertexData:z,corMatrices:te,hasColors:S,positionData:oe}),t&&(t.push(z),t.push(oe.data.buffer),t.push(oe.indices.buffer));I&&(d.vec3.transformMat4(I.center,I.center,u),x.vectorToVector(I.center,X,I.center,J),I.center[2]-=e.elevationOffset)}return{geometryBuffer:h,componentOffsets:g,featureIds:b,transformedGeometries:R,obb:I}}(e,t)},e}();!function(e){(R||(R={})).ensureDracoDecoder=function(e){return N&&N.DecoderBuffer||e&&!I(e)?o.resolve():(D||(D=m.getDecoderModule().then(function(e){return D=null,N=e})),D.then(function(){}))}}();var D,N,j=l.mat4f64.create(),V=h.vec3f64.create(),G=h.vec3f64.create(),B=u.quatf32.create();return R}.apply(null,n))||(e.exports=a)},2228:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(9),r(11),r(7),r(285),r(10),r(354),r(55),r(480),r(2184),r(38),r(22)],void 0===(a=function(e,t,n,a,i,o,s,l,c,u,d,h,f){function p(e,t,r,n,a,i,o){switch(r){case 1:for(var s=0;s<o;s++)n[a]=e[t],t+=1,a+=i;break;case 2:for(s=0;s<o;s++)n[a]=e[t],n[a+1]=e[t+1],t+=2,a+=i;break;case 3:for(s=0;s<o;s++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],t+=3,a+=i;break;case 4:for(s=0;s<o;s++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],n[a+3]=e[t+3],t+=4,a+=i;break;default:throw _("Unhandled stride size "+r)}}function m(e,t,r,n,a,i){switch(t){case 1:for(var o=0;o<i;o++)r[n]=e,n+=a;break;case 2:for(o=0;o<i;o++)r[n]=e,r[n+1]=e,n+=a;break;case 3:for(o=0;o<i;o++)r[n]=e,r[n+1]=e,r[n+2]=e,n+=a;break;case 4:for(o=0;o<i;o++)r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,n+=a;break;default:throw _("Unhandled stride size "+t)}}function g(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function y(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function v(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function b(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function _(e){return new Error("I3SGeometryUtil processing failed: "+e)}function x(e){var t=e.normals,r=e.positions,n=e.normalInd,a=e.positionInd;f.assert(e.normalInd.length===e.positionInd.length);for(var i=l.vec3f32.create(),c=l.vec3f32.create(),u=o.vec2f32.create(),d=r.data,h=r.offsetIdx,p=r.strideIdx,m=t.data,g=t.offsetIdx,y=t.strideIdx,v=0;v<a.length;v+=3){var b=a[v],_=h+p*b,x=d[_],C=d[_+1],w=d[_+2];_=h+p*(b=a[v+1]),i[0]=d[_]-x,i[1]=d[_+1]-C,i[2]=d[_+2]-w,_=h+p*(b=a[v+2]),c[0]=d[_]-x,c[1]=d[_+1]-C,c[2]=d[_+2]-w,s.vec3.cross(i,i,c),f.encodeNormal(i,u);for(var I=0;I<3;I++){var S=g+y*n[v+I];m[S]=f.encodeInt16(u[0]),m[S+1]=f.encodeInt16(u[1])}}}function C(){return!!M}function w(e,t){switch(t){case 0:switch(e.type){case"intersects":case"contains":case"crosses":case"envelope-intersects":case"overlaps":case"touches":case"within":return 1;case"disjoint":return 0}break;case 2:switch(e.type){case"intersects":case"contains":case"envelope-intersects":case"within":return 0;case"disjoint":case"crosses":case"overlaps":case"touches":return 1}break;case 1:switch(e.type){case"envelope-intersects":return 0}}return 2}function I(e,t){return M.contains(e.mask,t)?2:M.intersects(e.mask,t)?1:0}Object.defineProperty(t,"__esModule",{value:!0});var S=new Uint8Array(64);t.interleaveGeometryBuffer=function(e,t,r,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var i=e.params.vertexAttributes,o=i.position.count;if(!b(r[0].stride))throw _("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");for(var s=r[0].stride/Uint32Array.BYTES_PER_ELEMENT,l=new Uint32Array(s*o),c=0,u=r=r.slice(0).sort(function(e,t){return e.offset-t.offset});c<u.length;c++)!function(e){if(-1!==a.indexOf(e.name))return"continue";var r=i[e.name],s=g(e.type),c=void 0,u=!1;if(null==r){var d=n.filter(function(t){return t.name===e.name})[0];if(!d)throw _("Geometry definition is missing attribute");r={valueType:y(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var h=0;h<S.length;h++)S[h]=d.byteValue;c=S.buffer,u=!0}else c=t;if(y(e.type)!==r.valueType)throw _("Geometry definition type must match attribute type");if(!v(r.byteOffset)||!v(e.offset))throw _(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!b(r.valuesPerElement*s.BYTES_PER_ELEMENT)||!b(e.count*s.BYTES_PER_ELEMENT))throw _(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var f=new Uint32Array(c),x=r.byteOffset/Uint32Array.BYTES_PER_ELEMENT,C=r.valuesPerElement*s.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,w=e.offset/Uint32Array.BYTES_PER_ELEMENT,I=e.stride/Uint32Array.BYTES_PER_ELEMENT;u?m(f[0],C,l,w,I,o):p(f,x,C,l,w,I,o)}(u[c]);return l.buffer},t.processAndInterleaveNormals=function(e,t,r,n,a){if("none"===e)x(a);else{var i=d.createTypedView(r,t.params.vertexAttributes.normal),o="earth-centered"===e?n:null;!function(e,t,r){var n=e.length/3,a=t.data,i=t.offsetIdx,o=t.strideIdx;if(null!=r)for(var s=r,l=s[0],c=s[1],u=s[2],d=s[4],h=s[5],p=s[6],m=s[8],g=s[9],y=s[10],v=0;v<n;v++){var b=e[3*v],_=e[3*v+1],x=e[3*v+2];T[0]=l*b+c*_+u*x,T[1]=d*b+h*_+p*x,T[2]=m*b+g*_+y*x,f.encodeNormal(T,P),a[i+v*o]=f.encodeInt16(P[0]),a[i+v*o+1]=f.encodeInt16(P[1])}else for(var v=0;v<n;v++)T[0]=e[3*v],T[1]=e[3*v+1],T[2]=e[3*v+2],f.encodeNormal(T,P),a[i+v*o]=f.encodeInt16(P[0]),a[i+v*o+1]=f.encodeInt16(P[1])}(i,a.normals,o)}},t.computeCompressedNormals=x;var M,O=65536;t.extractPositionData=function(e,t,r){var n=t[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var a=new Float32Array(e),i=n.stride/4,o=n.offset/4,s=3*a.length/i,l=new Float32Array(s),c=0;c<s/3;c++)l[3*c]=a[c*i+o],l[3*c+1]=a[c*i+o+1],l[3*c+2]=a[c*i+o+2];var d=u.default(l.buffer,3,r);return d.uniqueCount<O?{data:new Float32Array(d.buffer),indices:new Uint16Array(d.indices)}:{data:new Float32Array(d.buffer),indices:d.indices}},t.isGeometryEngineLoaded=C,t.loadGeometryEngine=function(){return a(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return C()?[2,M]:[4,i.create(function(e,t){return Promise.resolve().then(function(){var t=[r(241)];e.apply(null,t)}.bind(this)).catch(r.oe)})];case 1:return[2,M=e.sent()]}})})},t.acquireMaskFilterContext=function(e,t,r,n){var a=r.spatialReference||t.spatialReference,i=t.renderSpatialReference,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};o.rings[0][4]=o.rings[0][0];var s=n.objectTransformation,l=n.getGeometryRecords()[0].geometry,c={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};c.rings[0][3]=c.rings[0][0];var u=M[e];return u||(console.error("Spatial relationship",e,"not supported"),u=function(){return!0}),{type:e,mask:r,maskSR:a,renderSR:i,aabb:o,transform:s,geometry:l,triangle:c,testFunction:u}},t.getIntersectRelation=w,t.intersectMaskWithMbs=function(e,t){var r={x:t[0],y:t[1],hasZ:!1,hasM:!1,type:"point",spatialReference:e.maskSR};return I(e,M.buffer(r,t[3],1,!0))};var E=Math.pow(2,-32);t.filterMask=function(e,t){var r=t.type,n=t.mask,a=t.transform,i=t.renderSR,o=t.maskSR,l=t.geometry,c=t.triangle,u=t.testFunction,d=t.aabb;l.getComponentAABB(e,A);var p=[d.rings[0][0],d.rings[0][1],d.rings[0][2],d.rings[0][3]];s.vec3.set(p[0],A[0],A[1],0),s.vec3.set(p[1],A[0],A[4],0),s.vec3.set(p[2],A[3],A[4],0),s.vec3.set(p[3],A[3],A[1],0);for(var m=0;m<4;++m)s.vec3.transformMat4(p[m],p[m],a),h.vectorToVector(p[m],i,p[m],o);switch(delete d._geVersion,w(t,I(t,d))){case 1:return!1;case 0:return!0}var g,y=c.rings[0][0],v=c.rings[0][1],b=c.rings[0][2],_=l.data.getIndices(f.VertexAttrConstants.POSITION),x=l.data.componentOffsets,C=l.data.getAttribute(f.VertexAttrConstants.POSITION),S=C.data,M=C.offsetIdx,O=C.strideIdx,T=x.length?x[e]:0,P=x.length?x[e+1]:_.length;switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":g=function(){return u(n,c)?0:2};break;case"contains":case"disjoint":case"within":default:g=function(){return u(n,c)?2:1}}for(m=T;m<P;m+=3){var R=M+O*_[m+0],D=M+O*_[m+1],N=M+O*_[m+2];s.vec3.set(y,S[R+0],S[R+1],S[R+2]),s.vec3.set(v,S[D+0],S[D+1],S[D+2]),s.vec3.set(b,S[N+0],S[N+1],S[N+2]),s.vec3.transformMat4(y,y,a),s.vec3.transformMat4(v,v,a),s.vec3.transformMat4(b,b,a),h.vectorToVector(y,i,y,o),h.vectorToVector(v,i,v,o),h.vectorToVector(b,i,b,o);var j=v[0]-y[0],V=v[1]-y[1],G=b[0]-y[0],B=b[1]-y[1];if(!(Math.abs(j*B-V*G)<E))switch(delete c._geVersion,g()){case 1:return!1;case 0:return!0}}switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":return!1;case"contains":case"disjoint":case"within":default:return!0}};var A=c.create(),T=l.vec3f32.create(),P=o.vec2f32.create()}.apply(null,n))||(e.exports=a)},2229:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(21),r(10),r(6),r(64),r(38),r(370)],void 0===(a=function(e,t,r,n,a,i,o,s){function l(e,t,r){var n,o,s,l=a.vec3f64.create(),c=e[3],u=Math.ceil(Math.log(c)*Math.LOG2E/f),d=Math.pow(2,u*f+h);if(r.isGeographic){var p=d/i.earthRadius*180/Math.PI;o=Math.round(e[1]/p);var m=Math.max(-90,Math.min(90,o*p)),g=p/Math.cos((Math.abs(m)-p/2)/180*Math.PI),y=(n=Math.round(e[0]/g))*g;l[0]=y,l[1]=m}else n=Math.round(e[0]/d),o=Math.round(e[1]/d),l[0]=n*d,l[1]=o*d;var v=e[2]+t;return s=Math.round(v/d),l[2]=s*d,{center:l,id:u+"_"+n+"_"+o+"_"+s}}Object.defineProperty(t,"__esModule",{value:!0});var c=1e3,u=new Float64Array(3*c),d=a.vec3f64.create();t.computeGlobalTransformation=function(e,t,n,a){var i=l(e,t,n).center,s=r.mat4f64.create();return o.computeLinearTransformation(n,i,s,a),s},t.reprojectPoints=function(e,t,r,a,i,s,l){var h=e.data,f=e.offsetIdx,p=e.strideIdx;n.vec3.copy(d,t),d[2]+=a;var m=[0,0,0],g=h.length/p;o.vectorToVector(d,i,m,s);for(var y=0;y<g;y+=c){for(var v=Math.min(c,g-y),b=0;b<v;b++){var _=f+p*(y+b);u[3*b+0]=h[_+0]+m[0],u[3*b+1]=h[_+1]+m[1],u[3*b+2]=h[_+2]+m[2]}for(o.bufferToBuffer(u,s,0,u,l,0,v),b=0;b<v;b++){var x=u[3*b+0],C=u[3*b+1],w=u[3*b+2],I=f+p*(y+b);h[I+0]=r[0]*x+r[4]*C+r[8]*w+r[12],h[I+1]=r[1]*x+r[5]*C+r[9]*w+r[13],h[I+2]=r[2]*x+r[6]*C+r[10]*w+r[14]}}},t.createOrigin=function(e,t,r,n){var a=l(e,t,r),i=a.center,c=a.id;return o.vectorToVector(i,r,i,n),s.fromVector(i,c)};var h=1,f=5-h}.apply(null,n))||(e.exports=a)},2264:function(e,t,r){var n,a;n=[r.dj.c(e.i),t],void 0===(a=function(e,t){return function(){function e(){this.items=[]}return e.prototype.addObject=function(e,t){this.items.push({type:"object",highlightId:t,object:e})},e.prototype.addRenderGeometry=function(e,t,r){this.items.push({type:"renderGeometry",highlightId:t,renderGeometry:e,owner:r})},e.prototype.addExternal=function(e,t){this.items.push({type:"external",highlightId:t,remove:e})},e.prototype.remove=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];r.highlightId===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeObject=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"object"===r.type&&r.object===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeRenderGeometry=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"renderGeometry"===r.type&&r.renderGeometry===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeAll=function(){var e=this;this.items.forEach(function(t){e.removeHighlight(t)}),this.items=[]},e.prototype.removeHighlight=function(e){switch(e.type){case"object":e.object.removeHighlights(e.highlightId);break;case"renderGeometry":e.owner.removeRenderGeometryHighlight(e.renderGeometry,e.highlightId);break;case"external":e.remove(e.highlightId)}},e}()}.apply(null,n))||(e.exports=a)},2272:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(4),r(1),r(0),r(9),r(11),r(33),r(62),r(47),r(31),r(50),r(353),r(26),r(296),r(13),r(37),r(14),r(283),r(7),r(182),r(60),r(123),r(152),r(59),r(29),r(164),r(2),r(21),r(10),r(6),r(55),r(2331),r(495),r(358),r(168),r(497),r(2123),r(105),r(2511),r(2512),r(2229),r(2182),r(2513),r(2238),r(539),r(2180),r(859),r(19),r(2195),r(38),r(137),r(106),r(85),r(244),r(119),r(828),r(184),r(22),r(855),r(2514),r.dj.m(e)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u,d,h,f,p,m,g,y,v,b,_,x,C,w,I,S,M,O,E,A,T,P,R,D,N,j,V,G,B,U,L,F,k,z,H,q,W,Y,J,K,X,Z,Q,$,ee,te,re,ne,ae,ie,oe,se){function le(e){return y.isSome(e)&&w.isArrayBuffer(e.data)}function ce(e,t){for(var r=1024,n=0,a=e;n<a.length;n++){var i=a[n];r+=i.interleavedVertexData.byteLength+(i.indices?i.indices.byteLength:0),r+=i.positionData.data.byteLength+i.positionData.indices.byteLength}if(y.isSome(t))for(var o=0,s=t;o<s.length;o++){var l=s[o];y.isSome(l)&&w.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function ue(e,t){return t.byteSize>ge?(he.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}Object.defineProperty(t,"__esModule",{value:!0});var de=Q.ModelContentType,he=m.getLogger("esri.views.3d.layers.SceneLayerView3D"),fe=[1,1,1,1],pe=[.8,.8,.8],me=function(){return function(){}}(),ge=104857600,ye=function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._layerUid="",e._highlights=new U(e),e._elevationProvider=null,e._worker=new G,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new z.IDBCache("esri-scenelayer-cache","geometries"),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._layerUrl="",e._cacheKeySuffix=null,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return n(s,t),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererNeedsTextures",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=I.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=V.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!f("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(M.open(_.getAbsMid("./SceneLayerWorker",e,se)).then(function(e){t.destroyed?e.close():t._workerThread=e}),k.checkSceneLayerValid(this.layer),k.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUid=this.layer.uid,this._layerUrl=this.layer.parsedUrl.path,this._controller=new R({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new L({layerView:this,stageLayer:this._stageLayer}),this.handles.add([S.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),S.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),S.watch(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),S.watch(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),S.init(this,"filter",function(){return t._filterChange()}),S.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){t._reloadAll(),t._memCache.clear()}),S.init(this,"suspended",function(e){return t._suspendedChange(e)})],"sceneLayerHandles"),this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(function(e){return he.warn("Failed to initialize IndexedDB cache: "+e)}),this._componentColorManager=this._hasSymbolColors?new ie.BufferManager(this._stage.renderView.renderingContext):null},s.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},s.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},s.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},s.prototype.ignoresMemoryFactor=function(){return!1},s.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)},s.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},s.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;var n=""+this.layer.uid,a=new ee(n,{},n);this._stageLayer=a,e.add(de.LAYER,a),this._stage.addToViewContent([a.id])},s.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;this._removeAllNodeDataFromStage(),ae.verify(0===this._nodeId2Meta.size),e.remove(de.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},s.prototype.setAttributeData=function(e,t){var r=this._nodeId2Meta.get(e);r&&(r.attributeInfo=t,r.cachedRendererVersion=this._getInvalidRendererVersion(),r.filteredIds=null,this._updateEngineObject(r))},s.prototype.getLoadedNodeIds=function(){var e=[];return this._nodeId2Meta.forEach(function(t){return e.push(t.node.id)}),e.sort()},s.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach(function(t,r){return e.push(r)})},s.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){if(this._isIntegratedMesh)return{forceTransparency:!1};var n=this.fullOpacity,a=1-g.clamp(ae.fallbackIfUndefined(t.transparency,0),0,1);return{baseColorOpacity:a,layerOpacity:n,forceTransparency:!!(a<1||n<1||e&&C.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r)}},s.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},s.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},s.prototype._getMaterialParameters=function(e,t,n){var a=t.params,i=ae.fallbackIfUndefined(a.diffuse,pe);"standard"!==t.type&&he.warn("Unknown material type '"+t.type+"', must be 'standard'");var o=this._isIntegratedMesh,s=this._calcEngineMaterialTransparencyParams(e,a);return r({baseColor:i,baseColorTexture:n,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(a),cullFace:this._calcEngineMaterialCullFaceParams(a),writeStencil:o,receiveSSAO:!o,normals:o?"ground":"vertex"},s)},s.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture,textureCoordinateRegions:e.hasTexture&&e.hasRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":e.hasNormals?"compressed":"screen-space"}},s.prototype._createTexture=function(e,t,r,n,a){if(null==t||y.isNone(n))return null;var i=function(e,t){for(var r=0,n=e;r<n.length;r++){var a=n[r];if(y.isSome(a)&&a.i3sTexId===t)return a}return null}(n,r),o=i.data,s=i.encoding;if(null==o)return null;var l,c="none"!==t.wrap[0]||"none"!==t.wrap[1],u="rgba"===t.channels,d=!0;if(s===k.DDS_ENCODING_STRING)l=ne.DDS_ENCODING;else{var h=o;d=J.isPowerOfTwo(h.width)&&J.isPowerOfTwo(h.height)}var f=a||!0===t.atlas,p=(f?this._enableAtlasMipMaps:this._enableMipMaps)&&d,m=f||!c,g=f&&p&&this._disableAtlasAnisotropy,v=new ne(o,r,{mipmap:p,wrap:m?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:g,encoding:l,noUnpackFlip:!0,components:u?4:3});return this._stage.add(de.TEXTURE,v),e.memory+=this.memEstimateTextureAdded(v),v},s.prototype._getVertexBufferLayout=function(e,t,r){var n=e.params.textureID||"none",a={hasTexture:"none"!==n&&null!=t.textureDefinitions[n],hasNormals:null!=r.vertexAttributes.normal,hasRegions:null!=r.vertexAttributes.region};return Z.glLayout(oe.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(a)))},s.prototype._createEngineMaterial=function(e,t,r,n,a){var i=t.params.materialID,o=r.materialDefinitions[i];ae.assert(void 0!==o,"geometry wants unknown material "+i);var s,l=t.params.textureID||"none";"none"!==l&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[l]||he.warn("textureDefinitions missing in shared resource"),s=r.textureDefinitions[l]);var c=o.params.vertexRegions,u=null!=s?this._createTexture(e,s,l,n,c):null,d=this._getMaterialParameters(s,o,u&&u.id),h=this._getGeometryParameters({hasTexture:null!=s,hasRegions:a.some(function(e){return"region"===e.name}),hasNormals:a.some(function(e){return"normal"===e.name||"normalCompressed"===e.name})}),f=oe.ComponentMaterial.create(d,h,i);return f.metadata={i3sTex:s,i3sMatParams:o.params,engineTex:u},f},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=H.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return p.everyMap(this._nodeId2Meta,function(e,n){var a=e.featureIds.indexOf(t);return-1===a||(r={node:e.node,index:a},!1)}),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(!r)return[];for(var n=[],a=this._getObjectIdField(),i=0,o=t;i<o.length;i++){var s=o[i],l=H.attributeLookup(s.attributes,a),c=r.featureIds.indexOf(l);-1!==c&&n.push(c)}return n},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return b.reject();var r=this._nodeId2Meta.get(t.node.index).engineObject,n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(X.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var a=P.empty();return P.expandWithBuffer(a,n,0,8),b.resolve({boundingBox:a,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this;return k.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,function(e){for(var t=new Map,n=[],a=0,i=e;a<i.length;a++){var o=i[a],s=r._findGraphicNodeAndIndex(o),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},n.push(l)),l.indices.push(s.index),l.graphics.push(o)}return n},{ignoreUnavailableFields:!0,populateObjectId:!0})},s.prototype.getGraphicFromStageObject=function(e,t){if(this._isIntegratedMesh)return null;var r=this._getMetadata(e),n=e.getComponentFromTriangleNr(0,t);return null!=n&&null!=r.featureIds&&n<r.featureIds.length?this._createGraphic(n,r):null},s.prototype.hasStageObject=function(e){var t=e.getMetadata(),r=this._nodeId2Meta.get(t.nodeIndex);return r&&r.engineObject===e},s.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.nodeIndex)},s.prototype._getCacheKey=function(e){return this._layerUrl+"/v2/"+e.id+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=k.addWraparound(this._cancelCount,1)},s.prototype._handleCancelled=function(e){if(k.addWraparound(this._cancelCount,-e)>0)throw b.createAbortError()},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},s.prototype.loadCachedNodeData=function(e,t){var r=this,n=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(a){return null==a?null:(r._handleCancelled(n),a.nodeVersion!==e.version?(r._idbCache.remove(r._getCacheKey(e)),null):(e.obb||(e.obb=K.clone(a.nodeObb),r._controller.updateVisibility(e.index)),r.rendererNeedsTextures&&function(e,t){for(var n=0;n<e.length;n++){if(y.isNone(t))return!0;var a=k.selectEncoding(e[n].encodings,r.useCompressedTextures),i=t[n];if(y.isNone(i)||null==i.data||a&&i.encoding!==a.encoding)return!0}return!1}(a.requiredTextures,a.textureData)?t(a.requiredTextures).then(function(t){return a.textureData=t,a.byteSize=ce(a.transformedGeometries,a.textureData),t.every(le)&&ue(e,a)&&r._idbCache.initialized&&r._idbCache.put(r._getCacheKey(e),a).catch(function(t){return he.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(n),a}):a))}):b.resolve(null)},s.prototype.addNodeData=function(e,t){var n=this;return 0===t.allGeometryData.length||0===t.allGeometryData[0].geometries.length?b.resolve():(1!==t.allGeometryData.length&&console.warn("Node with",t.allGeometryData.length,"geometries is unsupported"),this._addData(e,t.attributeDataInfo,function(){return n._transformNode(e,t).then(function(t){return n._controller.reschedule(e.index,t)}).then(function(a){e.obb||(e.obb=a.obb,n._controller.updateVisibility(e.index)),t.allGeometryData[0].componentOffsets=a.componentOffsets,a.featureIds&&(t.allGeometryData[0].featureIds=Array.prototype.slice.call(a.featureIds));var i={geometryData:t.allGeometryData[0],transformedGeometries:a.transformedGeometries,requiredTextures:t.requiredTextures,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:n._cachingEnabled()?ce(a.transformedGeometries,t.textureData):0};if(ue(e,i)&&n._idbCache.initialized){var o=y.isSome(i.textureData)?i.textureData.map(function(e){return le(e)?e:null}):null;n._idbCache.put(n._getCacheKey(e),r({},i,{textureData:o})).catch(function(t){return he.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return n._addCachedNodeData(e,i)})}))},s.prototype._transformNode=function(e,t){for(var r=this,n=t.allGeometryData[0].geometries,a=new Array(n.length),i=0;i<n.length;++i)a[i]=this._getVertexBufferLayout(n[i],t.sharedResource,t.geometryIndex);var o={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData[0],geometryIndex:t.geometryIndex,layouts:a,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",o,{transferList:[t.geometryBuffer]}):G.ensureDracoDecoder(o).then(function(){return r._controller.reschedule(e.index,o).then(function(e){return r._worker.transform(e)})})},s.prototype.addCachedGPUData=function(e,t,r){if(this._controller.isGeometryVisible(e)){this._nodeId2Meta.set(e.index,t),this.updateNodeStatus(e.index,r),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1);for(var n=0,a=t.engineObject.getGeometryRecords();n<a.length;n++)a[n].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled});this._updateEngineObject(t),this._highlights.objectCreated(t.engineObject)}else{var i=this._controller.indexDepth-e.level+1;this._memCache.put(this._getMemCacheKey(e.index),t,e.memory,i)}},s.prototype.addCachedNodeData=function(e,t,r){var n=this;return this._addData(e,r,function(){return n._addCachedNodeData(e,t)})},s.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return b.resolve();var n=t.geometryData,a=t.transformedGeometries,i=t.sharedResource,o=this.rendererNeedsTextures?t.textureData:null,s={};s[de.OBJECT]={},s[de.GEOMETRY]={},s[de.MATERIAL]={};var l=0,c=!1;e.memory=0;var u=n.componentOffsets,d=n.geometries,h=n.featureIds,f=null,p=null;if(this._hasSymbolColors){f=this._componentColorManager.getBuffer(h.length),p=new Uint16Array(h.length);for(var m=0;m<h.length;m++)p[m]=f.acquireIndex()}for(var g,y=e.id+"|"+h[0],v=new Array,_=new Array,x=new Array,C=new Array,w=this.view,I=0,S=d;I<S.length;I++){var M=S[I],O=a[l++],A=this._createEngineMaterial(e,M,i,o,O.layout);g=O.corMatrices.globalTrafo,c=c||O.hasColors;var T=new re(new Float32Array(O.interleavedVertexData),O.layout,O.positionData,u||re.DefaultOffsets,O.indices||re.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(T,p);var P=null!=M.transformation?E.mat4f64.clone(M.transformation):ve,R=v.length,D=new $(T,y+(R>0?"_"+R:"")),N=w.renderSpatialReference;v.push(D),x.push(P),C.push(A);var j=F.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,N);_.push(j),e.memory+=this.memEstimateGeometryAdded(D.data),s[de.MATERIAL][A.id]=A,s[de.GEOMETRY][D.id]=D}var V={nodeIndex:e.index,layerUid:this._layerUid},G=new te({idHint:e.id,name:y,geometries:v,materials:C,transformations:x,origins:_,castShadow:!0,metadata:V});G.objectTransformation=g,s[de.OBJECT][G.id]=G;var B=this._addTasks.get(e.index),U=new me;U.node=e,U.engineObject=G,U.featureIds=h,U.componentColorBuffer=f,U.componentIndices=p,U.cachedRendererVersion=this._getInvalidRendererVersion(),U.cachedSymbolInfos=[],U.attributeInfo=B.attributeInfo,!this._hasTextures&&e.resources.texture&&(this._hasTextures=!0),this._hasColors||(this._hasColors=c),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors");var L=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(U).then(function(){var t=r._stageLayer,n=r._stage,a=s[de.OBJECT];for(var i in a)a.hasOwnProperty(i)&&t.addObject(a[i]);for(var o in s)if(s.hasOwnProperty(o)){var l=s[o];for(var c in l)l.hasOwnProperty(c)&&null==n.get(o,c)&&n.add(o,l[c])}if(r._nodeId2Meta.set(e.index,U),r.suspended)r._removeNodeStageData(e.index);else{U.attributeInfo=B.attributeInfo,U.cachedRendererVersion===r._rendererVersion&&L===r.slicePlaneEnabled||r._addOrUpdateEdgeRendering(U),r._setObjectSymbology(U),r._applyFiltersToNode(U)&&r._updateEdgeRendering(U),r.visibleGeometryChanged(G),r._highlights.objectCreated(G);for(var u=0,d=U.engineObject.getGeometryRecords();u<d.length;u++)d[u].material.updateParameters({slicePlaneEnabled:r.slicePlaneEnabled});r._markParentsAsHole(e.index)}})},s.prototype._addData=function(e,t,n){var a=this,i=this._addTasks.get(e.index);return i?i.attributeInfo=t:(i=r({},b.createResolver(),{attributeInfo:t}),this._addTasks.set(e.index,i),n().then(i.resolve,i.reject).then(function(){return a._addTasks.delete(e.index)}).catch(function(t){throw a._addTasks.delete(e.index),t})),i.promise},s.prototype._markParentsAsHole=function(e){if(this._isIntegratedMesh)for(var t=this._controller,r=t.getParentIndex(e);r;r=t.getParentIndex(r))this.updateNodeStatus(r,"hole")},s.prototype._clippingAreaChanged=function(){var e=P.create();X.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){this._applyFilters(!1)},s.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e.engineObject))})},s.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},s.prototype.addSqlFilter=function(e,t,r,n){var a=this;t&&r&&e.push(function(e,i){return a._sqlFilter(e,i,t,r,n)})},s.prototype._sqlFilter=function(e,t,r,n,a){var i={},o=this._createLayerGraphic(i),s=this.layer.objectIdField,l=t.featureIds,c=t.attributeInfo.attributeData;n.every(function(e){return null!=c[e]||e===s})&&k.filterInPlace(e,l,function(e){i[s]=l[e];for(var t=0,u=n;t<u.length;t++){var d=u[t];d!==s&&(i[d]=k.getCachedAttributeValue(c[d],e))}try{return r.testFeature(o)}catch(e){return a(e),!1}})},s.prototype._boundingboxNodeTest=function(e,t){return X.mbsToMbs(e.node.mbs,this._controller.crsIndex,Ie,this.view.renderSpatialReference),k.intersectBoundingBoxWithMbs(t,Ie)},s.prototype._boundingboxFeatureTest=function(e,t,r){var n=e.engineObject.geometryRecords[0].geometry;return P.intersects(r,n.getComponentAABB(t,xe))},s.prototype._boundingboxFilter=function(e,t,r){var n=this,a=this._boundingboxNodeTest(t,r);if(3!==a){if(0===a)return void(e.length=0);if(t.engineObject.geometryRecords[0].geometry.componentCount===t.featureIds.length){var i=k.getClipAABB(r,t.engineObject);k.filterInPlace(e,t.featureIds,function(e){return n._boundingboxFeatureTest(t,e,i)})}}},s.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return b.resolve();var r=e.engineObject,n=this._edgeView.hasObject(r),a=this._extractObjectEdgeMaterials(e),i=a.hasEdges,o=a.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};if(i){var l=!r.isHidden(r.geometryRecords[0]);if(n)this._edgeView.updateAllComponentMaterials(r,o,s,t),this._edgeView.updateObjectVisibility(r,l);else if(l)return c.safeCast(this._edgeView.addObject(r,o,s,!1))}else n&&this._edgeView.removeObject(r);return b.resolve()},s.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._edgeView.removeObject(e.engineObject)},s.prototype._applyFiltersToNode=function(e){var t=e.engineObject,r=t.areAllComponentsVisible();if(t.unhideAllComponents(),0===this._filters.length)return!r;var n=e.featureIds;null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters);var a=e.filteredIds;if(a===n)return!r;for(var i=t.getGeometryRecords()[0],o=0,s=0;s<n.length;s++){var l=n[s];o>=a.length||a[o]!==l?t.setComponentVisibility(i,s,!1):o++}return!0},s.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,n=this._filters;r<n.length;r++)(0,n[r])(t,e);return t.length===e.featureIds.length?e.featureIds:t},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,n){return t._removeNodeStageData(n,e)})},s.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop();this._removeNodeStageData(r),t.madeProgress()}},s.prototype._removeNodeStageData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._nodeId2Meta.get(e);if(r){var n=r.engineObject;n.setHidden(n.geometryRecords[0],!0),this.visibleGeometryChanged(n),this._removeEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(n);var a=this._controller.indexDepth-r.node.level+1;this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory,a)}},s.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,n=e.engineObject;this._edgeView&&this._edgeView.removeObject(n),r.removeObject(n);for(var a=0,i=n.getGeometryRecords();a<i.length;a++){var o=i[a];this.memEstimateGeometryRemoved(o.geometry.data),t.remove(de.GEOMETRY,o.geometry.id),this._removeMaterial(o.material,t)}if(e.componentIndices){for(var s=0;s<e.componentIndices.length;s++)e.componentColorBuffer.releaseIndex(e.componentIndices[s]);this._componentColorManager.garbageCollect()}t.remove(de.OBJECT,n.id)},s.prototype._removeMaterial=function(e,t){t.remove(de.MATERIAL,e.id);var r=e.metadata.engineTex;r&&(this.memEstimateTextureRemoved(r),t.remove(de.TEXTURE,r.id))},s.prototype.updateNodeStatus=function(e,t){var r=this._nodeId2Meta.get(e);if(r)for(var n="hole"===t,a=0,i=r.engineObject.getGeometryRecords();a<i.length;a++){i[a].material.updateParameters({polygonOffsetEnabled:n})}},s.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){return o(this,void 0,void 0,function(){var t,r,n,a,o,s,l,c;return i(this,function(i){switch(i.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererNeedsTextures"),this._rendererVersion=k.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e?(t=this,r=k.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[i.sent(),this.layer.fields]),i.label=2;case 2:if(e&&"visualVariables"in e&&e.visualVariables)for(n=0,a=e.visualVariables;n<a.length;n++)"color"===(o=a[n]).type?this._colorVariable=o:"opacity"===o.type?this._opacityVariable=o:he.warn("Unsupported visual variable type for 3D Object Scene Services: "+o.type);if(e)for(s=0,l=e.getSymbols();s<l.length;s++)"mesh-3d"!==(c=l[s]).type&&he.error("Symbols of type '"+c.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},s.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},s.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},n=this._tmpAttributeOnlyGraphic;n.attributes=r;var a=this._currentRenderer,i=e.attributeInfo.attributeData,o=null!=e.featureIds?this.layer.objectIdField:null,s=null!=i?this._rendererFields:null;null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));for(var l=e.cachedSymbolColors,c=!0,u=0;u<t;u++){if(null!=o&&(r[o]=e.featureIds[u]),null!=s)for(var d=0,h=s;d<h.length;d++){var f=h[d];i[f]&&(r[f]=k.getCachedAttributeValue(i[f],u))}var p=a&&a.getSymbol(n,{arcadeUtils:N}),m=null;p instanceof j&&(this._symbolInfos.has(p.id)||this._symbolInfos.set(p.id,k.getSymbolInfo(p)),m=this._symbolInfos.get(p.id)),e.cachedSymbolInfos[u]=m;var g=null,y=null,v=!0,b=!0;if(a&&"visualVariables"in a){if(this._colorVariable){var _=D.getColor(this._colorVariable,n,{color:we});_&&((g=Ce)[0]=_.r/255,g[1]=_.g/255,g[2]=_.b/255,this._opacityVariable||null===_.a||(y=_.a))}this._opacityVariable&&(y=D.getOpacity(this._opacityVariable,n))}if(m&&m.material){var x=m.material;g=null==g||null==y?B.overrideColor(g,y,x.color,x.alpha,fe,Ce):B.overrideColor(g,y,null,null,fe,Ce),Y.encodeSymbolColor(g,x.colorMixMode,l,4*u),v=m.castShadows}else Y.encodeSymbolColor(null,null,l,4*u),v=!0;if(u>0&&c){for(var C=4*(u-1);C<4*u;C++)l[C]!==l[C+4]&&(c=!1);v!==b&&(c=!1)}b=v}e.uniformSymbolColor=c}},s.prototype._extractObjectEdgeMaterials=function(e){for(var t=[],r=e.engineObject,n=e.featureIds?e.featureIds.length:1,a={opacity:this.fullOpacity},i=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),o=!1,s=null,l=null,c=this._getSymbolInfos(e),u=0;u<n;u++){var d=c[u];r.getComponentVisibility(r.getGeometryRecords()[0],u)&&d?(l!==d&&(l=d,(s=q.createMaterialFromEdges(this._edgeView,d.edges,a))&&(o=!0)),t.push(y.isSome(s)?s:i)):t.push(i)}return{hasEdges:o,perFeatureEdgeMaterials:t}},s.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r=this._getSymbolColors(e);if(e.uniformSymbolColor){var n=Y.decodeSymbolColor(r,0),a=n.color,i=n.colorMixMode,o=!0;e.cachedSymbolInfos[0]&&(o=e.cachedSymbolInfos[0].castShadows);for(var s=0,l=e.engineObject.getGeometryRecords();s<l.length;s++){l[s].material.updateParameters({componentData:{castShadows:o,externalColor:a,externalColorMixMode:i}})}var c=a[3]<1;this._updateObjectOpacity(e.engineObject,c)}else{for(var u=e.componentColorBuffer.textureBuffer,d=!0,h=0;h<t;h++){var f=4*h,p=e.componentIndices[h],m=1;e.cachedSymbolInfos[h]&&(m=!0===e.cachedSymbolInfos[h].castShadows?1:0),u.setData(p,0,r[f],r[f+1],254&r[f+2]|m,r[f+3]),d=d&&Y.isOpaqueSymbolColor(r,f)}for(var g=0,y=e.engineObject.getGeometryRecords();g<y.length;g++){y[g].material.updateParameters({componentData:u})}this._updateObjectOpacity(e.engineObject,!d),this._stage.renderView.setNeedsRender()}}},s.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute(ae.VertexAttrConstants.COMPONENTINDEX),n=r.data,a=r.offsetIdx,i=r.strideIdx,o=e.getIndices(ae.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],c=e.componentOffsets[s+1],u=l;u<c;u++){n[a+o[u]*i]=t[s]}},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},s.prototype._updateObjectOpacity=function(e,t){for(var r=0,n=e.getGeometryRecords();r<n.length;r++){var a=n[r].material,i=a.metadata;void 0!==t&&(i.symbolIsTransparent=t);var o=this._calcEngineMaterialTransparencyParams(i.i3sTex,i.i3sMatParams,i.symbolIsTransparent);a.updateParameters(o)}},s.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e.engineObject)},s.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._stageLayer.isSliceable=e,this._nodeId2Meta.forEach(function(e){for(var n=0,a=e.engineObject.getGeometryRecords();n<a.length;n++)a[n].material.updateParameters(r);t._updateEdgeRendering(e,!1)})},s.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e,t)},s.prototype._forAllFeatures=function(e,t,r){var n=this;void 0===r&&(r=0),p.everyMap(this._nodeId2Meta,function(a,i){if(y.isSome(t))switch(t(a)){case 0:return!1;case 2:return!0}return 0!==n._forAllFeaturesOfNode(a,e,r)})},s.prototype._forAllFeaturesOfNode=function(e,t,r){void 0===r&&(r=0);var n=e.featureIds,a=e.engineObject.geometryRecords[0],i=2===r&&this._clippingArea?k.getClipAABB(this._clippingArea,e.engineObject):null,o=i?this._boundingboxNodeTest(e,this._clippingArea):3;if(0===o)return 1;for(var s=0;s<n.length;s++)if(e.engineObject.getComponentVisibility(a,s)||1===r||2===r&&(3===o||this._boundingboxFeatureTest(e,s,i))){var l=t(n[s],s,e,a);switch(l){case 0:return l}}return 1},s.prototype._createGraphic=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var n=t.attributeInfo.attributeData;if(null!=n)for(var a=0,i=Object.keys(n);a<i.length;a++){var o=i[a];r[o]=k.getCachedAttributeValue(n[o],e)}return this._createLayerGraphic(r)},s.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,_e),a=0;a<8;++a)be[0]=1&a?n[0]:n[3],be[1]=2&a?n[1]:n[4],be[2]=4&a?n[2]:n[5],A.vec3.transformMat4(be,be,t.objectTransformation),r[3*a]=be[0],r[3*a+1]=be[1],r[3*a+2]=be[2];return r},s.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var n=this._highlights;if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var a=e.map(function(e){return H.attributeLookup(e.attributes,r._getObjectIdField())}),i=n.acquireSet(t),o=i.set,s=i.handle;return n.setFeatureIds(o,a),s}if("number"==typeof e[0]){a=e;var c=n.acquireSet(t);o=c.set,s=c.handle;return n.setFeatureIds(o,a),s}}return Se},s.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=x.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},s.prototype.test=function(){var e=this;return{controller:this._controller,get visibleObjectIds(){var t=[];return e._forAllFeatures(function(e,r,n,a){return n.engineObject.isHidden(a)||n.engineObject.areAllComponentsHidden()||!n.engineObject.getComponentVisibility(a,r)||t.push(e),1}),t.sort(function(e,t){return e-t}),t},get numNodes(){return e._nodeId2Meta.size}}},a([O.property()],s.prototype,"view",void 0),a([O.property()],s.prototype,"layer",void 0),a([O.property()],s.prototype,"_controller",void 0),a([O.property({dependsOn:["_controller.updating"]})],s.prototype,"updating",void 0),a([O.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),a([O.property(W.updatingPercentage)],s.prototype,"updatingPercentage",void 0),a([O.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],s.prototype,"updatingPercentageValue",void 0),a([O.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),a([O.property({readOnly:!0})],s.prototype,"rendererNeedsTextures",null),a([O.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),a([O.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),a([O.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),a([O.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),a([O.subclass("esri.views.3d.layers.I3SMeshView3D")],s)}(O.declared(h,d,v));t.I3SMeshView3D=ye;var ve=E.mat4f64.create(),be=T.vec3f64.create(),_e=P.create(),xe=P.create(),Ce=[0,0,0,0],we=new s([0,0,0,0]),Ie=[0,0,0,0],Se={remove:function(){},pause:function(){},resume:function(){}}}.apply(null,n))||(e.exports=a)},2332:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(4),r(856)],void 0===(a=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:!0}),t.isUniformComponentData=function(e){return!(e instanceof n.TextureBackedBuffer)},t.fillDefaults=function(e){return r({baseColor:a,baseColorOpacity:1,baseColorTexture:null,doubleSidedShading:!1,normals:"screen-space",cullFace:"back",componentData:i,receiveSSAO:!0,forceTransparency:null,slicePlaneEnabled:!1,polygonOffsetEnabled:!1,writeStencil:!1,readStencil:!1,layerOpacity:1},e)};var a=[1,1,1],i={externalColor:[1,1,1,1],externalColorMixMode:"multiply",castShadows:!0}}.apply(null,n))||(e.exports=a)},2333:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(80)],void 0===(a=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.createVertexBufferLayout=function(e){var t=r.newLayout().vec3f("position");return"compressed"===e.normals?t.vec2i16("normalCompressed",{glNormalized:!0}):"default"===e.normals&&t.vec3f("normal"),e.textureCoordinates&&t.vec2f("uv0"),e.textureCoordinateRegions&&t.vec4u16("region",{glNormalized:!0}),e.colors&&t.vec4u8("color"),e.componentData&&t.u16("componentIndex"),t.alignTo(4)}}.apply(null,n))||(e.exports=a)},2511:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(2264)],void 0===(a=function(e,t,r){var n=function(){return function(e){this.highlightSet=new r,this.ids=new Set,this.paused=!1,this.options=e}}();return function(){function e(e){this.highlights=[],this.layerView=e}return e.prototype.destroy=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()}),this.highlights=null},e.prototype.acquireSet=function(e){var t=this,r=new n(e);return this.highlights.push(r),{set:r,handle:{remove:function(){return t.releaseSet(r)},pause:function(){r.highlightSet.removeAll(),r.paused=!0},resume:function(){r.paused=!1,t.initializeSet(r)}}}},e.prototype.releaseSet=function(e){e.highlightSet.removeAll();var t=this.highlights?this.highlights.indexOf(e):-1;-1!==t&&this.highlights.splice(t,1)},e.prototype.setFeatureIds=function(e,t){t.forEach(function(t){return e.ids.add(t)}),this.initializeSet(e)},e.prototype.initializeSet=function(e){this.layerView._forAllFeatures(function(t,r,n,a){if(e.ids.has(t)){var i=n.engineObject.setComponentHighlight(a,r,e.options);e.highlightSet.addObject(n.engineObject,i)}return 1},null,1)},e.prototype.objectCreated=function(e){var t=this;this.highlights.forEach(function(r){r.paused||t.layerView._forAllFeaturesOfNode(t.layerView._getMetadata(e),function(t,n,a,i){if(r.ids.has(t)){var o=e.setComponentHighlight(i,n,r.options);r.highlightSet.addObject(e,o)}return 1},1)})},e.prototype.objectDeleted=function(e){this.highlights.forEach(function(t){t.highlightSet.removeObject(e)})},e.prototype.allObjectsDeleted=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()})},e}()}.apply(null,n))||(e.exports=a)},2512:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(1),r(0),r(8),r(50),r(13),r(2),r(10),r(6),r(44),r(91),r(169)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u,d,h){var f=u.empty(),p={spatialReference:null,extent:f},m=c.vec3f64.create(),g=c.vec3f64.create(),y=c.vec3f64.create(),v=o.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(e){function t(t){return e.call(this)||this}return r(t,e),t.prototype.initialize=function(){var e=this.layerView.view;this.view=e,this.renderCoordsHelper=e.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new h(e.viewingMode);var t=this.layerView.layer.fullExtent;this.zmin=t.zmin,this.zmax=t.zmax},t.prototype.getElevation=function(e){if(d.isPoint(e)){if(!this.renderCoordsHelper.toRenderCoords(e,m))return v.error("could not project point for elevation alignment"),-1/0}else if(!this.renderCoordsHelper.toRenderCoords(e,this.spatialReference,m))return v.error("could not project point for elevation alignment"),-1/0;var t=this.layerView.elevationOffset,r=this.zmin+t,n=this.zmax+t;return l.vec3.copy(g,m),l.vec3.copy(y,m),this.renderCoordsHelper.setAltitude(n,g),this.renderCoordsHelper.setAltitude(r,y),this.intersector.intersect(this.intersectLayers,g,y,null,null,1,!1),this.intersector.results.min.getIntersectionPoint(m)?this.renderCoordsHelper.getAltitude(m):-1/0},t.prototype.layerChanged=function(){this.spatialReference&&(p.extent=this.computeLayerExtent(this.intersectLayers[0]),p.spatialReference=this.spatialReference,this.emit("elevation-change",p))},t.prototype.objectChanged=function(e){this.spatialReference&&(p.extent=this.computeObjectExtent(e),p.spatialReference=this.spatialReference,this.emit("elevation-change",p))},t.prototype.computeObjectExtent=function(e){return u.empty(f),this.expandExtent(e,f),f},t.prototype.computeLayerExtent=function(e){u.empty(f);for(var t=0,r=e.getObjects();t<r.length;t++){var n=r[t];this.expandExtent(n,f)}return f},t.prototype.expandExtent=function(e,t){for(var r=e.getBBMin(!0),n=e.getBBMax(!0),a=0;a<8;++a)m[0]=1&a?r[0]:n[0],m[1]=2&a?r[1]:n[1],m[2]=4&a?r[2]:n[2],l.vec3.transformMat4(m,m,e.objectTransformation),this.renderCoordsHelper.fromRenderCoords(m,m,this.spatialReference),u.expand(t,m);return t},n([s.property({constructOnly:!0})],t.prototype,"layerView",void 0),n([s.property({constructOnly:!0})],t.prototype,"stageLayer",void 0),n([s.property()],t.prototype,"view",void 0),n([s.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],t.prototype,"spatialReference",void 0),n([s.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],t)}(s.declared(a,i))}.apply(null,n))||(e.exports=a)},2513:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(15),r(7)],void 0===(a=function(e,t,r,n){function a(e){return n.create(function(t,r){e.oncomplete=function(){return t()},e.onerror=function(){return r(e.error)},e.onabort=function(){return r(e.error)}})}function i(e){return n.create(function(t,r){"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return r(e.error)})})}Object.defineProperty(t,"__esModule",{value:!0});var o=14,s=function(){function e(e,t,r){void 0===r&&(r=o),this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}return e.prototype.init=function(){var e=this;return n.resolve().then(function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(r){var n=t.result,a=t.transaction,i=n.objectStoreNames.contains(e._storeName)?a.objectStore(e._storeName):n.createObjectStore(e._storeName),o=n.objectStoreNames.contains("last_access")?a.objectStore("last_access"):n.createObjectStore("last_access");o.indexNames.contains("date")||o.createIndex("date","date",{unique:!1}),o.indexNames.contains("byteSize")||o.createIndex("byteSize","byteSize",{unique:!1}),r.oldVersion<e._version&&(i.clear(),o.clear())},i(t)}).then(function(t){e._destroyed?t.close():e._db=t})},e.prototype.destroy=function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0},Object.defineProperty(e.prototype,"initialized",{get:function(){return null!=this._db},enumerable:!0,configurable:!0}),e.prototype.getHitRate=function(){return this._hit/(this._hit+this._miss)},e.prototype.put=function(e,t){var a=this;return null==this._db?n.reject(new r("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:n.resolve()).then(function(){return a._put(e,t)}).catch(function(r){if(r&&"QuotaExceededError"===r.name)return null==a._quotaReductionPromise&&(a._quotaReductionPromise=a._getCacheSize().then(function(e){return a._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*a.quotaReductionFactor))}),a._quotaReductionPromise.then(function(){return a._quotaReductionPromise=null},function(){return a._quotaReductionPromise=null})),a._quotaReductionPromise.then(function(){return a._put(e,t)});throw r}).then(function(){--a._gcCounter<0&&null!=a._db&&(a._gcCounter=a.gcFrequency,a._getCacheSize().then(function(e){return a._removeLeastRecentlyAccessed(e-a.maxByteSize)}))})},e.prototype.get=function(e){var t=this;return null==this._db?n.resolve(null):n.resolve().then(function(){return i(t._db.transaction(t._storeName,"readonly").objectStore(t._storeName).get(e))}).then(function(r){if(null==r)++t._miss;else if(t._db){++t._hit,t._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:r.byteSize},e)}return r}).catch(function(e){return++t._miss,null})},e.prototype.remove=function(e){var t=this;return null==this._db?n.resolve():n.resolve().then(function(){var r=t._db.transaction([t._storeName,"last_access"],"readwrite"),o=r.objectStore(t._storeName),s=r.objectStore("last_access"),l=o.delete(e),c=s.delete(e);return n.all([i(l),i(c),a(r)])})},e.prototype._put=function(e,t){var r=this._db.transaction([this._storeName,"last_access"],"readwrite"),o=r.objectStore(this._storeName),s=r.objectStore("last_access"),l=o.put(t,e),c=s.put({date:Date.now(),byteSize:t.byteSize},e);return n.all([i(l),i(c),a(r)])},e.prototype._removeLeastRecentlyAccessed=function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),n=t.objectStore("last_access"),i=0,o=n.index("date").openCursor(null,"next");return o.onsuccess=function(t){var a=o.result;null!=a&&(null!=a.value.byteSize&&(i+=a.value.byteSize),r.delete(a.primaryKey),n.delete(a.primaryKey),i<e&&a.continue())},a(t)}},e.prototype._getCacheSize=function(){var e=this._db.transaction("last_access"),t=0,r=e.objectStore("last_access").index("byteSize").openKeyCursor();return r.onsuccess=function(e){var n=r.result;if(n){var a=n.key;null!=a&&(t+=a),n.continue()}},a(e).then(function(){return t})},e}();t.IDBCache=s,t.whenTransaction=a,t.whenRequest=i}.apply(null,n))||(e.exports=a)},2514:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(2515),r(2333)],void 0===(a=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.create=function(e,t,n){return new r.ComponentMaterial(e,t,n)},e.vertexBufferLayout=n.createVertexBufferLayout}(t.ComponentMaterial||(t.ComponentMaterial={}))}.apply(null,n))||(e.exports=a)},2515:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(12),r(4),r(14),r(140),r(2516),r(2332),r(2333),r(65),r(2518)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u){Object.defineProperty(t,"__esModule",{value:!0});var d=function(e){function t(t,r,n){var a=e.call(this,n)||this;return a.supportsEdges=!0,a._parameters=s.fillDefaults(t),a._geometryParameters=r,a}return r(t,e),Object.defineProperty(t.prototype,"parameters",{get:function(){return this._parameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryParameters",{get:function(){return this._geometryParameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasTransparency",{get:function(){var e=this._parameters.forceTransparency;if(a.isSome(e))return e;if(this._parameters.baseColorOpacity<1||this._parameters.layerOpacity<1)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||"replace"!==t.externalColorMixMode||t.externalColor[3]<1},enumerable:!0,configurable:!0}),t.prototype.isVisibleInPass=function(e){if(3!==e)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||t.castShadows},t.prototype.isVisible=function(){var t=this.parameters;if(!e.prototype.isVisible.call(this))return!1;if(0===t.layerOpacity)return!1;var r=t.componentData;return!s.isUniformComponentData(r)||("replace"===r.externalColorMixMode?r.externalColor[3]>0:t.baseColorOpacity>0)},t.prototype.updateParameters=function(e){var t=!1;for(var r in e){var n=this._parameters[r],a=e[r];n!==a&&(t=!0,this._parameters[r]=a)}return t&&this.notifyDirty("matChanged"),t},t.prototype.intersect=function(e,t,r,n,a,i,o){c.intersectTriangleGeometry(e,t,r,n,a,i,o)},t.prototype.getGLMaterials=function(){return{color:o.GLMaterialColor,depthShadowMap:o.GLMaterialDepthShadowMap,normal:o.GLMaterialNormal,depth:o.GLMaterialDepth,highlight:o.GLMaterialHighlight}},t.prototype.createRenderer=function(e,t){return new u(e,t,this)},t.prototype.createBufferWriter=function(){throw Error("Not supported")},t.prototype.createBufferLayout=function(){return l.createVertexBufferLayout(this.geometryParameters)},t}(i);t.ComponentMaterial=d}.apply(null,n))||(e.exports=a)},2516:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(12),r(0),r(299),r(852),r(156),r(2332),r(65),r(65),r(2517),r(860),r(54)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u,d,h){function f(e){if(function(e){return"none"!==e.parameters.cullFace}(e))return{face:"front"===e.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(t,"__esModule",{value:!0});var p=function(e){function t(t,r,n,a){var o=e.call(this,r,n)||this;o._passName=t,o.material=r;var s=r.parameters;return o._baseColorTexture=new u.TextureBinding(a,s.baseColorTexture,{textureUniform:"tex",textureSizeUniform:"texSize",textureUnit:i.DefaultTextureUnits.DIFFUSE}),o.createPrograms(),o.selectPipeline(),o.selectSlot(),o}return r(t,e),t.prototype.createPrograms=function(){var e=this;this.programs=l.BindParametersMap.create(this.material.parameters,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.material.parameters,r=this.material.geometryParameters,n=t.baseColorTexture?r.textureCoordinateRegions?"AtlasTextured":"Textured":"none",a="screen-space"===t.normals||"screen-space"===r.normals||"none"===r.normals?"screenDerivative":"compressed"===r.normals?"compressed":"default";return"color"===this._passName?this.programRep.getProgram(d.colorPass,{textureMode:n,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,doubleSided:t.doubleSidedShading,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO}):"depth"===this._passName||"depthShadowMap"===this._passName?this.programRep.getProgram(d.depthPass,{textureMode:n,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this._passName,slice:t.slicePlaneEnabled}):"normal"===this._passName?this.programRep.getProgram(d.normalPass,{textureMode:n,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):"highlight"===this._passName?this.programRep.getProgram(d.highlightPass,{textureMode:n,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):void 0},t.prototype.selectPipeline=function(){var e=this.material.parameters;"color"===this._passName?this.pipelineState=h.makePipelineState({blending:function(e){if(e.hasTransparency)return h.separateBlendingParams(770,1,771,771)}(this.material),culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&C,stencilTest:e.writeStencil&&{function:{func:e.readStencil?517:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams}):this.pipelineState=h.makePipelineState({culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&C,depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=this.material.hasTransparency?7:this.material.parameters.readStencil?3:this.material.parameters.writeStencil?2:5},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return l.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){var e=this.material.parameters;this._baseColorTexture.update(e.baseColorTexture),this.createPrograms(),this.selectPipeline(),this.selectSlot()},t.prototype.bind=function(e,t){var r=this.material.parameters,n=this.program=l.BindParametersMap.lookup(this.programs,t);e.bindProgram(n),e.setPipelineState(this.pipelineState),n.setUniform3fv("ambient",r.baseColor),n.setUniform3fv("diffuse",r.baseColor),n.setUniform3fv("specular",x),n.setUniform1f("opacity",r.baseColorOpacity),n.setUniform1f("layerOpacity",r.layerOpacity),s.isUniformComponentData(r.componentData)?(n.setUniform4fv("externalColor",r.componentData.externalColor),n.setUniform1i("colorMixMode",c.colorMixModes[r.componentData.externalColorMixMode])):(n.setUniform4fv("externalColor",_),n.setUniform1i("colorMixMode",c.colorMixModes.multiply),this.material.geometryParameters.componentData&&(r.componentData.updateTexture(),r.componentData.bind(n,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:i.DefaultTextureUnits.COMPONENT_COLOR}))),this._baseColorTexture.bind(e,n),n.setUniform1f("textureAlphaCutoff",.1),"depth"!==this._passName&&"depthShadowMap"!==this._passName||n.setUniform2fv("nearFar",t.nearFar),"highlight"===this._passName&&c.bindHighlightRendering(e,t,n)},t.prototype.bindView=function(e,t){var r=this.material.parameters,n=this.program=l.BindParametersMap.lookup(this.programs,t),a=t.origin;c.bindView(a,t.view,n),c.bindCamPos(a,t.viewInvTransp,n),r.slicePlaneEnabled&&c.bindSlicePlane(a,t.slicePlane,n),"color"===this._passName&&t.shadowMappingEnabled&&t.shadowMap.bindView(n,a),"normal"===this._passName&&n.setUniformMatrix4fv("viewNormal",t.viewInvTransp)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},n([a.autoDispose()],t.prototype,"_baseColorTexture",void 0),t}(o),m=function(e){function t(t,r,n){var a=e.call(this,"color",t,r,n)||this;return a.material=t,a}return r(t,e),t}(p);t.GLMaterialColor=m;var g=function(e){function t(t,r,n){var a=e.call(this,"depth",t,r,n)||this;return a.material=t,a}return r(t,e),t}(p);t.GLMaterialDepth=g;var y=function(e){function t(t,r,n){var a=e.call(this,"depthShadowMap",t,r,n)||this;return a.material=t,a}return r(t,e),t}(p);t.GLMaterialDepthShadowMap=y;var v=function(e){function t(t,r,n){var a=e.call(this,"normal",t,r,n)||this;return a.material=t,a}return r(t,e),t}(p);t.GLMaterialNormal=v;var b=function(e){function t(t,r,n){var a=e.call(this,"highlight",t,r,n)||this;return a.material=t,a}return r(t,e),t}(p);t.GLMaterialHighlight=b;var _=[1,1,1,1],x=[0,0,0],C={factor:2,units:2}}.apply(null,n))||(e.exports=a)},2517:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(14)],void 0===(a=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n){var a=this;this._textureRep=e,this._textureId=t,this._options=n,this._textureRef=r.applySome(this._textureId,function(e){return a._textureRep.acquire(e,!!a._options.initTransparent)})}return e.prototype.dispose=function(){var e=this;this._textureRef=r.applySome(this._textureId,function(t){e._textureRep.release(t)})},e.prototype.bind=function(e,t){if(r.isSome(this._textureRef)&&(t.setUniform1i(this._options.textureUniform,this._options.textureUnit),e.bindTexture(this._textureRef.getGLTexture(),this._options.textureUnit),this._options.textureSizeUniform)){var n=this._textureRef.getGLTexture();t.setUniform2f(this._options.textureSizeUniform,n.descriptor.width,n.descriptor.height)}},e.prototype.update=function(e){var t=this;e!==this._textureId&&(r.applySome(this._textureId,function(e){t._textureRep.release(e)}),this._textureRef=r.applySome(e,function(e){return t._textureRep.acquire(e,!!t._options.initTransparent)}))},e}();t.TextureBinding=n}.apply(null,n))||(e.exports=a)},2518:function(e,t,r){var n,a;n=[r.dj.c(e.i),t,r(24),r(21),r(137),r(61),r(22),r(535),r(536),r(82),r(67),r(89)],void 0===(a=function(e,t,r,n,a,i,o,s,l,c,u,d){var h=function(){function e(e,t,r){this._material=r,this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._materialRep=t,this._glMaterials=l.acquireMaterials(this._material,this._materialRep)}return e.prototype.dispose=function(){l.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.hasWater=function(){return!1},e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateHighlightCount()},e.prototype.addAndRemoveGeometries=function(e,t){var u=this,h=this._rctx,p=this._dataByOrigin;e.forEach(function(e){var t=e.data;if(t.preinterleaved)if(null!=t.vertexData){var m=e.origin.id,g=e.origin.vec3,y=e.uniqueName,v=p.get(m);v||(v={origin:g,highlightCount:0,dataByGeometry:new Map},p.set(m,v)),o.setMatrixTranslation3(f,-g[0],-g[1],-g[2]);var b=n.mat4f64.create();r.mat4.multiply(b,f,e.transformation);var _=l.generateRenderGeometryVisibleIndexRanges(e),x=l.generateRenderGeometryHighlightRanges(e);x&&(v.highlightCount=null);var C=t.indexCount,w=t.id,I=new s(e.name,0,C,_,x,b,e.instanceParameters,e.idx,w),S=t.indexData?c.createIndex(h,35044,t.indexData):null,M=u._material.createBufferLayout(),O=new d(h,i.Default3D,{geometry:a.glLayout(M)},{geometry:c.createVertex(h,35044)},S);O.vertexBuffers.geometry.setData(t.vertexData),t.indexData=null,t.vertexData=null,v.dataByGeometry.set(y,{instance:I,vao:O})}else o.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else o.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}),t.forEach(function(e){var t=e.origin.id,r=e.uniqueName,n=p.get(t);n.dataByGeometry.get(r).vao.dispose(),n.dataByGeometry.delete(r),0===n.dataByGeometry.size&&p.delete(t)})},e.prototype.updateGeometries=function(e){var t=this;e.forEach(function(e){var r=e.updateType,n=e.renderGeometry,a=n.origin.id,i=n.uniqueName,o=t._dataByOrigin.get(a),s=o&&o.dataByGeometry.get(i).instance;s&&(1&r&&(s.displayedIndexRange=l.generateRenderGeometryVisibleIndexRanges(n)),17&r&&(s.highlightedIndexRanges=l.generateRenderGeometryHighlightRanges(n),o.highlightCount=null),2&r&&console.error("Updating Preinterleaved geometry not supported"),4&r&&l.calculateTransformRelToOrigin(n,s.transformation,s.transformationNormal))})},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.dataByGeometry.forEach(function(e){e.instance.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.render=function(e,t,r,n){var a=this,i=this._rctx,o=this._glMaterials.get(t.pass),s=4===t.pass;if(!o||null!=e&&!o.beginSlot(e)||s&&0===this._highlightCount)return!1;o.bind(i,r);var l=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,o.bindView(i,r),s?e.dataByGeometry.forEach(function(e){l=a.renderInstanceHighlight(o,e,n)||l}):e.dataByGeometry.forEach(function(e){l=a.renderInstance(o,e,n)||l}))}),o.release(i,r),i.bindVAO(null),l},e.prototype.renderInstance=function(e,t,r){var n=t.instance,a=t.vao,i=n.displayedIndexRange;if(i&&0===i.length)return!1;var o=this._rctx,s=e.getProgram(),c=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(a,s),o.bindVAO(a),e.bindInstance(o,n);var d=a.indexBuffer&&a.indexBuffer.indexType;if(i)d?l.drawElementsFaceRange(o,i,n.from,c,d,r):l.drawArraysFaceRange(o,i,n.from,c,r);else{var h=n.to-n.from;d?l.drawElements(o,c,d,n.from,h,r):l.drawArrays(o,c,n.from,h,r)}return!0},e.prototype.renderInstanceHighlight=function(e,t,r){var n=t.instance,a=t.vao,i=n.highlightedIndexRanges;if(!i)return!1;var o=this._rctx,s=e.getProgram(),c=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(a,s),o.bindVAO(a),e.bindInstance(o,n);for(var d=a.indexBuffer&&a.indexBuffer.indexType,h=!1,f=0;f<i.length;f++){var p=i[f],m=p.range?p.range[0]+n.from:n.from,g=p.range?p.range[1]-p.range[0]+1:n.to-n.from;d?l.drawElements(o,c,d,m,g,r):l.drawArrays(o,c,m,g,r),h=!0}return h},e}(),f=n.mat4f64.create();return h}.apply(null,n))||(e.exports=a)}}]);