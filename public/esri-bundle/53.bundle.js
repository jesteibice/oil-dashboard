(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/2d/layers/VectorTileLayerView2D":2158,"esri/views/2d/layers/LayerView2D":2178,"esri/views/2d/engine/vectorTiles/VectorTileContainer":2532,"esri/views/2d/tiling/TileInfoViewPOT":2546})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{2158:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1),i(0),i(9),i(11),i(62),i(47),i(18),i(13),i(7),i(2),i(2334),i(2532),i(2336),i(2178),i(2546),i(202),i(821),i(822)],void 0===(n=function(e,t,i,r,n,a,s,l,o,u,d,p,h,c,f,y,v,_,g,w){var m=u.getLogger("esri.views.2d.layers.VectorTileLayerView2D");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._fetchQueue=null,t._parseQueue=null,t._isTileHandlerPromiseFulfilled=!1,t._handles=new o,t._invalidateStyle=!1,t.container=new c,t}return i(t,e),t.prototype.initialize=function(){var e=this;this._tileInfoView=new v(this.layer.tileInfo,this.layer.fullExtent),this._tileHandler=new h(this.layer,window.devicePixelRatio||1,!0,this.container),this.handles.add(this.watch("layer.currentStyleInfo",function(t){e._start()}))},t.prototype.destroy=function(){this._stop(),this.container.dispose(),this._tileHandler.destroy(),this._tileHandler=null},t.prototype.hitTest=function(e,t){var i=this;return this.suspended||!this._tileHandlerPromise?d.resolve(null):l.safeCast(this._tileHandlerPromise).then(function(){return i.container.hitTest(e,t).then(function(e){var t=i._tileHandler.getStyleRepository().layers;if(null===e||e<0||e>=t.length)return null;var r=t[e],n=new s({attributes:{layerId:e,layerName:r.id}});return n.layer=i.layer,n.sourceLayer=i.layer,n})})},t.prototype.update=function(e){var t=this;this.notifyChange("updating");var i=this._tileHandlerPromise;i&&i.then(function(){if(e.pixelRatio!==t._tileHandler.devicePixelRatio)return t._start(),void(t._tileHandler.devicePixelRatio=e.pixelRatio);t._invalidateStyle?(t._issueStyleInvalidation(e),t._invalidateStyle=!1):(t._fetchQueue.pause(),t._parseQueue.pause(),t._fetchQueue.state=e.state,t._parseQueue.state=e.state,t._tileStrategy.update(e),t._parseQueue.resume(),t._fetchQueue.resume());for(var i=0,r=t.container.children;i<r.length;i++){var n=r[i];t._tileHandler.updateTile(n,e)}})},t.prototype.attach=function(){var e=this;this._start(),this._handles.add(this.layer.on("paint-change",function(t){return e.container.requestRender()})),this._handles.add(this.layer.on("layout-change",function(t){e._invalidateStyle=!0,e.requestUpdate()}))},t.prototype.detach=function(){this._stop(),this._handles.removeAll()},t.prototype.moveStart=function(){this.requestUpdate()},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){this.requestUpdate()},t.prototype.canResume=function(){var e=this.inherited(arguments),t=this.layer;if(e&&t.currentStyleInfo){var i=this.view.scale,r=t.currentStyleInfo;if(r&&r.layerDefinition){var n=r.layerDefinition;n.minScale&&n.minScale<i&&(e=!1),n.maxScale&&n.maxScale>i&&(e=!1)}}return e},t.prototype.isUpdating=function(){return!this._isTileHandlerPromiseFulfilled||this._fetchQueue.updating||this._parseQueue.updating},t.prototype.acquireTile=function(e){var t=this,i=_.pool.acquire();i.set(e.level,e.row,e.col,e.world);var r=this.updateParameters.state.rotation,n=this._tileHandler.getStyleRepository(),a=f.pool.acquire(i,this.layer.tileInfo,n,r);return l.safeCast(this._tileHandlerPromise).then(function(){t.notifyChange("updating"),t._fetchQueue.push(a.key).then(function(e){return t._parseQueue.push(e)}).then(function(e){a.setData(e.tileData,e.client,e.refKeys),a.once("attach",function(){return t.requestUpdate()}),t.container.addChild(a),t.notifyChange("updating")}).catch(function(e){t.notifyChange("updating"),d.isAbortError(e)||m.error(e)})}),a},t.prototype.releaseTile=function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.container.removeChild(e),this.requestUpdate(),e.once("detach",function(){return f.pool.release(e)}),this.notifyChange("updating")},t.prototype._start=function(){var e=this;if(this._stop(),this.layer.currentStyleInfo&&this.attached){var t=new AbortController,i=this._tileHandler.start({signal:t.signal}).then(function(){e._tileStrategy=new w({cachePolicy:"keep",coveragePolicy:"smallest",acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:e._tileInfoView}),e._fetchQueue=new g({tileInfoView:e._tileInfoView,process:function(t,i){return e._getTileData(t,i)},concurrency:15}),e._parseQueue=new g({tileInfoView:e._tileInfoView,process:function(t,i){return e._parseTileData(t,i)},concurrency:8}),e.container.initialize(e._tileHandler.spriteMosaic,e._tileHandler.glyphMosaic,e.layer.tileInfo,e._tileInfoView),e.requestUpdate(),e._isTileHandlerPromiseFulfilled=!0});this._tileHandlerAbortController=t,this._tileHandlerPromise=i}},t.prototype._stop=function(){if(this._tileHandlerAbortController){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerPromiseFulfilled=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this.container.removeAllChildren(),f.pool.prune()}},t.prototype._getTileData=function(e,t){return a(this,void 0,void 0,function(){var i;return n(this,function(r){switch(r.label){case 0:return[4,this._tileHandler.fetchTileData(e,t)];case 1:return i=r.sent(),this.notifyChange("updating"),[2,{key:e,data:i}]}})})},t.prototype._parseTileData=function(e,t){return a(this,void 0,void 0,function(){return n(this,function(i){return[2,this._tileHandler.parseTileData(e,this.updateParameters.state.rotation,t)]})})},t.prototype._issueStyleInvalidation=function(e){var t=this;this.notifyChange("updating"),this._tileHandlerPromise=this._tileHandler.updateStyle().then(function(){t._fetchQueue.pause(),t._parseQueue.pause(),t._fetchQueue.clear(),t._parseQueue.clear(),t._parseQueue.resume(),t._fetchQueue.resume(),t.notifyChange("updating"),t.requestUpdate()})},r([p.property({dependsOn:["view.scale","layer.currentStyleInfo"]})],t.prototype,"suspended",void 0),r([p.subclass("esri.views.2d.layers.VectorTileLayerView2D")],t)}(p.declared(y))}.apply(null,r))||(e.exports=n)},2178:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1),i(0),i(29),i(2),i(2174)],void 0===(n=function(e,t,i,r,n,a,s){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.attached=!1,t.lastUpdateId=-1,t.moving=!1,t.updateRequested=!1,t}return i(t,e),t.prototype.initialize=function(){var e=this;this.when(function(){e.requestUpdate()});var t=function(){return e.notifyChange("rendering")};this.handles.add([n.init(this,"suspended",function(t){e.container&&(e.container.visible=!t),e.view&&!t&&e.updateRequested&&e.view.requestLayerViewUpdate(e)},!0),n.init(this,"fullOpacity",function(t){e.container&&(e.container.opacity=t)},!0),n.on(this,"container","post-render",t),n.on(this,"container","will-render",t)])},t.prototype.destroy=function(){this.attached&&(this.attached=!1,this.detach()),this.handles.remove("initialize"),this.updateRequested=!1,this.layer=null},Object.defineProperty(t.prototype,"rendering",{get:function(){return this.attached&&!this.suspended&&(this.moving||this.container.renderRequested||this.isRendering())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&(!this.attached||this.updateRequested||this.isUpdating())},enumerable:!0,configurable:!0}),t.prototype.isVisibleAtScale=function(e){var t=!0,i=this.layer,r=i.minScale,n=i.maxScale;if(null!=r&&null!=n){var a=!r,s=!n;!a&&e<=r&&(a=!0),!s&&e>=n&&(s=!0),t=a&&s}return t},t.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestLayerViewUpdate(this))},t.prototype.processUpdate=function(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1},t.prototype.isUpdating=function(){return!1},t.prototype.isRendering=function(){return!1},t.prototype.canResume=function(){var e=this.inherited(arguments);return e&&(e=this.isVisibleAtScale(this.view.scale)),e},r([a.property()],t.prototype,"attached",void 0),r([a.property()],t.prototype,"container",void 0),r([a.property()],t.prototype,"moving",void 0),r([a.property({dependsOn:["attached","suspended","moving"]})],t.prototype,"rendering",null),r([a.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],t.prototype,"suspended",void 0),r([a.property({readOnly:!0})],t.prototype,"updateParameters",void 0),r([a.property()],t.prototype,"updateRequested",void 0),r([a.property({dependsOn:["updateRequested","attached"]})],t.prototype,"updating",null),r([a.property()],t.prototype,"view",void 0),r([a.subclass("esri.views.2d.layers.LayerView2D")],t)}(a.declared(s))}.apply(null,r))||(e.exports=n)},2532:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(12),i(26),i(7),i(24),i(474),i(354),i(472),i(2118),i(807),i(2337)],void 0===(n=function(e,t,i,r,n,a,s,l,o,u,d,p){var h=u.enums.WGLDrawPhase;return o.enums.BlendFactor,o.enums.CompareFunction,o.enums.StencilOperation,function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._tileCoordinateScale=l.vec3f32.create(),t._orientationVec=l.vec3f32.fromValues(0,0,1),t._displayScale=l.vec3f32.create(),t._defaultTransform=s.mat4f32.create(),t._displayWidth=0,t._displayHeight=0,t._pointToCallbacks=new Map,t}return i(t,e),t.prototype.initialize=function(e,t,i,r){var n=this;this._spriteMosaicPromise=e,this._spriteMosaicPromise.then(function(i){n._spriteMosaicPromise===e&&(n._renderer=new p(i,t))}),this._tileInfoView=r,this._tileInfo=i},t.prototype.dispose=function(){this._renderer&&this._renderer.dispose(),e.prototype.dispose.call(this)},t.prototype.hitTest=function(e,t){var i=this,r=[e,t];return n.create(function(e,t){i._pointToCallbacks.set(r,{resolve:e,reject:t}),i.requestRender()},function(){i._pointToCallbacks.has(r)&&i._pointToCallbacks.delete(r)})},t.prototype.renderChildren=function(t){var i=this;if(0!==this.children.length&&this._tileInfoView&&t&&t.state&&(t.drawPhase===h.MAP||t.drawPhase===h.HITTEST)){if(!this._renderer)return void this.requestRender();if(r("esri-vector-tiles-debug"))for(var n=0,a=this.children;n<a.length;n++){(v=a[n]).triangleCount=0}var s=t.state,l=this.stage.context,o=this._renderer;o.initializeProgramCache(this.stage.context),o.setGlobalOpacity(l,t,this.opacity),l.setDepthWriteEnabled(!0),l.setStencilWriteMask(255),l.setClearDepth(1),l.setClearStencil(0),l.clear(l.gl.DEPTH_BUFFER_BIT|l.gl.STENCIL_BUFFER_BIT),l.setDepthWriteEnabled(!1);var u=t;u.displayLevel=this._tileInfoView.scaleToLevel(s.scale),u.requiredLevel=this._tileInfoView.getSmallestInfoForScale(s.scale).level,u.renderer=this._renderer,this.sortChildren(function(e,t){return e.key.level-t.key.level});for(var d=this.children.length,p=1;p<=d;p++){var c=this.children[p-1];c.attached&&c.visible&&(c.stencilData.reference=p,c.stencilData.mask=255)}if(this._updateTilesTransform(u.state,u.requiredLevel,this.children),l.setDepthWriteEnabled(!0),this._renderer.setStateParams(u.state,u.pixelRatio,u.displayLevel),this._renderer.drawClippingMasks(l,this.children),l.setStencilWriteMask(0),l.setBlendFunctionSeparate(1,771,1,771),l.setStencilOp(7680,7680,7681),l.setDepthFunction(515),l.setBlendingEnabled(!1),l.setStencilTestEnabled(!0),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),u.drawphase=0,e.prototype.renderChildren.call(this,u),l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),u.drawphase=1,e.prototype.renderChildren.call(this,u),u.drawphase=2,e.prototype.renderChildren.call(this,u),l.setStencilTestEnabled(!1),l.setDepthTestEnabled(!1),o.applyGlobalOpacity(l,t,this.opacity),r("esri-vector-tiles-debug"))for(var f=0,y=this.children;f<y.length;f++){var v;(v=y[f]).attached&&v.visible&&this._renderer.renderTileInfo(l,v)}this._pointToCallbacks.size>0&&(this._pointToCallbacks.forEach(function(e,t){e.resolve(i._hitTest(u,t[0],t[1]))}),this._pointToCallbacks.clear()),this._renderer.needsRedraw()&&this.requestRender()}},t.prototype.removeAllChildren=function(){for(var t=0;t<this.children.length;t++)this.children[t].dispose();e.prototype.removeAllChildren.call(this)},t.prototype._hitTest=function(e,t,i){var r=this._tileInfoView.getSmallestInfoForScale(e.state.scale).level,n=[0,0];e.state.toMap(n,[t,i]);var a=e.state.clone(),s=a.viewpoint.clone(),l=s.targetGeometry;l.x=n[0],l.y=n[1],s.targetGeometry=l,a.viewpoint=s,a.size=[3,3],this._renderer.setStateParams(a,e.pixelRatio,e.displayLevel);var o={context:this.stage.context,drawPhase:0,pixelRatio:e.pixelRatio,stationary:e.stationary,globalOpacity:e.globalOpacity,displayLevel:e.displayLevel,requiredLevel:e.requiredLevel,renderer:e.renderer,layerOpacity:e.layerOpacity,state:a,drawphase:3},u=this._renderer.hitTest(o,t,i,this.children,r,3,this._updateTilesTransform.bind(this));return u&&0!==u.length?u[0]:null},t.prototype._updateTilesTransform=function(e,t,i){var r=1/e.size[0],n=1/e.size[1],a=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lodAt(t).resolution,e.resolution,e.rotation,this._tileInfo.size[1],4096,e.size[0],e.size[1],this._defaultTransform);for(var s=0,l=i;s<l.length;s++){var o=l[s];e.toScreen(a,o.coords),a[1]=e.size[1]-a[1],o.tileTransform.displayCoord[0]=2*a[0]*r-1,o.tileTransform.displayCoord[1]=2*a[1]*n-1,o.key.level===t&&4096===o.coordRange?o.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfo.lodAt(o.key.level).resolution,e.resolution,e.rotation,this._tileInfo.size[1],o.coordRange,e.size[0],e.size[1],o.tileTransform.transform)}},t.prototype._calculateRelativeViewProjMat=function(e,t,i,r,n,s,l,o){var u=.125;512!==r&&4096!==n&&(u=r/n);var p=u*(e/t);this._tileCoordinateScale.set([p,p,1]),s===this._displayWidth&&l===this._displayHeight||(this._displayScale.set([2/s,-2/l,1]),this._displayWidth=s,this._displayHeight=l),a.mat4.identity(o),a.mat4.scale(o,o,this._tileCoordinateScale),a.mat4.rotate(o,o,-i*d.C_DEG_TO_RAD,this._orientationVec),a.mat4.scale(o,o,this._displayScale),a.mat4.transpose(o,o)},t}(u.Container)}.apply(null,r))||(e.exports=n)},2546:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(12),i(0),i(104),i(810),i(202)],void 0===(n=function(e,t,i,r,n,a,s){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._fullCacheLodInfos=null,t._levelByScale={},t}return i(t,e),t.prototype.getTileParentId=function(e){var t=s.pool.acquire(e),i=0===t.level?null:s.getId(t.level-1,t.row>>1,t.col>>1,t.world);return s.pool.release(t),i},t.prototype.getTileCoverage=function(t,i,r){var n=e.prototype.getTileCoverage.call(this,t,i,r);if(!n)return n;var a=1<<n.lodInfo.level;return n.spans=n.spans.filter(function(e){return e.row>=0&&e.row<a}),n},t.prototype.scaleToLevel=function(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];var t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;for(var i=void 0,r=void 0,n=0;n<t.length-1;n++)if(e>(r=t[n+1]).scale)return(i=t[n]).level+(i.scale-e)/(i.scale-r.scale);return t[t.length-1].level},t.prototype._initializeFullCacheLODs=function(e){var t;if(0===e[0].level)t=e.map(function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}});else{var i=this.tileInfo.size[0],r=this.tileInfo.spatialReference;t=n.create({size:i,spatialReference:r}).lods.map(function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}})}for(var a=0;a<t.length;a++)this._levelByScale[t[a].scale]=t[a].level;this._fullCacheLodInfos=t},t}(a)}.apply(null,r))||(e.exports=n)}}]);