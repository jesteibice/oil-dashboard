(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/2d/layers/features/support/TileUpdateQueue":2284,"esri/views/2d/layers/features/controllers/MemoryController":2651})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{2284:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(0),r(9),r(11),r(8),r(7),r(60),r(2),r(45),r(820)],void 0===(n=function(e,t,r,i,n,o,s,u,a,l,h,p){Object.defineProperty(t,"__esModule",{value:!0});var c=[0,0],d=function(e){function t(t){var r=e.call(this,t)||this;return r._queue=new Map,r._isPaused=!1,r._scheduledNextHandle=null,r._timestamp=Date.now(),r.tileInfoView=null,r._next=r._next.bind(r),r._finalize=r._finalize.bind(r),r}return r(t,e),Object.defineProperty(t.prototype,"length",{get:function(){return this._queue.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._queue.size>0||null!=this._onGoingTile},enumerable:!0,configurable:!0}),t.prototype.abort=function(e){this._onGoingTile&&this._onGoingTile.tileId===e&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._queue.delete(e),this._scheduleNext(),this.notifyChange("updating")},t.prototype.clear=function(){this._queue.clear(),this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._cancelNext(),this.notifyChange("updating")},t.prototype.has=function(e){return this._queue.has(e)},t.prototype.isOngoing=function(e){return this._onGoingTile&&this._onGoingTile.tileId===e},t.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},t.prototype.push=function(e,t){if(!this._queue.has(e)){var r=u.createAbortController();this._queue.set(e,{tileId:e,key:p.TileKey.pool.acquire(e),timestamp:t||this._timestamp,abortController:r}),this._scheduleNext(),this.notifyChange("updating")}},t.prototype.refresh=function(){this._timestamp=Date.now(),this.reset()},t.prototype.reset=function(){var e=this._onGoingTile;if(e){var t=e.tileId;this.push(t,this._timestamp)}this.notifyChange("updating")},t.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext()),this.notifyChange("updating")},t.prototype._finalize=function(){this._onGoingTile=null,this.notifyChange("updating"),this._scheduleNext()},t.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)},t.prototype._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=a.schedule(this._next))},t.prototype._next=function(){return o(this,void 0,void 0,function(){var e,t,r,i,o;return n(this,function(n){switch(n.label){case 0:if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)return this._scheduledNextHandle=null,[2];if(this._scheduledNextHandle=null,e=this._peek(),t=e.abortController.signal,r=e.tileId,i=e.key,p.TileKey.pool.release(i),this._queue.delete(r),this._onGoingTile=e,o=this.process(r,this._timestamp,{signal:t}),this.notifyChange("updating"),!function(e){return e&&"function"==typeof e.then}(o))return[3,4];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,o];case 2:return n.sent(),[3,4];case 3:return n.sent(),[3,4];case 4:return this._finalize(),[2]}})})},t.prototype._peek=function(){var e=this;if(!this.state)throw new Error("state not set");var t=this.tileInfoView,r=this.state.center,i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,o=null;return this._queue.forEach(function(s,u){t.getTileCoords(c,s.key);var a=e._timestamp-s.timestamp;if(isNaN(a))(l=h.vec2.distance(c,r))<n&&(n=l,o=s);else if(a===i){var l;(l=h.vec2.distance(c,r))<n&&(n=l,o=s)}else a>i&&(i=a,n=Number.POSITIVE_INFINITY,o=s)}),o},i([l.property({readOnly:!0})],t.prototype,"length",null),i([l.property({constructOnly:!0})],t.prototype,"process",void 0),i([l.property()],t.prototype,"state",void 0),i([l.property({constructOnly:!0})],t.prototype,"tileInfoView",void 0),i([l.property({readOnly:!0})],t.prototype,"updating",null),i([l.subclass("esri.views.2d.layers.features.support.TileUpdateQueue")],t)}(l.declared(s));t.default=d}.apply(null,i))||(e.exports=n)},2651:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(0),r(4),r(9),r(11),r(35),r(13),r(7),r(164),r(2),r(74),r(183),r(2118),r(2283),r(2284)],void 0===(n=function(e,t,r,i,n,o,s,u,a,l,h,p,c,d,f,y,_){Object.defineProperty(t,"__esModule",{value:!0});var g=a.getLogger("esri.views.2d.layers.features.controllers.MemoryController"),m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="memory",t}return r(t,e),t.prototype.initialize=function(){var e=this;this._tileQueue=new _.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._fetchFeatureSet(t,r,i)}}),this._memorySource=h.openWithPorts(this.service.source,{client:this}),this.refresh(),this._tileQueue.resume()},t.prototype.destroy=function(){this._memorySource.close(),this._memorySource=null,this._tileQueue.clear(),this._tileQueue.pause()},Object.defineProperty(t.prototype,"updating",{get:function(){return this._tileQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return s(this,void 0,void 0,function(){var r,i=this;return o(this,function(n){switch(n.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return n.sent(),t?r===this.renderer.getAttributeHash()?[3,3]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,5];case 2:n.sent(),n.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return n.sent(),this.refresh(),[2];case 5:return"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,8]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 6:return n.sent(),[4,l.all(this.tileStore.tiles.map(function(e){return i._updateTileAttrData(e)}))];case 7:n.sent(),n.label=8;case 8:return[4,this.attributeStore.updateFilters(this)];case 9:return n.sent(),[4,this.attributeStore.sendUpdates()];case 10:return n.sent(),[2]}})})},t.prototype.invalidate=function(){this.refresh()},t.prototype.onEdits=function(e){this.refresh()},t.prototype.queryFeatures=function(e){return this._memorySource.invoke("queryFeatures",e)},t.prototype.queryFeatureCount=function(e){return this._memorySource.invoke("queryFeatureCount",e)},t.prototype.queryObjectIds=function(e){return this._memorySource.invoke("queryObjectIds",e)},t.prototype.queryExtent=function(e){return this._memorySource.invoke("queryExtent",e)},t.prototype.redraw=function(){this.refresh()},t.prototype.refresh=function(){this._tileQueue.refresh();for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._tileQueue.push(r.id,r.updateTimestamp)}},t.prototype.setViewState=function(e){this.inherited(arguments),this._tileQueue.state=e},t.prototype.onTileUpdate=function(e){this._tileQueue.pause();for(var t=0,r=e.removed;t<r.length;t++){var i=r[t];this._tileQueue.abort(i.id)}for(var n=0,o=e.added;n<o.length;n++){i=o[n];this._tileQueue.push(i.id,i.updateTimestamp)}this.processor&&this._tileQueue.resume()},t.prototype._updateTileAttrData=function(e){return s(this,void 0,void 0,function(){var t,r,i,n,s,u;return o(this,function(o){switch(o.label){case 0:return[4,this._query(e,this.queryInfo)];case 1:for(t=o.sent(),r=d.convertFromFeatureSet(t,this.service.objectIdField),r=d.hydrateOptimizedFeatureSet(r),i=0,n=r.features;i<n.length;i++)s=n[i],u=this.attributeStore.createLocalId(s.objectId),this.attributeStore.setAttributeData(u,s,this.geometryInfo,this.viewParams);return[2]}})})},t.prototype._fetchFeatureSet=function(e,t,r){var i=this,n=this.tileStore.get(e),o=this.queryInfo;return this._query(n,o,r).then(function(e){return i._wrapPoints(e,o)}).then(function(e){return i._sortFeatures(e,o)}).then(function(e){return e.features.length?e:null}).then(function(e){return n.updateTimestamp=t,i.processor.onTileData(n,{addOrUpdate:e&&e.features,clear:!0,transformParams:e&&f.Utils.getTransformParams(e)},r)}).catch(function(e){return n.updateTimestamp=t,l.isAbortError(e)||(i.processor.onTileError(n,e.message,r),g.error("query-error",{error:e})),l.reject(e)})},t.prototype._query=function(e,t,r){var i=this,n=this._pixelBuffer*e.resolution,o=e.bounds.slice();o[0]-=n,o[1]-=n,o[2]+=n,o[3]+=n;var s=u.Extent.fromBounds(o,this.spatialReference),a=this._createQuery(s,e.extent,e.resolution,this.queryInfo);return this.queryFeatures(a.toJSON()).then(function(e){return t.returnCentroid?e.features=e.features.filter(function(e){return null!=e.geometry&&null!=e.centroid}):e.features=e.features.filter(function(e){return null!=e.geometry}),e}).then(function(e){return i._applyProcessing(e,r)}).then(function(e){var t=d.convertFromFeatureSet(e,i.service.objectIdField);t=d.hydrateOptimizedFeatureSet(t);for(var r=0;r<e.features.length;r++){var n=e.features[r],o=t.features[r],s=i.attributeStore.getLocalId(o.objectId);null==s&&(s=i.attributeStore.createLocalId(o.objectId)),n.localId=s,i.attributeStore.setAttributeData(s,o,i.geometryInfo,i.viewParams)}return i.attributeStore.sendUpdates(),e})},t.prototype._wrapPoints=function(e,t){if(0===e.features.length)return e;var r=t.returnCentroid,i=this._pixelBuffer,o=e.geometryType,s=e.spatialReference,u=e.transform;if("esriGeometryPoint"!==o&&"esriGeometryMultipoint"!==o&&!r||!c.isWrappable(s))return e;var a=e.features,l=c.getInfo(s),h=Math.round((l.valid[1]-l.valid[0])/u.scale[0]);if(h===f.definitions.TILE_SIZE){for(var p=[],d=0,y=a;d<y.length;d++){var _=y[d],g=_.geometry,m=_.attributes;if(g)if(g.x<i){(v={geometry:n({},g),attributes:m}).geometry.x+=h,p.push(v)}else if(g.x>f.definitions.TILE_SIZE-i){var v;(v={geometry:n({},g),attributes:m}).geometry.x-=h,p.push(v)}}a.push.apply(a,p)}else for(var b=0,I=a;b<I.length;b++){(g=I[b].geometry)&&(g.x<-i?g.x+=h:g.x>f.definitions.TILE_SIZE+i&&(g.x-=h))}return e},t.prototype._sortFeatures=function(e,t){var r=t.orderByFields;if(r){var i=r[0].split(" "),n=i[0];"DESC"===i[1]&&e.features.sort(function(e,t){return t.attributes[n]-e.attributes[n]})}return e},i([p.property()],t.prototype,"_tileQueue",void 0),i([p.property({dependsOn:["_tileQueue.updating"]})],t.prototype,"updating",null),i([p.subclass("esri.views.2d.layers.features.controllers.MemoryController")],t)}(p.declared(y.default));t.default=m}.apply(null,i))||(e.exports=n)}}]);