(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/layers/LayerView":2174,"esri/views/3d/layers/LayerView3D":2176,"esri/views/3d/layers/support/layerViewUpdatingProperties":2180,"esri/views/3d/layers/support/attributeUtils":2238,"esri/layers/graphics/controllers/I3SOnDemandController":2331,"esri/views/3d/layers/i3s/I3SFrameTask":2505,"esri/views/3d/layers/i3s/I3SIndex":2506,"esri/views/3d/layers/i3s/I3SLodHandling":2507,"esri/views/3d/layers/i3s/I3SNodeLoader":2508,"esri/views/3d/layers/i3s/I3SStreamDataController":2509,"esri/views/3d/layers/i3s/I3SViewportQueries":2510})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{2174:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(0),r(50),r(353),r(284),r(13),r(283),r(7),r(2)],void 0===(n=function(e,t,r,i,n,o,a,s,d,l,u){return function(e){function t(t){var r=e.call(this)||this;return r.layer=null,r.parent=null,r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer),this.when().catch(function(t){if("layerview:create-error"!==t.name){var r=e.layer&&e.layer.id||"no id",i=e.layer&&e.layer.title||"no title";return s.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '"+i+"', id: '"+r+"')",t),l.reject(t)}})},t.prototype.destroy=function(){this.layer=this.view=this.parent=null},Object.defineProperty(t.prototype,"suspended",{get:function(){return!this.canResume()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&this.isUpdating()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullOpacity",{get:function(){var e=function(e){return null==e?1:e};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))},enumerable:!0,configurable:!0}),t.prototype.canResume=function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1},t.prototype.isUpdating=function(){return!1},i([u.property()],t.prototype,"layer",void 0),i([u.property()],t.prototype,"parent",void 0),i([u.property({readOnly:!0,dependsOn:["view","visible","layer.loaded","parent.suspended"]})],t.prototype,"suspended",null),i([u.property({type:Boolean,dependsOn:["suspended"],readOnly:!0})],t.prototype,"updating",null),i([u.property()],t.prototype,"view",void 0),i([u.property({dependsOn:["layer.visible"]})],t.prototype,"visible",null),i([u.property({dependsOn:["layer.opacity","parent.fullOpacity"]})],t.prototype,"fullOpacity",null),i([u.subclass("esri.views.layers.LayerView")],t)}(u.declared(o,n,a.Identifiable,d))}.apply(null,i))||(e.exports=n)},2176:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(0),r(7),r(29),r(2),r(473),r(2174)],void 0===(n=function(e,t,r,i,n,o,a,s,d){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.slicePlaneEnabled=!1,t.supportsHeightUnitConversion=!1,t}return r(t,e),t.prototype.postscript=function(e){this.inherited(arguments),s.mayHaveHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())},t.prototype._validateHeightModelInfo=function(){var e=this;return n.create(function(t,r){o.whenFalseOnce(e.view.defaultsFromMap,"isHeightModelInfoSearching",function(){var i=s.rejectLayerError(e.layer,e.view.heightModelInfo,e.supportsHeightUnitConversion);i?r(i):t()})})},i([a.property()],t.prototype,"view",void 0),i([a.property()],t.prototype,"slicePlaneEnabled",void 0),i([a.subclass("esri.views.3d.layers.LayerView3D")],t)}(a.declared(d))}.apply(null,i))||(e.exports=n)},2180:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updatingPercentageValue={value:100,readOnly:!0},t.updatingPercentage={dependsOn:["updating","updatingPercentageValue"],readOnly:!0,value:0,get:function(){return this.updating?this.updatingPercentageValue:0}}}.apply(null,i))||(e.exports=n)},2238:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var o=n[i];if(o.toLowerCase()===r)return e[o]}return null}}.apply(null,i))||(e.exports=n)},2331:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1),r(0),r(8),r(58),r(47),r(50),r(18),r(26),r(13),r(117),r(283),r(7),r(29),r(2),r(10),r(6),r(55),r(44),r(91),r(839),r(2505),r(2506),r(2507),r(2508),r(2509),r(2182),r(2510),r(300),r(38),r(826)],void 0===(n=function(e,t,r,i,n,o,a,s,d,l,u,h,c,p,f,g,y,_,v,m,b,x,D,w,N,P,C,S,I,L,O,M){function A(e,t){return e.length===t.length&&e.every(function(e){return V(t,e.name)>=0})}function V(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}function F(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var E=u.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),T=function(e){function t(t){var r=e.call(this,t)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingPercentage=0,r.leafsReached=!1,r.scaleVisibilityEnabled=!0,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new h({deallocator:null}),r._loadedNodeScales=new Map,r._abortController=p.createAbortController(),r._downloadingNodes=new Set,r._loadingNodes=new Set,r._updatingNodes=new Set,r._progressMaxNumNodes=1,r._poi=_.vec3f64.create(),r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r.disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new d,r._idleQueue=new x.PromiseQueue,r._errorCount=0,r}return r(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(L.ClientType.SCENE);return new C.default(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return S.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return S.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._index&&this._index.rootNode;return!e||(this._updateViewData(),this._index.isNodeVisible(e.index))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new N(this.layerView,function(){return e._evaluateUpdating()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=l("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=p.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var r=e.layerView.view;e._setClippingArea(r.clippingArea),e._centerOnSurface=r.pointsOfInterest.centerOnSurfaceFrequent;var i=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),i.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),f.init(e.layerView,"suspended",function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=i.scheduler.registerIdleStateCallbacks(r,n)}),D.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),r.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layer.watch(["minScale","maxScale"],function(){return e._scaleBoundsChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("availableFields?",function(){return e._requiredFieldsChange()})]),e._updateScaleHandles(),e._viewportQueries=new I(e.crsIndex,r.renderCoordsHelper,r.state.camera,e._clippingArea,r.elevationProvider,e.layer,{progressiveLoadFactor:e._getProgressiveLoadFactor(e.layer),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5});var n=t.store.rootNode.split("/").pop();e._index=new w.I3SIndex(e.getBaseUrl(),n,e.layer.nodePages,e.streamDataController,e._viewportQueries,E,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t,"leaf")},function(t){return e._needsUpdate(t)})}});this._tmpPoint=b.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(r),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._abortController.abort(),this._abortController=null,this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,R.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map(function(r){var i=V(e,r),n=V(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null}).filter(function(e){return null!=e&&e.name!==r})},t.prototype._requiredFieldsChange=function(){A(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=v.create();O.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=G.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=_.vec3f64.create();y.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,n=_.vec3f64.create();i.worldUpAtPosition(t,n);var o=y.vec3.angle(n,r)-.5*Math.PI;return y.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,o/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),this._viewportQueries&&this._index&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._evaluateUpdating()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.updateElevationChanged=function(e,t){if(null!=this._index){null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new h({deallocator:null}));var r=this._elevationUpdateNodes;r.clear();var i=this._index.rootNode;null!=i&&S.findIntersectingNodes(e,t,i,this.crsIndex,this._index,function(e){return r.push(e.index)});for(var n=0;n<r.length;n++){var o=r.data[n];this._index.invalidateBoundingVolumeCache(o),o===i.index&&this.notifyChange("rootNodeVisible")}r.length&&this.restartNodeLoading()}},t.prototype.getParentIndex=function(e){return this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",function(t){return e._scaleUpdateHandler(t)}),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty(),this._lodHandling.setLodGlobalDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty(),this._lodHandling.setLodGlobalDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,r){var i=this;null!=this._index.rootNode&&O.boundingRectToBoundingRect(t,r,U,this.crsIndex)&&this._loadedNodeScales.forEach(function(t,r){var n=i._index.getNode(r);m.containsPoint(U,n.mbs)&&i._loadedNodeScales.set(r,e)})},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this._evaluateUpdating()},t.prototype.schedule=function(e,t){var r=this;return this._idleQueue.push(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw p.createAbortError();return t})},t.prototype.reschedule=function(e,t){var r=this;return this._idleQueue.unshift(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw p.createAbortError();return t})},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=M.extractSafeScaleBounds(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return this._index?this._index.maxLevel:0},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateView(e),-1/0):this.layerView.visible?(this._processLogError(e,t),this._index.getPriority()):-1/0},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?E.error("Error during processing: "+e):50===this._errorCount&&E.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateView(e),this.isIntegratedMesh&&(e.enabled=!1),e.run(function(){return r._processIndex(t,e)}),this._updateFeatureLOD(),e.run(function(){return r._processCache(e,t)}),this.isIntegratedMesh&&(e.enabled=!0),e.run(function(){return r._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return r._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this._evaluateUpdating(),this._lodHandling.lodGlobalHandling(e)}},t.prototype._processIndex=function(e,t){if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(o.keysOfSet(this._loadingNodes),t),!this.disableMemCache&&this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData&&(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var r=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||r===this._get("leafsReached")||this._set("leafsReached",r)}var i=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.load(i)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0||this._index.updates.add.length>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,o=this._index.checkFeatureTarget(t,n);o!==n&&(this._featureLOD=o/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e,t){for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=this._index.getParent(r);i&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=this._index.getParent(i.index))if(this._enableFromGPUCache(i,"hole")){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());this._updateLoadedNode(n),e.madeProgress()}for(;i.add.length>0&&!e.done&&r>0;){if(--r,2!==(n=this._index.getNode(i.add.back())).cacheState&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(n),e.madeProgress()}return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.clear(),this._abortController.abort(),this._abortController=new AbortController},t.prototype._cancelNode=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var r=t.numIndexLoading+this._index.getIndexLoading(),i=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*r-2*i)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._invisibleDirty||this._cameraDirty)?100:0;else{var r=(this._index?this._index.getIndexMissing():0)+3*(this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=100*r/this._progressMaxNumNodes}e!==this._get("updating")&&this._set("updating",e),t!==this._get("updatingPercentage")&&this._set("updatingPercentage",t)},t.prototype._updateView=function(e){this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._evaluateUpdating()},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=_.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=G.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){return this._index.invalidateVisibilityCache(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!e.obb||this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataController){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=P.TextureFormat.Normal;this.layerView.useCompressedTextures?t=P.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=P.TextureFormat.Downsampled);var r={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new P(this.layer,this.streamDataController,E,this._defaultGeometrySchema,this._requiredAttributes,r);var i=this.layerView.view.renderSpatialReference,n=this.crsIndex.equals(i)||this.crsIndex.isWGS84&&i.equals(O.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!n,this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._index.isNodeVisible(t)},function(t){return e._index.isGeometryVisible(t)},function(t){return e._isNodeInScaleBounds(t)},function(t){return e._index.nodeTraversalState(t)},function(t,r){return e._removeNodes(t,r)},this._index,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this;R.clear(),this.layerView.getLoadedNodeIndices(R);var r=0===this._viewportQueries.maxDistance,i=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return R.filterInPlace(function(e){var r=t._index.getNode(e);return!t._index.isGeometryVisible(e)||i(r)||!t._isNodeInScaleBounds(r)}),R.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(R,e),!(r&&this.lodDropFactor<1||0!==R.length&&(R.clear(),1))},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate();var r=e.length;if(this.layerView.removeNodeData(e,t),this._loadedNodeScales.size>0)for(var i=e.length;i<r;i++){var n=e.data[i];this._loadedNodeScales.delete(n)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=A(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?p.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,this._abortController.signal);this._updatingNodes.add(e.index),r.then(function(r){return t.schedule(e.index).then(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r})})}).catch(function(r){p.isAbortError(r)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()}),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.index),this._evaluateUpdating(),this._loadAndAddNode(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.index),t._evaluateUpdating()})},t.prototype._loadAndAddNode=function(e){var t=this;return 1===e.cacheState?this._loadUncached(e):this._loadCached(e).then(function(r){r||(e.cacheState=1,t._index.updates.add.push(e.index))}).catch(function(t){p.isAbortError(t)||(e.cacheState=1)})},t.prototype._enableFromGPUCache=function(e,t){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(e),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return t&&F(t.attributeInfo)&&A(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(e){this._index.requestUpdate(),this._lodHandling.lodSwapNodeLoaded(e)},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e,"leaf"))return p.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule(e.index).then(function(){return r.loadCachedNodeData(e,function(r){return t._nodeLoader.loadTextures(e,r,t._abortController.signal)})}).then(function(i){if(null==i)return!1;var n=t._requiredAttributes;return F(i)&&A(i.loadedAttributes,n)?t.reschedule(e.index).then(function(){return r.addCachedNodeData(e,i,i)}).then(function(){return t._nodeAdded(e),!0}):t.reschedule(e.index).then(function(){return t._nodeLoader.loadAttributes(e,n,t._abortController.signal)}).then(function(r){return t.reschedule(e.index,{loadedAttributes:n,attributeData:r})}).then(function(t){return r.addCachedNodeData(e,i,t)}).then(function(){return t._nodeAdded(e),!0})}):p.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.index),a.safeCast(this._nodeLoader.loadNodeData(e,this._abortController.signal)).then(function(r){return t._downloadingNodes.delete(e.index),t.schedule(e.index,r)}).then(function(r){return t.layerView.addNodeData(e,r)}).then(function(){t._nodeAdded(e),e.cacheState=2}).catch(function(r){p.isAbortError(r)||(E.error("Failed to load node '"+e.id+"': "+r),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=e.mbs;this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2];var r=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,r),r},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=M.extractSafeScaleBounds(this.layer),i=r.minScale,n=r.maxScale;return M.scaleBoundsPredicate(t,i,n)},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),i([g.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),i([g.property({readOnly:!0})],t.prototype,"isGraphics3D",null),i([g.property({readOnly:!0})],t.prototype,"streamDataController",null),i([g.property({readOnly:!0})],t.prototype,"crsVertex",null),i([g.property({readOnly:!0})],t.prototype,"crsIndex",null),i([g.property()],t.prototype,"camPos",void 0),i([g.property()],t.prototype,"screenSizeFactor",void 0),i([g.property()],t.prototype,"featureTarget",void 0),i([g.property()],t.prototype,"fixedFeatureTarget",void 0),i([g.property()],t.prototype,"layerView",void 0),i([g.property()],t.prototype,"layer",void 0),i([g.property({readOnly:!0})],t.prototype,"updating",void 0),i([g.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),i([g.property({readOnly:!0})],t.prototype,"leafsReached",void 0),i([g.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),i([g.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),i([g.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),i([g.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(g.declared(n,c,s)),R=new h({deallocator:null}),G={factorIM:.2,factor3dObject:.05,distancePenalty:10},U=m.create();return T}.apply(null,i))||(e.exports=n)},2505:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(58)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(2,function(e){return t.update(e)},function(){return t.needsUpdate()})}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.needsUpdate=function(){for(var e=0,t=this.callbacks;e<t.length;e++)if(t[e].needsUpdate())return!0;return!1},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){r.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),n=new Map;t.addTask=function(e,t){var r=n.get(e);return null==r&&(r=new i(e),n.set(e,r)),r.add(t),{remove:function(){if(null!=r){if(r.remove(t),r.callbacks.length>0)return void(r=null);n.delete(e),r.destroy(),r=null}}}}}.apply(null,i))||(e.exports=n)},2506:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(14),r(117),r(7),r(10),r(43),r(2182),r(2195)],void 0===(n=function(e,t,r,i,n,o,a,s,d,l){function u(e){e.node?(e.node.renderMbs[3]=-1,e.node.renderObb.halfSize[0]=-1):e.ref&&(e.ref.renderMbs[3]=-1,e.ref.renderObb.halfSize[0]=-1)}function h(e){return d.addWraparound(e,-2)}function c(e){return d.addWraparound(e,2)}function p(e,t){return 0===t?0:e/t|0}function f(e,t){return 0===t?e:e%t}function g(e){if(e)for(var t=0;t<e.length;t++)for(var r=0,i=b;r<i.length;r++){var n=i[r];if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}return{lodMetric:0,maxError:0}}function y(e){return Math.sqrt(e*(4/Math.PI))}Object.defineProperty(t,"__esModule",{value:!0});var _=function(){function e(e,t,r,i,o,a,s,d,l,u){var h=this;this.layerUrl=e,this.streamDataController=i,this.viewportQueries=o,this.logger=a,this._isLoaded=s,this._isSelected=d,this._enable=l,this._needsUpdate=u,this._dirty=!0,this.nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._visibilityCacheGeneration=c(0),this._maxLevel=1,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n({deallocator:null}),this._prefetch=new n({deallocator:null}),this._updates=new m,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.initNodePages(r).catch(function(){return h.initNodeDocuments(t)})}return e.prototype.initNodePages=function(e){if(!e)return o.reject();switch(this.nodesPerPage=e.nodesPerPage,this.rootIndex=e.rootIndex,e.lodSelectionMetricType){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=y}var t=p(this.rootIndex,this.nodesPerPage);return this.loadPage(t)},e.prototype.initNodeDocuments=function(e){this.nodesPerPage=0,this.rootIndex=0,this.nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode({id:e,mbs:null},-1)},e.prototype.loadPage=function(e){var t=this;this._loading.add(e);var r=this.layerUrl+"/nodepages/"+e;return this.streamDataController.request(r,"json").then(function(r){t._loading.delete(e),t.addPage(e,r)}).catch(function(r){return t._loading.delete(e),t._failedPages.add(e),o.reject(r)})},e.prototype.addPage=function(e,t){for(var r=this,i=this.nodePages.length;i<e;i++)this.nodePages[i]=null;var n=[],o=[],d=t.nodes.map(function(t,i){var d=n.length,u=t.children?t.children.length:0;o.push(-1);for(var c=0;c<u;c++)n.push(t.children[c]);var p=""+t.index,f=l.clone(t.obb),g=s.vec4f64.fromArray([f.center[0],f.center[1],f.center[2],a.vec3.length(f.halfSize)]),y=t.mesh&&t.mesh.attribute,_=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,m={hasSharedResource:!1,hasFeatureData:!!_,attributes:y&&null!=y.resource?""+y.resource:null,geometry:_&&null!=_.resource?""+_.resource:null,texture:v&&null!=v.resource&&v.texelCountHint>0?""+v.resource:null,geometryDefinition:_?_.definition:-1,materialDefinition:v?v.definition:-1},b={id:p,index:e*r.nodesPerPage+i,childCount:u,failed:!1,cacheState:0,obb:f,mbs:g,level:0,resources:m,lodMetric:r.lodMetric,maxError:r.lodConversion(t.lodThreshold),renderMbs:s.vec4f64.fromArray([0,0,0,-1]),renderObb:l.create([0,0,0],[-1,-1,-1],[0,0,0,1]),numFeatures:_?_.featureCount:null,vertexCount:_?_.vertexCount:null};return{childOffset:d,childCount:u,visibilityCache:h(r._visibilityCacheGeneration),ref:null,node:b}});this.nodePages[e]={nodes:d,children:n,parents:o},this.nodeCount+=d.length,this.updateParentsAndLevel()},e.prototype.updateParentsAndLevel=function(){var e=this,t=[],r=function(r,n,o){var a=e.getPage(r);if(i.isSome(a)){var s=f(r,e.nodesPerPage);a.parents[s]=n;var d=a.nodes[s].node;d&&(d.level=o,t.push(r))}};for(r(this.rootIndex,-1,0);t.length;)for(var n=t.pop(),o=this.getNode(n),a=0;a<o.childCount;a++){r(this.getChildIndex(o,a),n,o.level+1)}},e.prototype.getPage=function(e){return this.nodePages[p(e,this.nodesPerPage)]},e.prototype.getNodeInternal=function(e){var t=this.getPage(e);return i.isNone(t)?null:t.nodes[f(e,this.nodesPerPage)]},e.prototype.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);var r=this.getParent(t),n=r?r.level+1:1;this._maxLevel=Math.max(this._maxLevel,n);var o=g(e.lodSelection),a=o.lodMetric,d=o.maxError,u=i.expect(this.getNodeInternal(t));return u.node={id:e.id,index:t,mbs:s.vec4f64.fromArray(e.mbs),obb:e.obb&&l.clone(e.obb),childCount:u.childCount,level:n,resources:e.resources,version:e.version,lodMetric:a,maxError:d,memory:null,numFeatures:e.numFeatures,failed:!1,cacheState:0},null==u.ref.mbs&&(u.ref.mbs=e.mbs),u.node.renderMbs=u.ref.renderMbs,u.node.renderObb=u.ref.renderObb,u.node},e.prototype.makeRefNode=function(e,t){var r=this.nodePages[0],i=r.nodes.length;return r.nodes.push({childOffset:0,childCount:0,node:null,ref:e,visibilityCache:h(this._visibilityCacheGeneration)}),this.nodeCount++,r.parents.push(t),e.renderMbs=s.vec4f64.fromArray([0,0,0,-1]),e.renderObb=l.create([0,0,0],[-1,-1,-1],[0,0,0,1]),i},e.prototype.populateChildren=function(e,t){var r=i.expect(this.getNodeInternal(e)),n=i.expect(this.getPage(e));r.childOffset=n.children.length,r.childCount=t.length;for(var o=0;o<t.length;o++){var a=this.makeRefNode(t[o],e);n.children.push(a)}},e.prototype.getNode=function(e){var t=this.getNodeInternal(e);return i.isSome(t)&&t.node},e.prototype.getIndexById=function(e){var t;return this.forAllNodes(function(r,i){(r.node?r.node.id:r.ref.id)===e&&(t=i)}),t},e.prototype.getNodeById=function(e){var t=this.getIndexById(e),r=null!=t?this.getNodeInternal(t):null;return i.isSome(r)?r.node:null},e.prototype.getChildIndex=function(e,t){var r=this.getPage(e.index);if(i.isNone(r))return-1;var n=r.nodes[f(e.index,this.nodesPerPage)];return r.children[n.childOffset+t]},e.prototype.getParentIndex=function(e){var t=this.getPage(e);return i.isSome(t)?t.parents[f(e,this.nodesPerPage)]:-1},e.prototype.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},Object.defineProperty(e.prototype,"rootNode",{get:function(){var e=this.getNodeInternal(this.rootIndex);return i.isSome(e)?e.node:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0}),e.prototype.invalidateVisibilityCache=function(e){if(null!=e){var t=this.getNodeInternal(e);i.isSome(t)&&(t.visibilityCache=h(this._visibilityCacheGeneration))}else this._visibilityCacheGeneration=c(this._visibilityCacheGeneration)},e.prototype.isNodeVisible=function(e){var t=this.getNodeInternal(e);if(i.isNone(t)||t.ref&&!t.ref.mbs)return!0;if(!function(e,t){return(-2&e)===t}(t.visibilityCache,this._visibilityCacheGeneration)){var r=this.viewportQueries.isNodeVisible(t.ref||t.node);return t.visibilityCache=function(e,t){return t+(e?1:0)}(r,this._visibilityCacheGeneration),r}return function(e){return 1==(1&e)}(t.visibilityCache)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!!i.isNone(t)||!(t.node&&t.ref&&!t.ref.obb)||this.viewportQueries.isGeometryVisible(t.node)},Object.defineProperty(e.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e,t){var r=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),v.clear();var n=!0,o=new x,a=new x;this.traverseVisible(function(s,d){if(!d){var l=r.entryPriority(s),u=p(s,r.nodesPerPage);return v.set(u,Math.max(l,v.get(u)||0)),r._loading.has(u)||r._failedPages.has(u)||r._missing.push(u),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,l))}var h=d.node;if(r._updateNodeFeatureEstimate(h,a),!h){var c=r.entryPriority(s);return r._loading.has(s)||r._failedNodes.has(s)||(r._missing.push(s),v.set(s,c)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,c))}var f=i.expect(r.getPage(s));if(0===r._missing.length&&0===r.nodesPerPage)for(var g=0;g<d.childCount;g++){var y=f.children[d.childOffset+g],_=r.getNodeInternal(y);!i.isSome(_)||_.node||r._loading.has(y)||(v.set(y,r.entryPriority(y)),r._prefetch.push(y))}if(!h.failed&&h.resources.hasFeatureData)if(r._isLoaded(s)){if(o.known+=h.memory,++o.knownNodes,r._isSelected(h)?d.childCount>0&&(n=!1):(o.unremoved+=h.memory,n=!1),r._needsUpdate(h)){var m=r.entryPriority(s);v.set(s,m),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,m),r._updates.update.push(s)}}else if(h.memory&&(o.known+=h.memory,++o.knownNodes),r._isSelected(h)){if(d.childCount>0&&(n=!1),h.memory?(o.missing+=h.memory,o.known+=h.memory,++o.knownNodes):++o.missingNodes,e.indexOf(h.index)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(s)),void(r._updates.cancel=r._updates.cancel.filter(function(e){return e!==h.index}));if(!t.done&&r._enable(h))return void t.madeProgress();var b=r.entryPriority(s);v.set(s,b),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,b),r._updates.add.push(s)}}),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leafsReached=n,this._missing.sort(function(e,t){return e-t}),this._missing.filterInPlace(function(e,t){return t<1||r._missing.data[t-1]!==e}),this._missing.sort(function(e,t){return v.get(e)-v.get(t)}),this._missing.length>0?(this._maxUnloadedPrio=v.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(function(e,t){return v.get(e)-v.get(t)}),this._updates.add.filterInPlace(function(e){return v.get(e)>=r._maxUnloadedPrio}).sort(function(e,t){return v.get(e)-v.get(t)}),this._updates.update.sort(function(e,t){return v.get(e)-v.get(t)}),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,v.clear()}},e.prototype.checkFeatureTarget=function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,o=r,a=10;a--;){var s=new x;if(this._updateFeatureEstimate(i,s),this._computeFeatureEstimate(s)<=e){if(i>=t||s.missingNodes>0||0===a)break;o=i,i=.5*(i+n)}else n=i,i=.5*(i+o)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)},e.prototype._updateFeatureEstimate=function(e,t){var r=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,i){return r._updateNodeFeatureEstimate(i&&i.node,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){if(0===this._missing.length)return!1;e=Math.min(e,this._missing.length);for(var t=0;t<e;++t)0===this.nodesPerPage?this._loadNode(this._missing.pop()):this.loadPage(this._missing.pop());return!0},e.prototype.prefetch=function(e){if(0===this._prefetch.length)return!1;e=Math.min(e,this._prefetch.length);for(var t=0;t<e;++t)this._loadNode(this._prefetch.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loading.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.index];if(t&&t.version===this._version)return t;var r=this.viewportQueries.getLodLevel(e),i=this.viewportQueries.hasLOD(e),n=!0;if(i){var o=this.getParentIndex(e.index);if(o>=0){var a=this._nodeTraversalState[o];n=a&&r>a.lodLevel}else n=r>0}return t?(t.lodLevel=r,t.isChosen=n,t.version=this._version,t):(this._nodeTraversalState[e.index]={nodeHasLOD:i,lodLevel:r,isChosen:n,version:this._version},this._nodeTraversalState[e.index])},e.prototype._loadNode=function(e){var t=this;this._loading.add(e);var r=i.expect(this.getNodeInternal(e)).ref.id,n=this.layerUrl+"/nodes/"+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then(function(i){var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateVisibilityCache(e);var o=t.addNode(n,e);t.nodeTraversalState(o),a()}else a()},function(r){o.isAbortError(r)||(t.logger.error("Error loading node: "+n),t._failedNodes.add(e)),a()})},e.prototype._validateNode=function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error('Invalid node. Wrong type or wrong id "'+e+'"'),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+e+'"'),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+e+'"'),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(function(e,t){return e.href!=="./attributes/f_"+t+"/0"})||this.logger.warn('Invalid attribute data on node "'+e+'"'),t.featureData&&t.featureData.length>1&&this.logger.warn("Node "+e+" has "+t.featureData.length+" bundles. Only the first bundle will be loaded.");var i=t.hasOwnProperty("obb")&&!this.ignoreServiceOBB?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,o=Array.isArray(t.children)?t.children.map(function(t){if(null==t)return null;var i=function(t){return r.logger.error("Invalid node reference on node "+e+": "+t)};if("number"==typeof t.id)i("id "+t.id+" is a number instead of a string.");else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference "+t.id+"."),null;t.href&&t.href!=="../"+t.id&&r.logger.error('Invalid node href on node "'+e+'"');var n=t.hasOwnProperty("obb")&&!r.ignoreServiceOBB?t.obb:null;return{id:""+t.id,mbs:t.mbs,obb:n}}).filter(function(e){return null!=e}):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},e.prototype.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes(function(e){e.node&&(e.node.failed=!1)})},e.prototype.entryPriority=function(e){var t=this.getNodeInternal(e),r=this.getParentIndex(e);if(i.isNone(t)||r<0&&null==t.node)return r<0?1/0:this.entryPriority(r);var n=0;if(t.node&&r>=0){var o=this._nodeTraversalState[r];null!=o&&(n=o.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var d=this.viewportQueries.distToPOI(t.ref||t.node);return-d-n*(d+this.progressiveLoadPenalty)+a},e.prototype.traverseVisible=function(e){var t=this.getNodeInternal(this.rootIndex);i.isSome(t)?this._traverse(this.rootIndex,t,e):e(this.rootIndex,null)},e.prototype._traverse=function(e,t,r){if(t.node&&0===t.childCount)this.isGeometryVisible(e)&&r(e,t);else if(this.isNodeVisible(e)&&(r(e,t),null!=t.node)){var n=this.nodeTraversalState(t.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var o=i.expect(this.getPage(e)),a=0;a<t.childCount;a++){var s=o.children[t.childOffset+a],d=this.getNodeInternal(s);i.isSome(d)?this._traverse(s,d,r):r(s,null)}}},e.prototype.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},e.prototype.traverseChildren=function(e,t){var r=e.index,n=this.getNodeInternal(r);i.isSome(n)&&this._traverseChildren(r,n,t)},e.prototype._traverseChildren=function(e,t,r){var n=this.getPage(e);if(!i.isNone(n))for(var o=0;o<t.childCount;++o){var a=n.children[t.childOffset+o],s=this.getNodeInternal(a);i.isSome(s)&&s.node&&r(s.node)&&this._traverseChildren(a,s,r)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e.prototype.updateElevationInfo=function(e){this.forAllNodes(u),this.viewportQueries.updateElevationInfo(e)},e.prototype.invalidateBoundingVolumeCache=function(e){var t=this.getNodeInternal(e);i.isSome(t)&&u(t)},e.prototype.forAllNodes=function(e){for(var t=0;t<this.nodePages.length;t++){var r=this.nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}},enumerable:!0,configurable:!0}),e}();t.I3SIndex=_;var v=new Map,m=function(){function e(){this.update=new n({deallocator:null}),this.add=new n({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}(),b=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];t.selectErrorMetric=g;var x=function(){return function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}()}.apply(null,i))||(e.exports=n)},2507:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117)],void 0===(n=function(e,t,r){var i=function(){function e(e,t){this.layerView=e,this.lodGlobalDirtyChanged=t}return e.prototype.startNodeLoading=function(e,t,r,i,n,o,a){this._lodGlobalDirty=!1,this._maxLodLevel=a.maxLodLevel,this._index=o,this._nodeTraversalState=i,this._isNodeVisible=e,this._isGeometryVisible=t,this._isNodeInScaleBounds=r,this._removeNodes=n,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.shouldLoadNode=function(e){var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.lodSwapNodeLoaded=function(e){this.setLodGlobalDirty()},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._index&&!0===this._lodGlobalDirty},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(this.requiresLODGlobalHandling){var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));n.clear(),this._lodGlobalHandlingRecursion(this._index.rootNode,r),this._removeNodes(n,e),0===n.length&&(this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty)),n.clear()}},e.prototype._lodGlobalHandlingRecursion=function(e,t){if(null==e)return!1;var r=this._nodeTraversalState(e),i=this.isChosenMaxLOD(r),o=this.layerView.isNodeLoaded(e.index);if(o&&null!=this.layerView.updateNodeStatus&&this.layerView.updateNodeStatus(e.index,i?"leaf":"hole"),i&&o)return this._removeChildrenRecursive(e),!0;var a=!1;if(e.childCount>0){a=!0;for(var s=0;s<e.childCount;s++){var d=this._index.getChildIndex(e,s),l=this._index.getNode(d);l?this._isGeometryVisible(d)&&!this._lodGlobalHandlingRecursion(l,t)&&this._isNodeInScaleBounds(l)&&(a=!1):this._isNodeVisible(d)&&(a=!1)}}o&&!i&&(a||n.length<t)&&(n.push(e.index),o=!1);var u=!e.resources.hasFeatureData;return a||o||u},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,function(e){return n.push(e.index),!0})},e.prototype.childrenEmpty=function(e){var t=this,r=!0;return this._index.traverseChildren(e,function(e){return!(!r||!t._isNodeVisible(e.index)||t.layerView.isNodeLoaded(e.index)&&(r=!1,1))}),r},e.prototype._childrenRequireLoading=function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,function(e){if(!i||!t._isNodeVisible(e.index))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)}),i&&r},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),n=new r({deallocator:null});return i}.apply(null,i))||(e.exports=n)},2508:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(9),r(11),r(26),r(5),r(14),r(7),r(25),r(2247),r(2184),r(2182),r(22)],void 0===(n=function(e,t,r,i,n,o,a,s,d,l,u,h,c){function p(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=o.clone(e)).vertexAttributes.region,e}function f(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var o=0;o<i.length;o++)if(null==i[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=i[o];else if("draco"===i[o].compressedAttributes.encoding&&l.isSupported()&&!n("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=i[o],r;return r}function g(e,t){var r=[];return t&&t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture&&function(t){var i=a.isSome(e)&&e[t]&&e[t].formats;i&&r.push({id:""+t,encodings:i.map(function(e){var t=e.name,r=e.format;return{name:t,encoding:m[r]}})})}(t.pbrMetallicRoughness.baseColorTexture.textureSetDefinitionId),r}function y(e,t){var r,i=g(e,t),n=i[0]&&i[0].id,o=a.isSome(e)&&e[n]&&e[n].atlas,s="opaque"!==t.alphaMode,d=n?((r={})[n]={encoding:i[0].encodings.map(function(e){return e.encoding}),wrap:["none","none"],atlas:o,channels:s?"rgba":"rgb",images:[{id:n,size:0,href:i[0].encodings.map(function(e){return"../textures/"+e.name}),byteOffset:0,length:0}]},r):{},l=t.pbrMetallicRoughness,u=l&&l.baseColorFactor;return{textureDefinitions:d,materialDefinitions:{mat:{type:"standard",params:{diffuse:u?u.slice(0,3):[1,1,1],specular:[1,1,1,1],vertexRegions:o,doubleSided:t.doubleSided,cullFace:t.cullFace,transparency:u?1-u[3]:0,useVertexColorAlpha:s}}}}}function _(e){for(var t={},r=0,i=e;r<i.length;r++){var n=i[r];b[n]&&(t[b[n]]={valueType:null})}return{header:null,byteOffset:0,byteCount:0,vertexAttributes:t}}var v=function(){function e(e,t,r,i,n,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=n,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialTextures=e.materialDefinitions.map(function(e){return g(a,e)}),this.materialShared=e.materialDefinitions.map(function(e){return y(a,e)})}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(i,"binary",r).then(function(e){return u.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var i=this;return s.eachAlways(t.map(function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)})).then(function(r){for(var n={},o=0;o<t.length;++o)r[o].value?n[t[o].name]=r[o].value:s.isAbortError(r[o].error)||i.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'");return n})},e.prototype.loadNodeData=function(e,t){return i(this,void 0,void 0,function(){var i,n,o,a,d,l,h,c,g,y,v,m,b,x,D,w,N,P,C;return r(this,function(r){switch(r.label){case 0:return i=null!=this.requiredAttributes&&e.resources.attributes?this.loadAttributes(e,this.requiredAttributes,t):s.resolve({}),n=f(this.geometryDefinitions,e),o=n.bufferDefinition,a=n.bufferIndex,d=e.resources.geometry?this.loadGeometry(e,a,t):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return h=r.sent(),[3,3];case 2:h=this.materialShared&&e.resources.materialDefinition>=0?this.materialShared[e.resources.materialDefinition]:null,r.label=3;case 3:return l=h,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return g=r.sent(),[3,6];case 5:g=null,r.label=6;case 6:return c=g,y=this.options.loadFeatureData?this.collectGeometries(c):this.meshPyramidGeometryData(e,l),v=this.materialTextures&&e.resources.materialDefinition>=0?this.materialTextures[e.resources.materialDefinition]:this.getRequiredTexturesFromShared(y,l),m=this.options.loadTextureData?this.loadTextures(e,v,t):null,b=null,x=null,d?[4,d]:[3,8];case 7:b=r.sent(),D=p(this.defaultGeometrySchema,l),w=!(!o||!o.compressedAttributes||"draco"!==o.compressedAttributes.encoding),x=w?_(o.compressedAttributes.attributes):o?u.createGeometryIndexFromDefinition(o,e.vertexCount,e.numFeatures):u.createGeometryIndexFromSchema(b,D),r.label=8;case 8:return[4,m];case 9:return N=r.sent(),[4,i];case 10:return P=r.sent(),C=null,P&&(C={attributeData:P,loadedAttributes:this.requiredAttributes}),[2,{allGeometryData:y,attributeDataInfo:C,geometryBuffer:b,geometryIndex:x,sharedResource:l,requiredTextures:v,textureData:N}]}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=0,a=r[n[i]].images;o<a.length;o++){var s=a[o];Array.isArray(s.href)?s.hrefConcat=s.href.map(function(e){return d.makeAbsolute(e,t)}):s.hrefConcat=d.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var o;"data:"===(o=i.encoding[n]).substring(0,5)&&(i.encoding[n]=o.substring(5))}else"data:"===(o=i.encoding).substring(0,5)&&(i.encoding=o.substring(5))}},e.prototype.loadShared=function(t,r){var i=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(i,"json",r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t})},e.prototype.loadTexture=function(e,t,r,i,n){return i===h.DDS_ENCODING_STRING?this.load(e,"binary",n).then(function(e){return{i3sTexId:t,data:e,encoding:i}}):this.load(e,"image",n).then(function(e){var n=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),a=Math.ceil(e.height/2),s=document.createElement("canvas");s.width=o,s.height=a,s.getContext("2d").drawImage(e,0,0,o,a),n=s}return{i3sTexId:t,data:n,encoding:i}})},e.prototype.loadTextures=function(t,r,i){var n=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled;return s.all(r.map(function(e){var r=h.selectEncoding(e.encodings,o);if(null==r)return n.logger.error("No known encoding for texture found on node "+t.id),s.reject();var d=t.resources.texture||t.id,l=n.layerUrl+"/nodes/"+d+"/textures/"+r.name;return n.loadTexture(l,e.id,a,r.encoding,i)}))},e.prototype.getRequiredTexturesFromShared=function(e,t){for(var r=[],i=0;i<e.length;i++){var n=e[i].geometries;if(null!=n)for(var o=this,a=0,s=n;a<s.length;a++){!function(e){var i=e.params.textureID||"none";if("none"!==i){null!=t.textureDefinitions&&null!=t.textureDefinitions[i]||o.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+i);var n=t.textureDefinitions[i];if(c.assert(void 0!==n,"geometry wants unknown texture "+i),0===n.images.length)return"continue";var a=n.images.length-1,s=n.images[a],d=function(e){return e&&e.split("/").pop()},l=Array.isArray(n.encoding)?n.encoding.map(function(e,t){return{name:d(s.href[t]),encoding:e}}):[{name:d(s.href),encoding:n.encoding}];r.push({id:i,encodings:l})}}(s[a])}}return r},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:t&&t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,textureID:t&&t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,i=e.featureData;r<i.length;r++){var n=i[r],o=n.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var d=s[a];t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:[d]})}else null!=n.position&&t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(i,"binary",r)},e}(),m={jpg:"image/jpeg",png:"image/png",dds:"image/vnd-ms.dds","ktx-etc2":"image/ktx"},b={position:"position",normal:"normal",uv0:"uv0",uv1:"uv1",color:"color","uv-region":"region"};return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(v||(v={})),v}.apply(null,i))||(e.exports=n)},2509:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(7)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.requester=e,this.activeRequests=new Set}return e.prototype.request=function(e,t,n){var o=this,a=i.createAbortController();i.onAbortOrThrow(n,function(){return a.abort()}),n=r({},n,{signal:a.signal});var s=this.requester(e,t,n),d={response:s,abortController:a};return this.activeRequests.add(d),i.always(s,function(){return o.activeRequests.delete(d)}),s},e.prototype.cancelAll=function(){this.activeRequests.forEach(function(e){return e.abortController.abort()}),this.activeRequests.clear()},e}();t.I3SStreamDataController=n,t.default=n}.apply(null,i))||(e.exports=n)},2510:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(10),r(6),r(70),r(43),r(91),r(537),r(243),r(127),r(2182),r(41),r(2195),r(38)],void 0===(n=function(e,t,r,i,n,o,a,s,d,l,u,h,c,p){return function(){function e(e,t,r,n,o,s,d){void 0===d&&(d={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=n,this.elevationProvider=o,this.options=d,this.fp=h.frustum.create(),this._poi=i.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=i.vec3f64.create(),this._tmp2=i.vec3f64.create(),this._tmp3=i.vec3f64.create(),this._tmp0=i.vec3f64.create(),this.screenspaceErrorBias=d.screenspaceErrorBias||1,this.progressiveLoadFactor=d.progressiveLoadFactor||1,this.updateCamera(r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s.elevationInfo),this.tmpPoint=a.makeDehydratedPoint(0,0,0,e)}return e.prototype.updateElevationInfo=function(e){null!=e?(this._elevationContext=new s,this._elevationContext.featureExpressionInfoContext=d.createContext(d.extractExpressionInfo(e,!1)),this._elevationContext.mixinApi(e)):this._elevationContext=null},e.prototype.updateCamera=function(e){h.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},e.prototype.setPointOfInterest=function(e){r.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.updateExtent=function(e){this.extent=e},e.prototype.getRenderMbs=function(e){var t=e.renderMbs;return t||(t=o.vec4f64.fromValues(e.mbs[0],e.mbs[1],e.mbs[2],-1),e.renderMbs=t),t[3]<0&&(n.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=l.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.getRenderObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)&&e.renderObb){var t=e.renderObb;return t.halfSize[0]<0&&(c.set(e.obb,t),this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],t.center[2]=l.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.bufferToBuffer(t.center,this.indexSR,0,t.center,this.engineSR,0,1)),t}},e.prototype.isNodeVisible=function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.obb){var r=this.getRenderObb(e);return c.isVisible(r,this.fp)}return this.isMBSVisible(t)},e.prototype.isGeometryVisible=function(e){var t=this.getRenderObb(e);return!t||c.isVisible(t,this.fp)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==u.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return h.frustum.intersectsSphere(this.fp.planes,h.sphere.wrap(e[3],e))},e.prototype.screenSpaceDiameterMbs=function(e,t){var i=this.getRenderMbs(e),n=Math.sqrt(r.vec3.squaredDistance(i,this._camPos)),o=n-i[3];return this._updateMinMaxDistance(n),o<0?.5*Number.MAX_VALUE:t/o*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},e.prototype.calcCameraDistanceToCenter=function(e){var t=this.getRenderMbs(e),i=r.vec3.distance(t,this._camPos);return this._updateMinMaxDistance(i),i},e.prototype.calcAngleDependentLoD=function(e){var t=this.getRenderMbs(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/r.vec3.length(t)+i)/r.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return 0!==e.lodMetric},e.prototype.getDistancePlanarMode=function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],o=r*r+i*i,a=t[3];if(o<=a*a)return Math.abs(n);var s=Math.sqrt(o)-a;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var i=r.vec3.length(t),n=r.vec3.length(e)-i;r.vec3.scale(this._tmp0,e,r.vec3.dot(e,t)/r.vec3.squaredLength(e));var o=r.vec3.squaredDistance(t,this._tmp0),a=t[3];if(o<=a*a)return Math.abs(n);var s=r.vec3.scale(this._tmp0,t,1/i),d=i,l=a*a/2/d,u=r.vec3.scale(this._tmp1,s,d-l),h=e,c=r.vec3.subtract(this._tmp2,h,u),p=r.vec3.subtract(this._tmp2,c,r.vec3.scale(this._tmp3,s,r.vec3.dot(s,c))),f=r.vec3.add(this._tmp2,u,r.vec3.scale(this._tmp2,p,a/r.vec3.length(p))),g=r.vec3.distance(h,f);if(n>=2e5){var y=r.vec3.subtract(this._tmp1,h,f),_=r.vec3.dot(y,s)/r.vec3.length(y);_<.08&&(_=1e-4),g/=_}return g},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},e.prototype.getLodLevel=function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,o=i+r[3];return this._updateMinMaxDistance(o),e.maxError*t<=n;case 1:var a=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(e)),a<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.getRenderMbs(e);return r.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return r.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,i))||(e.exports=n)}}]);