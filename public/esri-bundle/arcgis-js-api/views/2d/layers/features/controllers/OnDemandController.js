// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/Set","../../../../../core/asyncUtils","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/Extent","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/executeTileQuery","../../../../../tasks/operations/query","../../../engine","./BaseController","../support/DataTile","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileQueue","../../../../support/OrderedQueueProcessor"],function(e,t,r,i,s,a,n,u,o,d,l,c,h,f,p,y,_,g,v,b,m,T,I,x,Q,S){Object.defineProperty(t,"__esModule",{value:!0});var F=c.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),E=l("esri-featurelayer-webgl"),C=l("esri-mobile"),q={maxDrillLevel:E&&"object"==typeof E&&null!=E.maxDrillLevel?E.maxDrillLevel:C?1:4,maxRecordCountFactor:E&&"object"==typeof E&&null!=E.maxRecordCountFactor?E.maxRecordCountFactor:C?1:3,enablePBFQuery:!E||"object"!=typeof E||null==E.enablePBFQuery||E.enablePBFQuery},w=new u.default,j=[],D=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._dataTileIndex=new T.default,t._editsQueue=new S.OrderedQueueProcessor({concurrency:1,process:function(e,r){return t._processEditsEvent(e,r)}}),t._featuresInFlight=new Map,t}return r(t,e),t.prototype.initialize=function(){var e=this;this._set("queryEngine",this._createQueryEngine()),this._set("featureStore",this.queryEngine.featureStore),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach(function(e){return e.done=!1}),this._fetchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t,e.queryInfo,r)}}),this._patchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t.dataTile,t.queryInfo,r)}}),this._updateQueue=new x.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._updateTile(t,r,i)}})},t.prototype.destroy=function(){this._fetchQueue.clear(),this._patchQueue.clear(),this._updateQueue.clear(),this._editsQueue.destroy(),this.queryEngine.destroy()},Object.defineProperty(t.prototype,"updating",{get:function(){return this._fetchQueue.updating||this._updateQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return n(this,void 0,void 0,function(){var r,i,s=this;return a(this,function(a){switch(a.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),i=e.availableFields.filter(function(e){return-1===s.availableFields.indexOf(e)}),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return a.sent(),t?r===this.renderer.getAttributeHash()?[3,3]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,5];case 2:a.sent(),a.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return a.sent(),this.refresh(),[2];case 5:return i.length?[4,this._handleAttributeChange(i)]:[3,7];case 6:a.sent(),a.label=7;case 7:return"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,9]:[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 8:a.sent(),this.featureStore.forEach(function(e){return s.attributeStore.setAttributeData(e.localId,e,s.geometryInfo,s.viewParams)}),a.label=9;case 9:return[4,this.attributeStore.updateFilters(this)];case 10:return a.sent(),[4,this.attributeStore.sendUpdates()];case 11:return a.sent(),[2]}})})},t.prototype.invalidate=function(){for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._updateQueue.push(r.id,Date.now())}},t.prototype.onEdits=function(e){var t=this;this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then(function(){0===t._editsQueue.length&&t._fetchQueue.resume()})},t.prototype.queryFeatures=function(e){return o.safeCast(this.queryEngine.executeQuery(e))},t.prototype.queryFeatureCount=function(e){return o.safeCast(this.queryEngine.executeQueryForCount(e))},t.prototype.queryObjectIds=function(e){return o.safeCast(this.queryEngine.executeQueryForIds(e))},t.prototype.queryExtent=function(e){return o.safeCast(this.queryEngine.executeQueryForExtent(e))},t.prototype.redraw=function(){this._updateQueue.pause(),this._manageTiles(this.tileStore.tiles),this._updateQueue.resume()},t.prototype.refresh=function(){this._queryInfoHash=Math.random().toString(),this.queryEngine&&this.queryEngine.destroy(),this.featureStore&&this.featureStore.clear(),this._set("queryEngine",this._createQueryEngine()),this._set("featureStore",this.queryEngine.featureStore),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach(function(e){return e.done=!1}),this._editsQueue.pause(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),this._updateQueue.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._editsQueue.resume(),this._updateQueue.resume()},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),this._fetchQueue.state=e,this._updateQueue.state=e,r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)}),this.attributeStore.sendUpdates())},t.prototype.onTileUpdate=function(e){this._manageTiles(e.added,e.removed)},t.prototype.onFeatureAdd=function(e){if(this._featuresInFlight.has(e.objectId)){var t=this._featuresInFlight.get(e.objectId).attributes;e.attributes=s({},t,e.attributes),this._featuresInFlight.delete(e.objectId)}e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype._handleAttributeChange=function(e){return n(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this._fetchChangedFields(e)];case 1:return t.sent(),[2]}})})},t.prototype._fetchChangedTileFields=function(e,t){return n(this,void 0,void 0,function(){var r,i;return a(this,function(s){return(r=this._dataTileIndex.get(e.id))?(i=!1,i?[2,this._fetchChangedTileFieldsPaged(r,t)]:[2,this._fetchChangedTileFieldsDrill(r,t)]):[2]})})},t.prototype._fetchChangedTileFieldsDrill=function(e,t,r){return void 0===r&&(r=0),n(this,void 0,void 0,function(){var i,n,u,o,d,l,c,f,p,y,_=this;return a(this,function(a){switch(a.label){case 0:return i=s({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField])}),e.returnExceeded=e.returnExceeded||r>=q.maxDrillLevel,n=e.key,u={key:n,dataTile:e,queryInfo:i},[4,this._patchQueue.push(u)];case 1:return o=a.sent(),o.exceededTransferLimit&&r<q.maxDrillLevel?(d=e.tile.createChildTiles(),l=d.map(function(t){var r=new m.default;return r.tile=t,r.displayTile=e.displayTile,r}),[4,h.all(l.map(function(e){return _._fetchChangedTileFieldsDrill(e,t,r+1)}))]):[3,3];case 2:return a.sent(),[2];case 3:for(c=0,f=o.features;c<f.length;c++)p=f[c],this.featureStore.has(p.objectId)?(y=this.featureStore.getFeature(p.objectId),y.attributes=s({},y.attributes,p.attributes)):this._featuresInFlight.set(p.objectId,p);return[2]}})})},t.prototype._fetchChangedTileFieldsPaged=function(e,t,r){return void 0===r&&(r=0),n(this,void 0,void 0,function(){var i,n,u,o,d,l,c,h,f,p,y;return a(this,function(a){switch(a.label){case 0:return i=this.service.capabilities.query.supportsMaxRecordCountFactor,n=this.service.tileMaxRecordCount,u=n*(i?1:q.maxRecordCountFactor),o=s({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField]),resultOffset:r*u,num:u}),e.returnExceeded=!0,d=e.key,l={key:d,dataTile:e,queryInfo:o},[4,this._patchQueue.push(l)];case 1:for(c=a.sent(),h=0,f=c.features;h<f.length;h++)p=f[h],this.featureStore.has(p.objectId)?(y=this.featureStore.getFeature(p.objectId),y.attributes=s({},y.attributes,p.attributes)):this._featuresInFlight.set(p.objectId,p);return c.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(e,t,r+1)]:[2]}})})},t.prototype._fetchChangedFields=function(e){return n(this,void 0,void 0,function(){var t,r,i=this;return a(this,function(s){switch(s.label){case 0:return t=this.tileStore.tiles,r=t.map(function(t){return i._fetchChangedTileFields(t,e)}),[4,h.all(r)];case 1:return s.sent(),[2]}})})},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,s=this._updateQueue,a="esriGeometryPoint"===this.service.geometryType,n=this,u=0,o=e;u<o.length;u++){var d=o[u];!function(e){var t=r.get(e.id);t?(t.displayTile=e,a?r.forEach(function(r){I.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):(t=new m.default,t.tile=e.clone(),t.displayTile=e,r.add(t)),n._processDataTile(t)}(d)}if(t)for(var l=0,c=t;l<c.length;l++){var d=c[l];w.add(d),s.abort(d.id)}r.forEach(function(e){w.has(e.displayTile)&&j.push(e)});for(var h=0,f=j;h<f.length;h++){var p=f[h];i.abort(p.id),r.delete(p)}j.length=0,w.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,s=this._dataTileIndex,a=this._fetchQueue,n=i.id,u=this._queryInfoHash,o=i.level-r.key.level>=q.maxDrillLevel;if(s.add(e),e.done||a.has(n)){if(e.queryInfoHash!==u||e.returnExceeded!==o)if(e.done)e.done=!1;else{if(!a.isOngoing(n))return e.queryInfoHash=u,void(e.returnExceeded=o);a.abort(n)}}else e.queryInfoHash=u,e.returnExceeded=o;if(e.done)return void this._invalidateTile(e.displayTile);a.has(n)||a.push(e).then(function(r){return t._handleResponse(e,r)}).catch(function(t){h.isAbortError(t)||F.error(new d("featurelayer-controller:tile-error","Encountered an error when handling tile response",t)),e.done=!0})},t.prototype._handleResponse=function(e,t){if(e.done=!0,y.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else for(var r=e.tile.createChildTiles(),i=0,s=r;i<s.length;i++){var a=s[i],n=new m.default;n.tile=a,n.displayTile=e.displayTile,this._processDataTile(n)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile),this.attributeStore.sendUpdates()},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach(function(t){I.isChildOf(t,e)&&j.push(t)});for(var t=0,r=j;t<r.length;t++){var i=r[t];this._fetchQueue.abort(i.id),this._dataTileIndex.delete(i)}j.length=0},t.prototype._fetchTile=function(e,t,r){return n(this,void 0,void 0,function(){var i,s,n,u,o,d,l,c,h,f=this;return a(this,function(a){return i=new p({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}),s="esriGeometryPoint"===this.service.geometryType?e.tile:e.displayTile,n=s.extent,u=s.resolution,o=e.returnExceeded,d=this._createQuery(i,n,u,t,q.maxRecordCountFactor,o),l=this.service.source,c=q.enablePBFQuery&&this.service.capabilities.query.supportsFormatPBF,h=r.signal,[2,c?g.executeQueryPBF(l,d,{type:"optimized"},{signal:h}).then(function(e){return e.data}):g.executeQuery(l,d,{signal:h}).then(function(e){return y.convertFromFeatureSet(e.data,f.service.objectIdField)})]})})},t.prototype._invalidateTile=function(e){for(var t=this._pixelBuffer,r=this._updateQueue,i=this.tileStore.intersections(e,t),s=0,a=i;s<a.length;s++){var n=a[s].tile;r.push(n.id,n.updateTimestamp)}},t.prototype._updateTile=function(e,t,r){var i=this,s=this.tileStore.get(e),a=this.queryInfo,n=a.returnCentroid,u=a.returnGeometry,o=this._pixelBuffer,d={pixelBuffer:o,returnGeometry:u,returnCentroid:n},l=_.executeTileQuery(this.queryEngine,s,d),c=l.features,f=l.objectIds,p={geometryType:this.service.geometryType,features:c,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:s.transform};return this._applyProcessing(p,r).then(function(e){var a=[],n=!0;return i._dataTileIndex.forEach(function(e){s.id!==e.id&&I.isChildOf(e,s)&&n&&!e.done&&(n=!1)}),n&&s&&s.objectIds.forEach(function(e){if(!f.has(e)){var t=i.attributeStore.getLocalId(e);a.push(t)}}),f.forEach(function(e){s.objectIds.add(e)}),s.updateTimestamp=t,i.attributeStore.sendUpdates(),i.processor.onTileData(s,{clear:!0,addOrUpdate:e.features,remove:a,transformParams:v.Utils.getTransformParams(e)},r).catch(function(e){h.isAbortError(e)||F.error("update-tile",e)})})},t.prototype._processEditsEvent=function(e,t){return n(this,void 0,void 0,function(){var r,i,n,u,o,d,l,c=this;return a(this,function(a){switch(a.label){case 0:return r=function(e){return e.objectId},i=e.addedFeatures.concat(e.updatedFeatures).map(r),n=e.deletedFeatures.map(r),u=this._createTempQueryEngine(),o=this._createObjectIdsQuery(i),i.length?[4,g.executeQuery(this.service.source,o)]:[3,2];case 1:d=a.sent().data,l=y.convertFromFeatureSet(d,this.service.objectIdField).features,this._dataTileIndex.addOrUpdateFeatures(l),u.featureStore.addMany(l),a.label=2;case 2:return this._dataTileIndex.deleteFeaturesById(n),this.attributeStore.sendUpdates(),this.tileStore.tiles.map(function(e){var r=_.executeTileQuery(u,e,s({},c.queryInfo,{pixelBuffer:c._pixelBuffer})).features,a=n.concat(i).map(function(e){return c.attributeStore.getLocalId(e)}),o={transform:e.transform,hasZ:!1,hasM:!1};return c.processor.onTileData(e,{addOrUpdate:r,remove:a,transformParams:o},{signal:t}).catch(function(e){h.isAbortError(e)||F.error("update-tile",e)})}),u.destroy(),[2]}})})},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery(this.queryInfo);return t.objectIds=e,t},i([f.property()],t.prototype,"_fetchQueue",void 0),i([f.property()],t.prototype,"_patchQueue",void 0),i([f.property()],t.prototype,"_updateQueue",void 0),i([f.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([f.property({readOnly:!0})],t.prototype,"featureStore",void 0),i([f.property({dependsOn:["_fetchQueue.updating","_updateQueue.updating"]})],t.prototype,"updating",null),t=i([f.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],t)}(f.declared(b.default));t.default=D});