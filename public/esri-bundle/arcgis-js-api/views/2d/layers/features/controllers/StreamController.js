// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Map","../../../../../core/asyncUtils","../../../../../core/has","../../../../../core/maybe","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/executeTileQuery","../../../../../layers/graphics/data/StreamStore","../../../../../layers/graphics/sources/connections/GeoEventConnection","./BaseController","./support/DispatchQueue"],function(e,t,r,i,n,o,s,a,u,c,p,h,d,l,y,f,v,m,g){Object.defineProperty(t,"__esModule",{value:!0});var _=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="stream",t._tileDispatchMap=new u.default,t._updateIntervalId=0,t}return r(t,e),t.prototype.initialize=function(){var e=this,t=["connectionStatus","errorString"],r=this.service,i=r.source,n=r.objectIdField,o=r.timeInfo,s=r.maximumTrackPoints,a=r.purgeOptions,u=r.serviceFilter;this.connection=new v.default(i,this.spatialReference,u),this._set("store",new f.default(n,o,this.geometryInfo,s,a)),this.connection.on("feature",function(t){return e._onFeature(t)}),this.store.events.on("update",function(t){var r=t.addOrUpdated,i=t.removed;return e._onUpdate(r,i)}),t.forEach(function(t){e.watch("connection."+t,function(r){return e.remoteClient.invoke("setProperty",{propertyName:t,value:r})})}),this._updateIntervalId=setInterval(function(){return e.store.checkForUpdates()},64),this._set("queryEngine",this._createQueryEngine(this.store)),this._shouldPushDataReceived=this.service.enableDataRecieved},t.prototype.destroy=function(){clearInterval(this._updateIntervalId),this.connection.destroy(),this.queryEngine.destroy(),this._tileDispatchMap.forEach(function(e){return e.destroy()})},Object.defineProperty(t.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return s(this,void 0,void 0,function(){var r,i,n=this;return o(this,function(o){switch(o.label){case 0:return this.validateConfig(e,t),r=this.renderer.getAttributeHash(),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return o.sent(),"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,3]:(i=this.queryEngine.featureStore,[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]);case 2:o.sent(),i.forEach(function(e){return n.attributeStore.setAttributeData(e.localId,e,n.geometryInfo,n.viewParams)}),o.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return o.sent(),[4,this.attributeStore.sendUpdates()];case 5:return o.sent(),[2]}})})},t.prototype.invalidate=function(){this._repushActiveTiles()},t.prototype.onEdits=function(e){},t.prototype.queryFeatures=function(e){return c.safeCast(this.queryEngine.executeQuery(e))},t.prototype.queryFeatureCount=function(e){return c.safeCast(this.queryEngine.executeQueryForCount(e))},t.prototype.queryObjectIds=function(e){return c.safeCast(this.queryEngine.executeQueryForIds(e))},t.prototype.queryExtent=function(e){return c.safeCast(this.queryEngine.executeQueryForExtent(e))},t.prototype.queryLatestObservations=function(e){return c.safeCast(this.queryEngine.executeQueryForLatestObservations(e))},t.prototype.redraw=function(){},t.prototype.refresh=function(){},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)}),this.attributeStore.sendUpdates())},t.prototype.onTileUpdate=function(e){var t=this,r=e.added;e.removed.forEach(function(e){return t._handleTileRemove(e)}),r.forEach(function(e){return t._handleTileAdd(e)})},t.prototype.enableEvent=function(e){"data-received"===e.name&&(this._shouldPushDataReceived=e.value)},t.prototype._onFeature=function(e){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}});try{var t=this.geometryInfo,r=t.geometryType,i=t.hasM,n=t.hasZ,o=l.convertFromFeature(e,r,n,i,this.store.objectIdField);this.store.add(o)}catch(e){p("esri-2d-debug")&&console.debug(e)}},t.prototype._createStoreWithFeatures=function(e){if(h.isNone(e))return null;var t=this._createFeatureStore(!1);return t.addMany(e),t},t.prototype._onUpdate=function(e,t){var r=this;h.isSome(e)&&e.forEach(function(e){return r.onFeatureAdd(e)});var i=this._createStoreWithFeatures(e),n=this._createStoreWithFeatures(t);this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?this._updateActiveTiles(i,n):this._repushActiveTiles(),h.isSome(t)&&t.forEach(function(e){return r.onFeatureRemove(e)})},t.prototype._handleTileAdd=function(e){if(this._tileDispatchMap.has(e.id)){var t=this._tileDispatchMap.get(e.id);t.up()}else{var t=new g.default;this._tileDispatchMap.set(e.id,t)}this._queryTileFeatures(e,!0,this.queryEngine)},t.prototype._handleTileRemove=function(e){this._tileDispatchMap.get(e.id).destroy(),this._tileDispatchMap.delete(e.id)},t.prototype._anyUpdatesQueued=function(){return a.from(this._tileDispatchMap).some(function(e){e[0];return e[1].hasAction()})},t.prototype._updateActiveTiles=function(e,t){for(var r=this,i=h.applySome(e,function(e){return r._createQueryEngine(e)}),n=h.applySome(t,function(e){return r._createQueryEngine(e)}),o=0,s=this.tileStore.tiles;o<s.length;o++){var a=s[o];this._queryTileFeatures(a,!1,i,n)}},t.prototype._repushActiveTiles=function(){for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._queryTileFeatures(r,!0,this.queryEngine)}},t.prototype._queryTileFeatures=function(e,t,r,i){var n=this,o={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}},s=this.queryInfo,a=s.returnCentroid,u=s.returnGeometry,c=this._pixelBuffer,p={returnCentroid:a,returnGeometry:u,pixelBuffer:c},d=this._tileDispatchMap.get(e.id),l=h.applySome(r,function(t){return y.executeTileQuery(t,e,p)}),f=h.mapOr(l,[],function(e){return e.features}),v=h.mapOr(i,[],function(t){return y.executeTileQueryForIds(t,e,p)}).map(function(e){return n.attributeStore.getLocalId(e)}),m=function(r){return n.processor.onTileData(e,{addOrUpdate:f,remove:v,clear:t,transformParams:o},{signal:r})};d.enqueue(m)},i([d.property()],t.prototype,"connection",void 0),i([d.property()],t.prototype,"service",void 0),i([d.property({readOnly:!0})],t.prototype,"store",void 0),i([d.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([d.property()],t.prototype,"updating",null),t=i([d.subclass("esri.views.2d.layers.features.controllers.StreamController")],t)}(d.declared(m.default));t.default=_});