// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Accessor","../../../../../core/Error","../../../../../core/HandleOwner","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/data/attributeSupport","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FeatureProcessing","../../../../../layers/support/FieldsIndex","../../../../../renderers/support/jsonUtils","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","../../../engine","../support/AttributeStore","../support/pixelBuffering"],function(e,t,r,i,n,o,s,a,l,u,p,c,d,f,y,h,g,m,v,b,S,w,O,F,I,P){function x(e){var t=e&&e.getSymbols();return"backgroundFillSymbol"in e&&null!=e.backgroundFillSymbol||t.some(function(e){return"simple-fill"===e.type||"picture-fill"===e.type})}function _(e,t,r){function i(e){if(!e)return!1;var t=e.type;return"simple-marker"===t||"picture-marker"===t||"text"===t||"web-style"===t}if("esriGeometryPolygon"===t&&e.labelingInfo)return!0;if("esriGeometryPolygon"!==t)return!1;switch(r.type){case"simple":return i(r.symbol);case"unique-value":return i(r.defaultSymbol)||r.uniqueValueInfos.some(function(e){return i(e.symbol)});case"class-breaks":return i(r.defaultSymbol)||r.classBreakInfos.some(function(e){return i(e.symbol)});default:return!0}}function C(e,t){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryMultipoint":return!0;case"esriGeometryPolygon":return x(t);default:return j.error(new l("mapview-invalid-type",e+" is not supported")),!1}}Object.defineProperty(t,"__esModule",{value:!0});var j=c.getLogger("esri.views.2d.layers.features.controllers.BaseController");t.needsGeometry=C;var R=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._processingInMainThread=!1,t._availableFields=[],t._pixelBuffer=0,t.config=null,t.processor=null,t.remoteClient=null,t.service=null,t.tileStore=null,t.filters=new Array(F.definitions.MAX_FILTERS),t}return o(t,e),t.prototype.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])},t.prototype.startup=function(){return n(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return this._initAttributeStore(),[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 1:return e.sent(),[4,f.all([this.attributeStore.updateFilters(this),this.updatePixelBuffer()])];case 2:return e.sent(),[2]}})})},t.prototype.destroy=function(){this.attributeStore.destroy()},Object.defineProperty(t.prototype,"arcadeInfo",{get:function(){return{geometryType:this.service.geometryType,fields:this.service.fields,spatialReference:this.spatialReference}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fieldsIndex",{get:function(){return new b(this.service.fields)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryInfo",{get:function(){return{geometryType:this.service.geometryType,hasZ:!1,hasM:!1}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"returnCentroid",{get:function(){return this._get("returnCentroid")||_(this.config,this.service.geometryType,this.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"queryInfo",{get:function(){var e=null;if("heatmap"!==this.renderer.type){var t=this.renderer.visualVariables;t&&t.some(function(t){if("size"===t.type&&t.field&&!t.normalizationField)return e=[t.field+" DESC"],!0})}return{returnCentroid:this.returnCentroid,returnGeometry:!0,outFields:this.availableFields,orderByFields:e,definitionExpression:this.config.definitionExpression,gdbVersion:this.config.gdbVersion,historicMoment:this.config.historicMoment}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.config?S.fromJSON(this.config.renderer):(j.error("mapview-controller","Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"processing",{get:function(){return v.fromWorker(this.config.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=this,t=this.config.availableFields.filter(function(t){return-1===e._availableFields.indexOf(t)});return this._availableFields=this._availableFields.concat(t),this._availableFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.tileStore.tileScheme.spatialReference},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewParams",{get:function(){return{viewingMode:"",scale:this.viewState&&this.viewState.scale||1}},enumerable:!0,configurable:!0}),t.prototype.getObjectId=function(e){return this.attributeStore.getFeatureId(e)},t.prototype.getLocalId=function(e){return this.attributeStore.getLocalId(e)},t.prototype.mapValidLocalIds=function(e){var t=this;return e.map(function(e){return t.attributeStore.getLocalId(e)}).filter(function(e){return null!=e})},t.prototype.setViewState=function(e){this._set("viewState",e)},t.prototype.updatePixelBuffer=function(){return n(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,P.computePxBuffer(this.renderer,this.service.geometryType)];case 1:return e=t.sent(),this._pixelBuffer=Math.max(this._pixelBuffer,e),[2]}})})},t.prototype.validateConfig=function(e,t){for(var r=0,i=e.filters;r<i.length;r++){var n=i[r];if(d.isSome(n)&&n.where)try{h.validateWhere(this.fieldsIndex,n.where)}catch(e){throw new l("mapview-bad-filter",e.message,{filter:n,missingFields:e.details})}}},t.prototype.onFeatureAdd=function(e){e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype.onFeatureRemove=function(e){!e.localId&&p("esri-2d-debug")&&console.debug("Feature must have localId"),this.attributeStore.freeLocalId(e.objectId)},t.prototype.enableEvent=function(e){},t.prototype._initAttributeStore=function(){var e=this;this.attributeStore=new I.default(s({type:"remote"},"heatmap"===this.renderer.type?{initialize:function(e,t){return f.resolve()},update:function(e,t){return f.resolve()},render:function(){return f.resolve()}}:{initialize:function(t,r){return e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r})},update:function(t,r){return e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r})},render:function(){return e.remoteClient.invoke("tileRenderer.featuresView.requestRender")}}))},t.prototype._createQueryEngine=function(e){void 0===e&&(e=this._createFeatureStore());var t=this.queryInfo,r=t.definitionExpression,i=t.gdbVersion,n=t.historicMoment;return new m.default({definitionExpression:r,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,gdbVersion:i,historicMoment:null!=n&&new Date(n),featureStore:e,timeInfo:this.service.timeInfo})},t.prototype._createTempQueryEngine=function(e){return void 0===e&&(e=this._createFeatureStore(!1)),this._createQueryEngine(e)},t.prototype._createFeatureStore=function(e){void 0===e&&(e=!0);var t={geometryType:this.service.geometryType,hasM:!1,hasZ:!1};if(e){var r=this.onFeatureAdd.bind(this),i=this.onFeatureRemove.bind(this);return new g.default(t,r,i)}return new g.default(t)},t.prototype._createDefaultQuery=function(e){var t=this,r=new O;r.outSpatialReference=this.spatialReference;var i=e.outFields,n=e.orderByFields,o=this.config,s=o.gdbVersion,a=o.historicMoment,l=o.definitionExpression;return this.processing&&(i=i&&i.filter(function(e){return!t.processing.getField(e)}),n=n&&n.filter(function(e){return!t.processing.getField(e)})),i=i.length/this.service.fields.length>=.75?["*"]:i,r.gdbVersion=s,r.historicMoment=null!=a?new Date(a):null,r.outFields=i,r.where=l||"1=1",r.returnGeometry=e.returnGeometry,r.returnCentroid=e.returnCentroid,r.orderByFields=n,r.start=e.resultOffset,r.num=e.num,r},t.prototype._createQuery=function(e,t,r,i,n,o){var s=this.service.geometryType,a=this._createDefaultQuery(i);return a.maxRecordCountFactor=n,a.returnExceededLimitFeatures=o,a.resultType="tile",a.geometry=e,this.service.capabilities.query.supportsQuantization?(a.quantizationParameters=new w.default({mode:"view",originPosition:"upper-left",tolerance:r,extent:t}),"esriGeometryPolyline"===s&&(a.maxAllowableOffset=r)):"esriGeometryPolyline"!==s&&"esriGeometryPolygon"!==s||(a.maxAllowableOffset=r),a},t.prototype._applyProcessing=function(e,t){var r=this.processing;if(!r)return f.resolve(e);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:e},t);try{var i=r.process(e,r.options);return i?"then"in i?i:f.resolve(i):f.reject(new l("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(r){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:e},t)}},t.prototype.hasGeometryFilter=function(){return this.filters.some(function(e){return d.isSome(e)&&!!e.geometry})},r([y.property({readOnly:!0,dependsOn:["config","service","spatialReference"]})],t.prototype,"arcadeInfo",null),r([y.property()],t.prototype,"config",void 0),r([y.property({readOnly:!0,dependsOn:["service"]})],t.prototype,"fieldsIndex",null),r([y.property({readOnly:!0,dependsOn:["service"]})],t.prototype,"geometryInfo",null),r([y.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"returnCentroid",null),r([y.property({readOnly:!0,dependsOn:["config","availableFields"]})],t.prototype,"queryInfo",null),r([y.property({dependsOn:["config"],readOnly:!0})],t.prototype,"renderer",null),r([y.property()],t.prototype,"processor",void 0),r([y.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"processing",null),r([y.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"availableFields",null),r([y.property({constructOnly:!0})],t.prototype,"remoteClient",void 0),r([y.property({constructOnly:!0})],t.prototype,"service",void 0),r([y.property({dependsOn:["tileStore"]})],t.prototype,"spatialReference",null),r([y.property({constructOnly:!0})],t.prototype,"tileInfo",void 0),r([y.property({constructOnly:!0})],t.prototype,"tileStore",void 0),r([y.property()],t.prototype,"filters",void 0),r([y.property({readOnly:!0})],t.prototype,"viewState",void 0),r([y.property({readOnly:!0,dependsOn:["viewState"]})],t.prototype,"viewParams",null),t=r([y.subclass("esri.views.2d.layers.features.controllers.BaseController")],t)}(y.declared(a,u));t.default=R});