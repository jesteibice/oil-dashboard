// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/asyncUtils","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/MapPool","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../layers/support/labelFormatUtils","../../../../../renderers/support/jsonUtils","../../../engine","../../../arcade/utils","./BaseProcessor"],function(e,t,r,n,o,i,s,a,l,c,u,p,f,d,h,y,g,m,b,v,S,_){function I(e,t,r){r.has(e)||r.set(e,new Set);for(var n=r.get(e),o=t.length,i=0;i<o;i++){var s=t.charCodeAt(i);n.add(s)}}Object.defineProperty(t,"__esModule",{value:!0});var O=u.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor"),w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._symbolToMosaicItemMap=new Map,t._visualSetPromises=new Map,t.type="symbol",t}return r(t,e),t.prototype.destroy=function(){this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(t.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelingInfo",{get:function(){return!this.config||f.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map(function(e){return g.fromJSON(e)})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelClassInfos",{get:function(){var e=this;return this.labelingInfo?d.all(this.labelingInfo.map(function(t,r){return s(e,void 0,void 0,function(){var e;return i(this,function(n){switch(n.label){case 0:return e={index:r,minScale:t.minScale,maxScale:t.maxScale},[4,m.createLabelFunction(t,this.fields,this.spatialReference)];case 1:return[2,(e.builder=n.sent(),e.symbol=t.symbol,e)]}})})})):d.resolve()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hydrate",{get:function(){return S.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"factory",{get:function(){var e=this;if(!this.config)return O.error(new l("mapview-processor","Unable to create factory without a configuration")),null;var t=this.service,r=t.geometryType,n=t.objectIdField,o=t.fields,i=function(t,r){return e.remoteClient.invoke("tileRenderer.getMaterialItems",t,r)},s=y.fromJSON(this.spatialReference),a={geometryType:r,fields:o,spatialReference:s},c=new v.WGLTemplateStore(i),u=this.tileStore.tileScheme.tileInfo;return this._matcher=v.createMatcher(this.renderer,c,a),new v.WGLMeshFactory(r,n,this.renderer,c,this.labelingInfo,u)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.config?b.fromJSON(this.config.renderer):(c("esri-2d-debug")&&console.debug("Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fields",{get:function(){return this.service.fields},enumerable:!0,configurable:!0}),t.prototype.update=function(e){return s(this,void 0,void 0,function(){return i(this,function(t){return this._set("config",e),[2]})})},t.prototype.onTileData=function(e,t,r){var n,o=this,i=t.addOrUpdate,s=t.remove,a=t.clear;n=i&&i.length?this._processFeatures(e,i,t.transformParams):d.resolve();var l=r.signal,c=n.then(function(t){var r=t&&t.message||null,n=t&&t.transferList||null;return o.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{addOrUpdate:r,remove:s,clear:a}},{transferList:n,signal:l})}).catch(function(t){return o._handleError(e,t,r)});return this._visualSetPromises.set(e,c),d.always(c,function(){return o._cleanPromise(e)}),this.notifyChange("updating"),c},t.prototype.onTileError=function(e,t,r){var n=this,o=r.signal,i=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t},{signal:o});return this._visualSetPromises.set(e,i),d.always(i,function(){return n._cleanPromise(e)}),this.notifyChange("updating"),i},t.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},t.prototype._processFeatures=function(e,t,r){var n=this;if(!t||!t.length)return d.resolve(null);var o=this.factory,i={viewingMode:"",scale:e.scale};return a.safeCast(this._matcher.then(function(e){return o.analyze(t,e,r,i)})).then(function(t){return a.safeCast(n._getLabelMosaicItems(e,t,r)).then(function(i){return n._writeFeatures(e,t,r,i,o)})})},t.prototype._writeFeatures=function(e,t,r,n,o){for(var i=o.createMeshData(t.length),s={viewingMode:"",scale:e.scale},a=this._symbolToMosaicItemMap,l=0,c=t;l<c.length;l++){var u=c[l];o.write(i,u,r,s,e.level,n,a)}return this._encodeDisplayData(i)},t.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),{message:t,transferList:r}},t.prototype._handleError=function(e,t,r){var n=r.signal;if(!d.isAbortError(t))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t.message},{signal:n})},t.prototype._getLabelMosaicItems=function(e,t,r){return s(this,void 0,void 0,function(){var n,o,s,a,l,c;return i(this,function(i){switch(i.label){case 0:return n=p.acquire(),[4,this._createLabelFeatures(e.scale,t,n,r)];case 1:return o=i.sent(),(s=this._symbolToMosaicItemMap,a=p.acquire(),l=[],c=0,n.forEach(function(e,t){if(s.has(t.id)){var r=s.get(t.id),n=r.glyphMosaicItems,o=[];e.forEach(function(e){(n&&n.length<e||!n[e])&&(o[e]=e)}),o.length>0&&(a.set(c,t),l.push({symbol:t.toJSON(),id:c,glyphIds:o}),c++)}else{a.set(c,t);var i=[];e.forEach(function(e){return i.push(e)}),l.push({symbol:t.toJSON(),id:c,glyphIds:i}),c++}}),l.length>0)?[2,this.remoteClient.invoke("tileRenderer.getMaterialItems",l).then(function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t],i=a.get(n.id);if(i)if(v.Utils.isTextSymbol(i))if(s.has(i.id)){var l=s.get(i.id),c=l.glyphMosaicItems,u=n.mosaicItem.glyphMosaicItems;if(u)for(var f=0;f<u.length;f++)null!=u[f]&&(c[f]=u[f])}else s.set(i.id,n.mosaicItem);else s.set(i.id,n.mosaicItem)}return p.release(a),o})]:(p.release(n),[2,d.resolve(o)])}})})},t.prototype._getLabelClassInfosForScale=function(e){return s(this,void 0,void 0,function(){var t;return i(this,function(r){switch(r.label){case 0:return[4,this.labelClassInfos];case 1:return t=r.sent(),[2,t.filter(function(t){var r=t.minScale,n=t.maxScale;return(!r||r>=e||0===r)&&(!n||n<=e||0===n)})]}})})},t.prototype._createLabelFeatures=function(e,t,r,n){return s(this,void 0,void 0,function(){var s,a,l,c,u,d,h,g,m,b,S,_,w,P,M,C,T,L,E,R,x,F,U,j,N,D,G,J,k;return i(this,function(i){switch(i.label){case 0:return this.labelingInfo&&t&&0!==t.length?[4,this._getLabelClassInfosForScale(e)]:[2,null];case 1:if(s=i.sent(),0===s.length)return[2,null];for(a=p.acquire(),l=new v.CollisionGrid(v.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE),c=0,u=t;c<u.length;c++)if(d=u[c],h=this.service.geometryType,g=0,m=0,"esriGeometryPoint"!==h&&"esriGeometryPolygon"!==h||("esriGeometryPoint"===h?(b=d.geometry,g=b.x,m=b.y):(g=d.centroid.x,m=d.centroid.y),!(S=l.checkOverlap(g,m)))){for(_=d.localId,w=new Array,P=0;P<s.length;P++){if(M=s[P],C=M.index,T=M.builder,L=M.symbol,E=d,!n)return O.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found"),[2];R=n.transform,x=n.hasZ,F=n.hasM,U=this.hydrate(d.geometry,R,x,F),j=o({},d,{geometry:U}),U.spatialReference=y.fromJSON(this.spatialReference),E=j,N=T.evaluate(E),f.isNone(N)||(v.definitions.DEBUG_LABELS&&(D="-"+_,N=N.substring(0,N.length-D.length)+D),G=v.bidiText(N),J=G[0],k=G[1],I(L,J,r),w.push({text:J,rtl:k,id:C}))}a.set(_,w)}return[2,a]}})})},n([h.property({readOnly:!0})],t.prototype,"supportsTileUpdates",null),n([h.property()],t.prototype,"config",void 0),n([h.property({dependsOn:["config"]})],t.prototype,"labelingInfo",null),n([h.property({dependsOn:["labelingInfo","fields","spatialReference"]})],t.prototype,"labelClassInfos",null),n([h.property({dependsOn:["service"]})],t.prototype,"hydrate",null),n([h.property({dependsOn:["config","service","renderer","fields","tileStore"]})],t.prototype,"factory",null),n([h.property({dependsOn:["config"],readOnly:!0})],t.prototype,"renderer",null),n([h.property({readOnly:!0})],t.prototype,"updating",null),n([h.property({dependsOn:["service"]})],t.prototype,"fields",null),t=n([h.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],t)}(h.declared(_.default));t.default=w});