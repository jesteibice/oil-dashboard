// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/assignHelper","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../../../core/promiseUtils","../../../../../../geometry/Point","../../../../engine"],function(e,t,i,r,n,a,s,o,l,h,u){Object.defineProperty(t,"__esModule",{value:!0});var d=u.enums.WGLDrawPhase,c=function(e){function t(t){var i=e.call(this)||this;return i._rendererInfo=new u.WGLRendererInfo,i._pointToCallbacks=new Map,i._displayWidth=0,i._displayHeight=0,i.layer=null,i.tileInfoView=t.tileInfoView,i.layer=t.layer,i._layerView=t.layerView,i.attributeView=new u.AttributeStoreView,i}return r(t,e),t.prototype.dispose=function(){this.removeAllChildren();for(var e=0,t=this.children;e<t.length;e++){t[e].dispose()}this.attributeView.destroy()},t.prototype.disposeWebGLResources=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].clear()}},t.prototype.displayWidth=function(){return this._displayWidth},Object.defineProperty(t.prototype,"displayHeight",{get:function(){return this._displayHeight},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},set:function(e){this._visualVariablesInfo=e,this.requestRender()},enumerable:!0,configurable:!0}),t.prototype.hitTest=function(e,t){var i=this,r=[e,t];return o.create(function(e,t){i._pointToCallbacks.set(r,{resolve:e,reject:t}),i.requestRender()},function(){i._pointToCallbacks.has(r)&&i._pointToCallbacks.delete(r)})},t.prototype.whenAttached=function(){var e=this;return this.attached?o.resolve():o.create(function(t){return e.once("attached",function(){return t()})})},t.prototype.getMaterialItems=function(e){var t=this;return this.whenAttached().then(function(){var i=e;if(t.stage&&i&&0!==i.length){for(var r=[],n=t.stage.painter.textureManager,a=0,s=i;a<s.length;a++){var o=s[a];r.push(n.rasterizeItem(o.symbol,o.glyphIds))}return l.all(r).then(function(t){return t.map(function(t,i){return{id:e[i].id,mosaicItem:t}})})}})},t.prototype.onTileData=function(e,t){return a(this,void 0,void 0,function(){var r,a,s,o;return n(this,function(n){switch(n.label){case 0:return r=!(!this.layer.labelingInfo||!this.layer.labelingInfo.length),a=t.addOrUpdate&&u.TileData.decode(t.addOrUpdate),s=i({},t,{addOrUpdate:a}),[4,this._layerView.getLocalIdsToHighlight()];case 1:return o=n.sent(),e.setData(s,r,this.layer.labelsVisible),e.buildHLList(o),this.contains(e)||this.addChild(e),this.requestRender(),this._layerView&&this._layerView.view.labelManager.requestUpdate(),[2]}})})},t.prototype.onTileError=function(e){e.clear(),this.contains(e)||this.addChild(e),this.requestRender()},t.prototype.addChild=function(t){var i=e.prototype.addChild.call(this,t);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.addTile(this._layerView,t),this._buildHLList(),i},t.prototype.removeChild=function(t){var i=e.prototype.removeChild.call(this,t);return this.layer.labelingInfo&&this._layerView&&this._layerView.view.labelManager.removeTile(this._layerView,t.key.id),this._buildHLList(),i},t.prototype.renderChildren=function(e){var t=this,r=e.state,n=this.stage.painter,a=this._visualVariablesInfo&&this._visualVariablesInfo.vvRanges;this._updateTilesTransform(r,this.tileInfoView.getClosestInfoForScale(r.scale).level),this._rendererInfo.update(r,this.layer.renderer,a,this._layerView.effects),this.attributeView.update(this.stage.context),this.attributeView.bindTextures(this.stage.context);var o=this.tileInfoView.getClosestInfoForScale(r.scale).level,l=this.tileInfoView.tileInfo.scaleToZoom(r.scale),h=i({},e,{rendererInfo:this._rendererInfo,requiredLevel:o,displayLevel:l,context:this.stage.context,painter:this.stage.painter,attributeView:this.attributeView});this.sortChildren(function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col});var u=h.drawPhase;if(u&(d.LABEL|d.LABEL_ALPHA)){var c=this.layer;if(!(c.labelsVisible&&c.labelingInfo&&c.labelingInfo.length>0))return;this._updateTilesTransform(h.state,h.requiredLevel)}n.draw(h,this.children,u,this._painterOptions),this._layerView.hasHighlight()&&n.highlight(h,this.children),this._pointToCallbacks.forEach(function(e,i){e.resolve(t._hitTest(h,i[0],i[1]))}),this._pointToCallbacks.clear(),this._layerView.effects&&this._layerView.effects.some(function(e){return s.isSome(e)&&!e.done})&&this.requestRender()},t.prototype.updateHighlight=function(){this._buildHLList()},t.prototype._hitTest=function(e,t,i){var r=this.stage,n=r.painter,a=r.context,s=e.requiredLevel,o=[0,0];e.state.toMap(o,[t,i]);var l=e.state.clone(),c=l.viewpoint.clone();return c.targetGeometry=new h(o[0],o[1],e.state.spatialReference),l.viewpoint=c,l.size=[u.Utils.C_HITTEST_SEARCH_SIZE,u.Utils.C_HITTEST_SEARCH_SIZE],this._updateTilesTransform(l,s),n.hitTest({globalOpacity:1,painter:n,context:a,drawPhase:d.HITTEST,pixelRatio:e.pixelRatio,displayLevel:e.displayLevel,rendererInfo:this._rendererInfo,requiredLevel:s,state:l,stationary:e.stationary,attributeView:this.attributeView},this.children)},t.prototype._updateTilesTransform=function(e,t){for(var i=0,r=this.children;i<r.length;i++){var n=r[i],a=this.tileInfoView.tileInfo.lods[n.key.level].resolution,s=a/(e.resolution*e.pixelRatio);n.setTransform(e,s),n.setLabelTransform(e,a)}},t.prototype._buildHLList=function(){return a(this,void 0,void 0,function(){var e,t,i,r;return n(this,function(n){switch(n.label){case 0:return[4,this._layerView.getLocalIdsToHighlight()];case 1:for(e=n.sent(),t=0,i=this.children;t<i.length;t++)r=i[t],r.buildHLList(e);return[2]}})})},t}(u.Container);t.WGLFeatureView=c});