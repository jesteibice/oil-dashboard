(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/3d/layers/PointCloudWorker":2122,"esri/views/3d/layers/PointCloudLayerView3D":2152,"esri/views/layers/LayerView":2174,"esri/views/3d/layers/LayerView3D":2176,"esri/views/3d/layers/support/layerViewUpdatingProperties":2180,"esri/views/3d/layers/i3s/PointCloudRendererUtil":2227,"esri/views/3d/layers/i3s/LoDUtil":2519,"esri/views/3d/layers/i3s/PagedNodeIndex":2520,"esri/views/3d/layers/i3s/PointRenderer":2521,"esri/views/3d/webgl-engine/shaders/PointRendererPrograms":2522})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{2122:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(12),r(7),r(182),r(164),r(476),r(2201),r(10),r(354),r(32),r(2184),r(2209),r(2227),r(38),r.dj.m(e)],void 0===(i=function(e,t,r,n,i,o,a,s,l,d,u,p,c,h,f,g){Object.defineProperty(t,"__esModule",{value:!0});var _=function(){function e(){}return e.prototype._process=function(e){var t=this._transform(e);return n.resolve({result:t,transferList:[t.points.buffer,t.rgb.buffer]})},e.prototype._transform=function(e){var t=this.readGeometry(e.schema,e.geometryBuffer),r=t.length/3,n=h.evaluateRenderer(e.rendererInfo,e.primaryAttribute,e.modulationAttribute,t,r);e.filterInfo&&e.filterInfo.length>0&&(r=h.filterInPlace(t,n,e.filterInfo,e.filterAttributes)),3*r<n.length&&(n=new Uint8Array(n.buffer.slice(0,3*r))),this._applyElevationOffsetInPlace(t,r,e.elevationOffset);var i=this._transformCoordinates(t,r,e.obb,u.fromJSON(e.inSR),u.fromJSON(e.outSR));return{obb:e.obb,points:i,rgb:n}},e.prototype.readGeometry=function(e,t){if(null==e.encoding||""===e.encoding){for(var r=p.createGeometryIndexFromSchema(t,e),n=p.createTypedView(t,r.vertexAttributes.position),i=r.header.fields,o=[i.offsetX,i.offsetY,i.offsetZ],a=[i.scaleX,i.scaleY,i.scaleZ],s=n.length/3,l=new Float64Array(3*s),d=0;d<s;d++)l[3*d]=n[3*d]*a[0]+o[0],l[3*d+1]=n[3*d+1]*a[1]+o[1],l[3*d+2]=n[3*d+2]*a[2]+o[2];return l}if("lepcc-xyz"===e.encoding)return c.decodeXYZ(t).result},e.prototype._transformCoordinates=function(e,t,r,n,i){if(!f.bufferToBuffer(e,n,0,e,i,0,t))throw Error("Can't reproject");var o=d.vec3f32.fromValues(r.center[0],r.center[1],r.center[2]),s=d.vec3f32.create(),u=d.vec3f32.create();a.quat.conjugate(v,r.quaternion);for(var p=new Float32Array(3*t),c=0;c<t;c++)s[0]=e[3*c]-o[0],s[1]=e[3*c+1]-o[1],s[2]=e[3*c+2]-o[2],l.vec3.transformQuat(u,s,v),r.halfSize[0]=Math.max(r.halfSize[0],Math.abs(u[0])),r.halfSize[1]=Math.max(r.halfSize[1],Math.abs(u[1])),r.halfSize[2]=Math.max(r.halfSize[2],Math.abs(u[2])),p[3*c]=s[0],p[3*c+1]=s[1],p[3*c+2]=s[2];return p},e.prototype._applyElevationOffsetInPlace=function(e,t,r){if(0!==r)for(var n=0;n<t;n++)e[3*n+2]+=r},e}(),v=s.quatf32.create(),y=function(t){function a(){var r=t.call(this)||this;return r._thread=void 0,o.open(i.getAbsMid("./PointCloudWorker",e,g)).then(function(e){void 0===r._thread?r._thread=e:e.close()}),r}return r(a,t),a.prototype.destroy=function(){this._thread&&this._thread.close(),this._thread=null},a.prototype.transform=function(e,t,r){return this._thread?this._thread.invoke("_process",e,{transferList:t,signal:r}):n.resolve(this._transform(e))},a}(_);t.PointCloudWorker=y,t.default=function(){return new _}}.apply(null,n))||(e.exports=i)},2152:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1),r(0),r(23),r(58),r(58),r(13),r(7),r(20),r(59),r(29),r(2),r(10),r(354),r(55),r(44),r(91),r(839),r(497),r(2176),r(2122),r(2182),r(2519),r(2520),r(2227),r(2521),r(2180),r(41),r(2195),r(38),r(826)],void 0===(i=function(e,t,r,n,i,o,a,s,l,d,u,p,c,h,f,g,_,v,y,m,b,S,P,x,w,N,R,z,O,C,I,V){var k=s.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),M=O.plane.create(),U=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.maximumPointCount=4e6,t.slicePlaneEnabled=!1,t._renderer=null,t._rendererAdded=!1,t._renderedNodes=new Set,t._nodeScales=new Map,t._updateViewNeeded=!0,t._lodFactor=1,t._worker=new S.PointCloudWorker,t._maxLoggedBoxWarnings=5,t._pageMultiplier=1,t._indexQueue=[],t._workQueue=[],t._idleQueue=new y.PromiseQueue,t._indexPagesLoading=new Map,t._loadingNodes=new Map,t._layerIsVisible=!1,t._totalWork=0,t._index=null,t._loadingInitNodePage=!1,t._nodeIdArray=[],t}return r(t,e),Object.defineProperty(t.prototype,"pointScale",{get:function(){var e=N.getSplatSizeAlgorithm(this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useRealWorldSymbolSizes",{get:function(){var e=N.getFixedSizeAlgorithm(this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){var e=N.getFixedSizeAlgorithm(this.layer.renderer);return e&&null!=e.size?e.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseDensity",{get:function(){return this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_clippingBox",{get:function(){var e=g.create(),t=this.view.renderSpatialReference;return I.extentToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_elevationOffset",{get:function(){var e=this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=u.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=m.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._tmpPoint=v.makeDehydratedPoint(0,0,0,this.layer.spatialReference),P.checkPointCloudLayerValid(this.layer),P.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._initRenderer();var t=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.handles.add([p.init(this,"_clippingBox",function(){return e._setUpdateViewNeeded()}),p.init(this,"_elevationOffset",function(){return e._elevationOffsetChanged()}),p.init(this.layer,"renderer",function(){return e._rendererChanged()}),p.init(this.layer,"filters",function(){return e._filterChanged()}),this.view.basemapTerrain.on("scale-change",function(t){return e._scaleUpdateHandler(t)}),this.layer.watch(["minScale","maxScale"],function(){return e._setUpdateViewNeeded()}),p.init(this,"clippingArea",function(){e._setUpdateViewNeeded()}),this.view.state.watch("camera",function(){return e._setUpdateViewNeeded()}),r.events.on("quality-changed",function(){return e._setUpdateViewNeeded()})]),this.addResolvingPromise(t);var n=this.view.resourceController.scheduler;this.when(function(){e.handles.add([n.registerTask(2,function(t){return e._process(t)},function(){return e._needsUpdate()}),n.registerIdleStateCallbacks(function(){return e._idleBegin()},function(){return e._idleEnd()}),p.init(e,"suspended",function(t){t?e._clearNodeState():e._setUpdateViewNeeded()})])})},t.prototype._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},t.prototype.destroy=function(){this.cancelLoading(),this._worker.destroy(),this._worker=null,this._destroyRenderer(),this._memCache.destroy(),this._memCache=null},t.prototype._initRenderer=function(){var e=this;this._renderer=new R,this._renderer.layerUid=this.layer.uid,this.handles.add(p.init(this,"_clippingBox",function(t){return e._renderer.clippingBox=t})),this.handles.add(p.init(this,"suspended",function(t){return e._setPointsVisible(!t)})),this.handles.add(p.init(this,"pointScale",function(t){return e._renderer.scaleFactor=t})),this._renderer.minSizePx=Math.sqrt(2),this.handles.add(p.init(this,"useRealWorldSymbolSizes",function(t){return e._renderer.useRealWorldSymbolSizes=t})),this.handles.add(p.init(this,"pointSize",function(t){var r=d.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r})),this.handles.add(p.init(this,"slicePlaneEnabled",function(t){return e._renderer.slicePlaneEnabled=t})),this.handles.add(p.init(this,["inverseDensity","maximumPointCount"],function(){return e._setUpdateViewNeeded()})),this.handles.add(p.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(t){e._lodFactor=t,e._setUpdateViewNeeded()}))},t.prototype._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},t.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([6],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},t.prototype._rendererChanged=function(){this._clearNodeState(),this._memCache.clear(),this._renderer.useFixedSizes=N.rendererUsesFixedSizes(this.layer.renderer),this._setUpdateViewNeeded()},t.prototype._filterChanged=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},t.prototype._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},t.prototype._scaleUpdateHandler=function(e){var t=this;this.layer.minScale||this.layer.maxScale?I.boundingRectToBoundingRect(e.extent,e.spatialReference,A,this.layer.spatialReference)&&(this._nodeScales.forEach(function(r,n){if(t._renderedNodes.has(n)){var i=t._index.getNode(n);_.containsPoint(A,i.obb.center)&&t._nodeScales.set(n,e.scale)}else t._nodeScales.delete(n)}),this._setUpdateViewNeeded()):this._nodeScales.clear()},t.prototype.displayNodes=function(e){this._workQueue=x.nodeDiff(o.keysOfSet(this._renderedNodes),e,this._index),x.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),x.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},t.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},t.prototype._cancelNodeLoading=function(){var e=[];this._loadingNodes.forEach(function(t){var r=t.abortController;return e.push(r)}),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++)r[t].abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._updateQueues=function(){var e=this,t=new Set;this._workQueue.forEach(function(e){e.load.forEach(function(e){t.add(e)})});var r=[],n=new Map;this._loadingNodes.forEach(function(e,i){t.has(i)?n.set(i,e):r.push(e)}),this._loadingNodes=n;for(var i=0,o=r;i<o.length;i++)o[i].abortController.abort();this._workQueue=this._workQueue.filter(function(t){for(var r=0,n=t.load;r<n.length;r++){var i=n[r];if(e._loadingNodes.has(i))return!1}return!0}),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach(function(e){return e.abortController.abort()}),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._clearNodeState=function(){var e=this;this._renderedNodes.forEach(function(t){return e._removeFromRenderer(t)}),this._cancelNodeLoading()},t.prototype._idleBegin=function(){this._setUpdateViewNeeded()},t.prototype._idleEnd=function(){this._setUpdateViewNeeded()},t.prototype._needsUpdate=function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0},t.prototype._process=function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var r=this._isRootNodeVisible();r!==this._layerIsVisible&&(this._layerIsVisible=r,this.notifyChange("suspended"))}}else{for(e.run(function(){return t._updateWorkQueues()});this._indexQueue.length>0&&e.run(function(){return t._processIndexQueue()}););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run(function(){return t._idleQueue.process()}););}},t.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift(),r=this._loadNodePage(t);return this._indexPagesLoading.set(t,r),r.promise.then(function(r){e._index.addPage(t,r,e._elevationOffset),e._setUpdateViewNeeded()}).then(function(){e._indexPagesLoading.delete(t)},function(){e._indexPagesLoading.delete(t)}),!0},t.prototype._processWorkQueue=function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(!t)return;this._processWorkEntry(t),e.madeProgress()}},t.prototype._scheduleWorkEntry=function(){var e=this;if(this._loadingNodes.size>=8)return null;for(var t=0;t<this._workQueue.length;++t){var r=this._workQueue[t];if(!a.find(r.remove,function(t){return!e._renderedNodes.has(t)})){for(var n=t;n>0;--n)this._workQueue[n]=this._workQueue[n-1];return this._workQueue.shift(),r}}return null},t.prototype._processWorkEntry=function(e){var t=this;if(0!==e.load.length)l.all(e.load.map(function(e){var r=l.createAbortController(),n=t._memCache.pop(e.toString());return n?t._loadingNodes.set(e,{abortController:r,promise:l.resolve(n)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:r,promise:t.loadNode(e,r.signal)}),t._loadingNodes.get(e).promise})).then(function(r){for(var n=0;n<e.load.length;n++)if(r[n]){var i=t._setupRendererData(e.load[n],r[n]);t._addToRenderer(i)}for(n=0;n<e.remove.length;n++)t._removeFromRenderer(e.remove[n])}).catch(function(){}).then(function(){for(var r=0;r<e.load.length;r++)t._loadingNodes.delete(e.load[r]);t._updateLoading()}),this._updateLoading();else for(var r=0;r<e.remove.length;r++)this._removeFromRenderer(e.remove[r])},t.prototype._computeWork=function(){for(var e=0,t=0;t<this._workQueue.length;t++)e+=this._workQueue[t].load.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,(e+=this._loadingInitNodePage?100:0)+(this._updateViewNeeded?100:0)},Object.defineProperty(t.prototype,"updatingPercentageValue",{get:function(){var e=this._computeWork();return 100*Math.min(this._totalWork,e)/this._totalWork},enumerable:!0,configurable:!0}),t.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingPercentageValue")},t.prototype.canResume=function(){return this.inherited(arguments)&&this._layerIsVisible},t.prototype.isUpdating=function(){return this._computeWork()>0},t.prototype._initNodePages=function(){var e=this,t=this.layer.store.index,r=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new w(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,r),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()})},t.prototype._loadNodePage=function(e){var t=this,r=l.createAbortController(),n=this.baseUrl+"/nodepages/"+e*this._pageMultiplier;return{promise:this._requestJSON(n,r.signal).then(function(r){return r.data.nodes.map(function(r,n){return{resourceId:null!=r.resourceId?r.resourceId:e*t._index.pageSize+n,obb:r.obb,firstChild:r.firstChild,childCount:r.childCount,vertexCount:null!=r.vertexCount?r.vertexCount:r.pointCount,lodThreshold:null!=r.lodThreshold?r.lodThreshold:r.effectiveArea}})}),abortController:r}},t.prototype._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(n/(.75*t));n>t;)e*=i,r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(2);return this.displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0},t.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var n=this._index.getNode(e[r]);n&&(t+=n.vertexCount)}return t},t.prototype._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},t.prototype._isRootNodeVisible=function(){var e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:function(t,r,n){return e=n,!1},pageMiss:function(e,t){}}),e},t.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,n=r.frustum,i=this._clippingBox,o=r.viewForward,a=h.vec3.dot(o,r.eye),s=O.plane.fromNormalAndOffset(o,-a,M),l=r.perScreenPixelRatio/2,d=e*e,u=this._nodeIdArray;u.length=0;var p=V.extractSafeScaleBounds(this.layer),c=p.minScale,f=p.maxScale,g=0===c&&0===f?function(e){return u.push(e)}:function(e){var r=t._getScale(e);V.scaleBoundsPredicate(r,c,f)&&u.push(e)};return this._traverseVisible({frustumPlanes:n.planes,clippingBox:i},{predicate:function(e,r,n){if(!n)return!1;if(0===r.childCount)return g(e),!1;var i=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(i,r.lodThreshold,r.vertexCount,s,l)<=d&&(g(e),1))},pageMiss:function(e,r){g(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),u},t.prototype._getScale=function(e){var t=this._nodeScales.get(e);if(null==t){var r=this._index.getNode(e).obb.center;this._tmpPoint.x=r[0],this._tmpPoint.y=r[1],this._tmpPoint.z=r[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},t.prototype._computeAveragePixelArea=function(e,t,r,n,i){var o=Math.max(1e-7,C.minimumDistancePlane(e,n));return t/(o*o)/(4*i*i)/r},t.prototype.loadNode=function(e,t){var r=this,n=this._index.getNode(e),i=N.getRendererInfo(this.layer),o=N.getFilterInfo(this.layer),a=n.resourceId,s=[],d=function(e){var n=r.loadAttribute(a,e,t);return s.push(n),n};return this._idleQueue.push().then(function(){var e=r.loadGeometry(a,t);s.push(e);var n=d(i.primaryAttribute),u=d(i.modulationAttribute),p=o.map(function(e){return d(e.attributeInfo)});return l.all([e,n,u,l.all(p)])}).then(function(n){var a=n[0],s=n[1],l=n[2],d=n[3],u=[a];s&&u.push(s),l&&u.push(l);for(var p=0,c=d;p<c.length;p++){var h=c[p];u.push(h)}var f={geometryBuffer:a,primaryAttribute:s,modulationAttribute:l,filterAttributes:d,schema:r.layer.store.defaultGeometrySchema,rendererInfo:i,filterInfo:o,obb:r._index.getRenderObb(e),elevationOffset:r._elevationOffset,inSR:r.layer.spatialReference.toJSON(),outSR:r.view.renderCoordsHelper.spatialReference.toJSON()};return r._worker.transform(f,u,t)}).catch(function(e){return l.isAbortError(e)||k.error(e),l.reject(e)})},t.prototype.loadGeometry=function(e,t){var r=this.baseUrl+"/nodes/"+e+"/geometries/0";return this._requestBinary(r,t).then(function(e){return e.data})},t.prototype.loadAttribute=function(e,t,r){if(!t||!t.storageInfo)return l.resolve(null);var n=t.storageInfo.key,i=this.baseUrl+"/nodes/"+e+"/attributes/"+n;return this._requestBinary(i,r).then(function(e){return e.data})},t.prototype._requestJSON=function(e,t){return i(e,{query:{f:"json"},responseType:"json",signal:t})},t.prototype._requestBinary=function(e,t){return i(e,{responseType:"array-buffer",signal:t})},t.prototype._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}},t.prototype._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},t.prototype._setupRendererData=function(e,t){var r=this._index.getNode(e),n=Math.sqrt(r.lodThreshold/r.vertexCount),i=this._index.getRenderObb(e);if(R.isInstanceOfNode(t))return t.splatSize=n,t.obb=i,t.origin=f.vec3f32.clone(t.obb.center),t;if(t.obb.halfSize[0]>i.halfSize[0]||t.obb.halfSize[1]>i.halfSize[1]||t.obb.halfSize[2]>i.halfSize[2]){if(this._maxLoggedBoxWarnings>0){var o=function(e){return"["+e.halfSize[0]+", "+e.halfSize[1]+", "+e.halfSize[2]+"]"};k.warn("Node "+e+" reported bounding box too small. got "+o(i)+" but points cover "+o(t.obb)),0==--this._maxLoggedBoxWarnings&&k.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:f.vec3f32.clone(i.center),rgb:t.rgb,splatSize:n,obb:i,isLeaf:0===r.childCount}},t.prototype.getUsedMemory=function(){var e=this;return o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+15*e._index.getNode(r).vertexCount+128},0)},t.prototype.getUnloadedMemory=function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var r=o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount}),n=this._loadingNodes.size,i=0;i<this._workQueue.length;i++)n+=this._workQueue[i].load.length,n-=this._workQueue[i].remove.length;return n<0?0:n*r/t*15+128*n},t.prototype.ignoresMemoryFactor=function(){return!1},t.prototype.getStats=function(){var e=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":o.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}},n([c.property()],t.prototype,"layer",void 0),n([c.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],t.prototype,"baseUrl",void 0),n([c.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointScale",null),n([c.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"useRealWorldSymbolSizes",null),n([c.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointSize",null),n([c.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"inverseDensity",null),n([c.property()],t.prototype,"maximumPointCount",void 0),n([c.property({readOnly:!0,dependsOn:["view.clippingArea"]})],t.prototype,"_clippingBox",null),n([c.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"_elevationOffset",null),n([c.property({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),n([c.property(z.updatingPercentage)],t.prototype,"updatingPercentage",void 0),n([c.property({readOnly:!0})],t.prototype,"updatingPercentageValue",null),n([c.subclass("esri.views.3d.layers.PointCloudLayerView3D")],t)}(c.declared(b)),A=_.create();return U}.apply(null,n))||(e.exports=i)},2174:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1),r(0),r(50),r(353),r(284),r(13),r(283),r(7),r(2)],void 0===(i=function(e,t,r,n,i,o,a,s,l,d,u){return function(e){function t(t){var r=e.call(this)||this;return r.layer=null,r.parent=null,r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer),this.when().catch(function(t){if("layerview:create-error"!==t.name){var r=e.layer&&e.layer.id||"no id",n=e.layer&&e.layer.title||"no title";return s.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '"+n+"', id: '"+r+"')",t),d.reject(t)}})},t.prototype.destroy=function(){this.layer=this.view=this.parent=null},Object.defineProperty(t.prototype,"suspended",{get:function(){return!this.canResume()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&this.isUpdating()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullOpacity",{get:function(){var e=function(e){return null==e?1:e};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))},enumerable:!0,configurable:!0}),t.prototype.canResume=function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1},t.prototype.isUpdating=function(){return!1},n([u.property()],t.prototype,"layer",void 0),n([u.property()],t.prototype,"parent",void 0),n([u.property({readOnly:!0,dependsOn:["view","visible","layer.loaded","parent.suspended"]})],t.prototype,"suspended",null),n([u.property({type:Boolean,dependsOn:["suspended"],readOnly:!0})],t.prototype,"updating",null),n([u.property()],t.prototype,"view",void 0),n([u.property({dependsOn:["layer.visible"]})],t.prototype,"visible",null),n([u.property({dependsOn:["layer.opacity","parent.fullOpacity"]})],t.prototype,"fullOpacity",null),n([u.subclass("esri.views.layers.LayerView")],t)}(u.declared(o,i,a.Identifiable,l))}.apply(null,n))||(e.exports=i)},2176:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1),r(0),r(7),r(29),r(2),r(473),r(2174)],void 0===(i=function(e,t,r,n,i,o,a,s,l){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.slicePlaneEnabled=!1,t.supportsHeightUnitConversion=!1,t}return r(t,e),t.prototype.postscript=function(e){this.inherited(arguments),s.mayHaveHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())},t.prototype._validateHeightModelInfo=function(){var e=this;return i.create(function(t,r){o.whenFalseOnce(e.view.defaultsFromMap,"isHeightModelInfoSearching",function(){var n=s.rejectLayerError(e.layer,e.view.heightModelInfo,e.supportsHeightUnitConversion);n?r(n):t()})})},n([a.property()],t.prototype,"view",void 0),n([a.property()],t.prototype,"slicePlaneEnabled",void 0),n([a.subclass("esri.views.3d.layers.LayerView3D")],t)}(a.declared(l))}.apply(null,n))||(e.exports=i)},2180:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updatingPercentageValue={value:100,readOnly:!0},t.updatingPercentage={dependsOn:["updating","updatingPercentageValue"],readOnly:!0,value:0,get:function(){return this.updating?this.updatingPercentageValue:0}}}.apply(null,n))||(e.exports=i)},2227:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(367),r(368),r(369),r(2184)],void 0===(i=function(e,t,r,n,i,o){function a(e){for(var t=0,r=0,n=e||[];r<n.length;r++)t|=1<<n[r];return t}function s(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{storageInfo:i,useElevation:!1}}return null}function l(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t){var o="embedded-elevation"===i.encoding;return{storageInfo:o?null:i,useElevation:o}}}return"elevation"===t.toLowerCase()?{storageInfo:null,useElevation:!0}:null}function d(e,t,r,n){if(e&&e.useElevation){for(var i=new Float64Array(n),a=0;a<n;a++)i[a]=r[3*a+2];return i}return e&&t?o.readBinaryAttribute(e.storageInfo,t,n):null}function u(e){return null==e||"none"===e?null:"low-four-bit"===e?function(e){return 15&e}:"high-four-bit"===e?function(e){return(240&e)>>4}:"absolute-value"===e?function(e){return Math.abs(e)}:"modulo-ten"===e?function(e){return e%10}:null}Object.defineProperty(t,"__esModule",{value:!0}),t.getRendererInfo=function(e){var t=e.renderer,r=t&&t.type,n=t&&e.renderer.toJSON()||null,i=null,o=!1;"point-cloud-unique-value"===r?i=l(e.attributeStorageInfo,t.field):"point-cloud-stretch"===r?i=l(e.attributeStorageInfo,t.field):"point-cloud-class-breaks"===r?i=l(e.attributeStorageInfo,t.field):o="point-cloud-rgb"===r?null!=(i=s(e.attributeStorageInfo,t.field)):null!=(i=s(e.attributeStorageInfo,"RGB"));var a=null;return t&&t.colorModulation&&(a=l(e.attributeStorageInfo,t.colorModulation.field)),{rendererJSON:n,isRGBRenderer:o,primaryAttribute:i,modulationAttribute:a}},t.getFilterInfo=function(e){var t=e.filters;return t?t.map(function(t){return{filterJSON:t.toJSON(),attributeInfo:l(e.attributeStorageInfo,t.field)}}):[]},t.evaluateRenderer=function(e,t,o,a,s){var l=e.rendererJSON,p=e.isRGBRenderer,c=e.primaryAttribute,h=e.modulationAttribute,f=d(c,t,a,s),g=d(h,o,a,s),_=null,v=null;if(f&&p)_=f;else if(f&&"pointCloudUniqueValueRenderer"===l.type){var y=(v=i.fromJSON(l)).colorUniqueValueInfos;_=new Uint8Array(3*s);for(var m=u(v.fieldTransformType),b=0;b<s;b++)for(var S=(w=m?m(f[b]):f[b])+"",P=0;P<y.length;P++)if(y[P].values.indexOf(S)>=0){_[3*b]=y[P].color.r,_[3*b+1]=y[P].color.g,_[3*b+2]=y[P].color.b;break}}else if(f&&"pointCloudStretchRenderer"===l.type){var x=(v=n.fromJSON(l)).stops;for(_=new Uint8Array(3*s),m=u(v.fieldTransformType),b=0;b<s;b++){var w=m?m(f[b]):f[b],N=x.length-1;if(w<x[0].value)_[3*b]=x[0].color.r,_[3*b+1]=x[0].color.g,_[3*b+2]=x[0].color.b;else if(w>=x[N].value)_[3*b]=x[N].color.r,_[3*b+1]=x[N].color.g,_[3*b+2]=x[N].color.b;else for(P=1;P<x.length;P++)if(w<x[P].value){var R=(w-x[P-1].value)/(x[P].value-x[P-1].value);_[3*b]=x[P].color.r*R+x[P-1].color.r*(1-R),_[3*b+1]=x[P].color.g*R+x[P-1].color.g*(1-R),_[3*b+2]=x[P].color.b*R+x[P-1].color.b*(1-R);break}}}else if(f&&"pointCloudClassBreaksRenderer"===l.type){var z=(v=r.fromJSON(l)).colorClassBreakInfos;for(_=new Uint8Array(3*s),m=u(v.fieldTransformType),b=0;b<s;b++)for(w=m?m(f[b]):f[b],P=0;P<z.length;P++)if(w>=z[P].minValue&&w<=z[P].maxValue){_[3*b]=z[P].color.r,_[3*b+1]=z[P].color.g,_[3*b+2]=z[P].color.b;break}}else for(_=new Uint8Array(3*s),b=0;b<_.length;b++)_[b]=255;if(g&&v&&v.colorModulation){var O=v.colorModulation.minValue,C=v.colorModulation.maxValue;for(b=0;b<s;b++){var I=(w=g[b])>=C?1:w<=O?.3:.3+.7*(w-O)/(C-O);_[3*b]=I*_[3*b],_[3*b+1]=I*_[3*b+1],_[3*b+2]=I*_[3*b+2]}}return _},t.filterInPlace=function(e,t,r,n){for(var i=e.length/3,o=n.map(function(t,n){return d(r[n].attributeInfo,t,e,i)}),s=0,l=0;l<i;l++){for(var u=!0,p=0;p<r.length&&u;p++){var c=r[p].filterJSON,h=o[p][l];switch(c.type){case"pointCloudValueFilter":var f="exclude"===c.mode;-1!==c.values.indexOf(h)===f&&(u=!1);break;case"pointCloudBitfieldFilter":var g=a(c.requiredSetBits),_=a(c.requiredClearBits);(h&g)===g&&0==(h&_)||(u=!1);break;case"pointCloudReturnFilter":for(var v=15&h,y=h>>>4&15,m=y>1,b=1===v,S=v===y,P=!1,x=0,w=c.includedReturns;x<w.length;x++){var N=w[x];if("last"===N&&S||"firstOfMany"===N&&b&&m||"lastOfMany"===N&&S&&m||"single"===N&&!m){P=!0;break}}P||(u=!1)}}u&&(e[3*s]=e[3*l],e[3*s+1]=e[3*l+1],e[3*s+2]=e[3*l+2],t[3*s]=t[3*l],t[3*s+1]=t[3*l+1],t[3*s+2]=t[3*l+2],s++)}return s},t.getSplatSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"splat"===t.type?t:null},t.getFixedSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null},t.rendererUsesFixedSizes=function(e){var t=e&&e.pointSizeAlgorithm;return!(!t||!t.type)&&"fixed-size"===t.type}}.apply(null,n))||(e.exports=i)},2519:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(10)],void 0===(i=function(e,t,r){function n(e,t,r){for(var n=e;n>0;){var i=t.indexOf(n);if(i>=0)return i;n=r.getParentId(n)}return t.indexOf(n)}function i(e,t){for(var r=[e.remove[0]],n=[];1===r.length;){var i=r.pop();n.length=0;for(var o=0;o<e.load.length;o++){for(var a=e.load[o],s=t.getParentId(a);s!==i;)a=s,s=t.getParentId(a);var l=r.indexOf(a);l<0&&(l=r.length,r.push(a),n.push([])),n[l].push(e.load[o])}}var d=[];d.push({remove:e.remove,load:r});for(o=0;o<r.length;o++)n[o].length>1?d.push({remove:[r[o]],load:n[o]}):r[o]=n[o][0];return d}Object.defineProperty(t,"__esModule",{value:!0}),t.nodeDiff=function(e,t,r){for(var i=0;i<t.length;i++)s[i]=!1,l[i]=null;for(i=0;i<e.length;i++)o[i]=!1,a[i]=null;for(i=0;i<t.length;i++)(d=n(t[i],e,r))>=0&&(s[i]=!0,null!=a[d]?a[d].push(t[i]):a[d]=[t[i]]);for(i=0;i<e.length;i++){var d;(d=n(e[i],t,r))>=0&&(o[i]=!0,null!=l[d]?l[d].push(e[i]):l[d]=[e[i]])}var u=[];for(i=0;i<e.length;i++)null!=a[i]||o[i]||u.push({load:[],remove:[e[i]]});for(i=0;i<t.length;i++)null!=l[i]||s[i]||u.push({load:[t[i]],remove:[]});for(i=0;i<t.length;i++)null!=l[i]&&(l[i].length>1||l[i][0]!==t[i])&&u.push({load:[t[i]],remove:l[i]});for(i=0;i<e.length;i++)null!=a[i]&&(a[i].length>1||a[i][0]!==e[i])&&u.push({load:a[i],remove:[e[i]]});return u};var o=[!1],a=[null],s=[!1],l=[null];t.sortFrontToBack=function(e,t,n){return e.sort(function(e,i){if(0===e.load.length&&0===i.load.length)return 0;if(0===e.load.length)return-1;if(0===i.load.length)return 1;if(0===e.remove.length&&0===i.remove.length){var o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]);return r.vec3.dot(o,t)-r.vec3.dot(a,t)}return 0===e.remove.length?-1:0===i.remove.length?1:1===e.load.length&&1===i.load.length?(o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]),r.vec3.dot(o,t)-r.vec3.dot(a,t)):1===e.load.length?-1:1===i.load.length?1:(o=n.getRenderCenter(e.remove[0]),a=n.getRenderCenter(i.remove[0]),r.vec3.dot(o,t)-r.vec3.dot(a,t))})},t.splitWorkEntries=function(e,t,r){for(var n=0;n<e.length;++n){var o=e[n];if(o.load.length>t&&1===o.remove.length){var a=i(o,r);e[n]=a[0];for(var s=1;s<a.length;s++)e.push(a[s])}}},t.splitWorkEntry=i}.apply(null,n))||(e.exports=i)},2520:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(21),r(476),r(2201),r(10),r(6),r(55),r(2195),r(38)],void 0===(i=function(e,t,r,n,i,o,a,s,l,d){function u(e,t,r,i){for(var a=new l.ObbArray(e.length),s=0;s<e.length;s++){var u=e[s].obb,p=a.obbs[s];if(l.set(u,p),o.vec3.set(h,u.center[0],u.center[1],u.center[2]+i),!t.isGeographic&&r===d.SphericalECEFSpatialReference){d.computeLinearTransformation(t,h,g,r);var c=2*Math.sqrt(1+g[0]+g[5]+g[10]);_[0]=(g[9]-g[6])/c,_[1]=(g[2]-g[8])/c,_[2]=(g[4]-g[1])/c,_[3]=.25*c,n.quat.conjugate(_,_),n.quat.multiply(p.quaternion,_,p.quaternion)}d.bufferToBuffer(h,t,0,p.center,r,0,1)}return a.obbs}function p(e,t){return e/t|0}function c(e,t){return e%t}var h=a.vec3f64.create(),f=function(){function e(e,t,r){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=r}return e.prototype.addPage=function(e,t,r){for(void 0===r&&(r=0);this._pages.length<e;)this._pages.push(null);var n=u(t,this._nodeSR,this._renderSR,r);this._pages[e]={nodes:t,renderObbs:n,parents:new Uint32Array(this.pageSize)},function(e,t){for(var r=[0];r.length;)for(var n=r.pop(),i=e[p(n,t)].nodes[c(n,t)],o=0;o<i.childCount;o++){var a=i.firstChild+o;null!=e[p(a,t)]&&(e[p(a,t)].parents[c(a,t)]=n,r.push(a))}}(this._pages,this.pageSize)},e.prototype.hasPage=function(e){return!!this._pages[e]},e.prototype.getNode=function(e){var t=this.pageSize;return this._pages[p(e,t)].nodes[c(e,t)]},e.prototype.getRenderObb=function(e){var t=this.pageSize;return this._pages[p(e,t)].renderObbs[c(e,t)]},e.prototype.getRenderCenter=function(e){return this.getRenderObb(e).center},e.prototype.setRenderObb=function(e,t){var r=this.pageSize;l.set(t,this._pages[p(e,r)].renderObbs[c(e,r)])},e.prototype.getParentId=function(e){var t=this.pageSize;return this._pages[p(e,t)].parents[c(e,t)]},e.prototype.hasNodes=function(e,t){for(var r=p(e,this.pageSize),n=p(e+t-1,this.pageSize),i=r;i<=n;i++)if(null==this._pages[i])return!1;return!0},e.prototype.createVisibilityTraverse=function(){var e={index:this,queue:[],masks:[],tempAabb:s.create()};return function(t,r){return function(e,t,r){var n=e.index;if(n.hasNodes(0,1)){var i=e.queue;i.length=0,i.push(0);var o=e.masks;for(o.length=0,o.push(0);i.length>0;){var a=i.pop(),d=o.pop(),u=n.getNode(a),c=n.getRenderObb(a),h=!0;if(null!=t.clippingBox&&0==(d&(_=1<<t.frustumPlanes.length))){var f=l.toAaBoundingBox(c,e.tempAabb);s.contains(t.clippingBox,f)?d|=_:s.intersects(t.clippingBox,f)||(h=!1)}for(var g=0;g<t.frustumPlanes.length&&h;g++){var _;if(0==(d&(_=1<<g))){var v=l.intersectPlane(c,t.frustumPlanes[g]);v>0?h=!1:v<0&&(d|=_)}}if(r.predicate(a,u,h)){for(var y=u.firstChild,m=u.childCount,b=!1,S=p(y,n.pageSize),P=p(y+m-1,n.pageSize),x=S;x<=P;x++)if(!n.hasPage(x)){r.pageMiss(a,x),b=!0;break}if(!b)for(g=0;g<m;g++)i.push(y+g),o.push(d)}}}}(e,t,r)}},e}(),g=r.mat4f64.create(),_=i.quatf32.create();return f}.apply(null,n))||(e.exports=i)},2521:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(24),r(474),r(21),r(10),r(354),r(6),r(70),r(55),r(41),r(41),r(2195),r(170),r(857),r(65),r(2522),r(82),r(54),r(89)],void 0===(i=function(e,t,r,n,i,o,a,s,l,d,u,p,c,h,f,g,_,v,y,m){function b(e){return e?256:64}function S(e,t,r,n,i){if(r.drawScreenSpace)return r.fixedSize*t*n;var o=b(i)*t*n;return r.drawFixedSize?Math.min(r.fixedSize/2,o):r.screenMinSize>0?Math.min(Math.max(r.screenMinSize*t*n,e/2),o):Math.min(e/2,o)}function P(e,t,r,n,i){return r.drawScreenSpace?0:S(e,t,r,n,i)}function x(e,t,r){return null==r&&(r=s.vec3f64.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}var w=i.mat4f64.create(),N={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]},R=function(){function e(){this.needsRender=!1,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=d.create(d.POSITIVE_INFINITY),this._programRep=null,this._needsPrograms=!0,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=n.mat4f32.create(),this.tempVec3=a.vec3f32.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){var t=e.rctx;this._programRep=new f(t),this.needsRender=!0,this._needsPrograms=!0},e.prototype.uninitializeRenderContext=function(e){this._programRep.dispose(),this._programRep=null,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,r,n,i){var a=s.vec3f64.create(),f=s.vec3f64.create(),g=s.vec3f64.create(),_=s.vec3f64.create(),v=p.plane.create(),y=e.camera.perScreenPixelRatio/2,m=e.camera.near,b=this._getSizeParams();o.vec3.subtract(f,n,r);var N=1/o.vec3.length(f);o.vec3.scale(f,f,N),o.vec3.negate(g,f),l.vec4.set(v,f[0],f[1],f[2],-o.vec3.dot(f,r));var R={},z={},O=[],C=d.create(),I=d.create(this._clipBox);d.offset(I,-r[0],-r[1],-r[2],I);for(var V=0,k=this.nodes;V<k.length;V++){var M=k[V],U=M.splatSize*this._scaleFactor,A=c.minimumDistancePlane(M.obb,v),F=c.maximumDistancePlane(M.obb,v);if(A-=P(U,A+m,b,y,M.isLeaf),!((F-=P(U,F+m,b,y,M.isLeaf))<0)&&!(null!=R.dist&&null!=z.dist&&R.dist<A*N&&z.dist>F*N)){var L=S(U,F+m,b,y,M.isLeaf);if(c.intersectLine(M.obb,r,f,L)){var W=L*L;c.toAaBoundingBox(M.obb,C),d.offset(C,-r[0],-r[1],-r[2],C);var E=!d.contains(I,C);o.vec3.subtract(_,M.origin,r);for(var B=M.coordinates.length/3,Q=0;Q<B;Q++)if(a[0]=_[0]+M.coordinates[3*Q],a[1]=_[1]+M.coordinates[3*Q+1],a[2]=_[2]+M.coordinates[3*Q+2],!E||d.containsPoint(I,a)){var j=o.vec3.dot(a,f),q=o.vec3.squaredLength(a)-j*j;if(!(q>W)){var T=j+m,D=P(U,T,b,y,M.isLeaf);if(!(j-D<0)){var J=S(U,T-=D,b,y,M.isLeaf);if(!(q>J*J)){var H=this.layerUid+"/"+M.id+"/"+Q,G=(j-D)*N;if(null==R.dist||G<R.dist){var Y=R;(null==t||t(r,n,G))&&(Y.point=x(M,Q,Y.point),Y.dist=G,Y.normal=g,Y.pointId=H,Y.layerUid=this.layerUid)}if(null==z.dist||G>z.dist){Y=z;(null==t||t(r,n,G))&&(Y.point=x(M,Q,Y.point),Y.dist=G,Y.normal=g,Y.pointId=H,Y.layerUid=this.layerUid)}if((null==t||t(r,n,G))&&e.enable.storeAll){var Z={};Z.point=x(M,Q,Z.point),Z.dist=G,Z.normal=g,Z.pointId=H,Z.layerUid=this.layerUid,O.push(Z)}}}}}}}}if(null!=R.dist){var X=e.results.min;if(null==X.dist||R.dist<X.dist){var K={type:"external",point:R.point,metadata:{pointId:R.pointId,layerUid:R.layerUid}};X.set(K,R.pointId,R.dist,R.normal,w,void 0),X.intersector="PointRenderer"}}if(null!=z.dist){var $=e.results.max;if(null==$.dist||z.dist>$.dist){K={type:"external",point:z.point,metadata:{pointId:z.pointId,layerUid:z.layerUid}};$.set(K,z.pointId,z.dist,z.normal,w,void 0),$.intersector="PointRenderer"}}if(e.enable.storeAll)for(var ee=u.ray.fromPoints(r,n),te=0,re=O;te<re.length;te++){K={type:"external",point:(Y=re[te]).point,metadata:{pointId:Y.pointId,layerUid:Y.layerUid}};var ne=new h.IntersectorResult(ee);ne.set(K,Y.pointId,Y.dist,Y.normal,w,void 0),ne.intersector="PointRenderer",e.results.all.push(ne)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass)return!1;this.needsRender=!1;for(var t=1===e.pass,n=e.rctx,i=0,a=this.nodes;i<a.length;i++){null==(v=a[i]).vao&&this._initNode(e,v)}this._selectPrograms();var s=this._getSizeParams(),l=t?s.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:s.drawScreenSpace?this._programScreen:this._programWorld;if(null==l||0===this.nodes.length)return!0;var u=this._clipBox,p=!d.equals(u,d.POSITIVE_INFINITY,function(e,t){return e===t});p||(o.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),l.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,1/0,1/0,1/0),l.setUniform3fv("uClipMax",this.tempVec3)),n.bindProgram(l),n.setPipelineState(this._pipelineState),l.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&l.setUniform2f("nearFar",e.camera.near,e.camera.far);var c=e.camera.pixelRatio;s.drawFixedSize&&l.setUniform2f("uPointScale",s.fixedSize*c,e.camera.fullHeight);for(var h=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,f=0,_=this.nodes;f<_.length;f++){var v=_[f];if(l.setUniform2f("uScreenMinMaxSize",s.screenMinSize*c,b(v.isLeaf)*c),!s.drawFixedSize){var y=v.splatSize*this._scaleFactor;l.setUniform2f("uPointScale",y*c,e.camera.fullHeight/c)}var m=v.origin;p&&(o.vec3.set(this.tempVec3,u[0]-m[0],u[1]-m[1],u[2]-m[2]),l.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,u[3]-m[0],u[4]-m[1],u[5]-m[2]),l.setUniform3fv("uClipMax",this.tempVec3)),r.mat4.identity(this.tempMatrix4),r.mat4.translate(this.tempMatrix4,this.tempMatrix4,m),r.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),l.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),h&&g.bindSlicePlane(m,h,l),n.bindVAO(v.vao),n.drawArrays(0,0,v.coordinates.length/3)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){d.set(this._clipBox,e||d.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender(),this._needsPrograms=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._requestRender()},e.prototype.removeNode=function(e){var t=null;return this.nodes=this.nodes.filter(function(r){return r.id!==e||(t=r,r.vao&&(r.vao.dispose(!0),r.vao=null),!1)}),this._requestRender(),t},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var r=e.rctx;t.vao=new m(r,_.program.attributes,N,{positions:v.createVertex(r,35044,t.coordinates),colors:v.createVertex(r,35044,t.rgb)})},e.prototype._requestRender=function(){this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,r=t?this._sizePx:this._size,n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:r,screenMinSize:n}},e.prototype._selectPrograms=function(){this._needsPrograms&&(this._needsPrograms=!1,this._programWorld=this._programRep.getProgram(_.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(_.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(_.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(_.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._pipelineState=y.makePipelineState({depthTest:{func:513},depthWrite:y.defaultDepthWriteParams,colorWrite:y.defaultColorWriteParams}))},e}();return function(e){(R||(R={})).isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")}}(),R}.apply(null,n))||(e.exports=i)},2522:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(72),r(71)],void 0===(i=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){return n.glslifyDefineMap({DEPTH_PASS:e.depthPass,DRAW_SCREEN_SIZE:e.drawScreenSize,SLICE:e.slicePlaneEnabled})};t.program={name:"point-renderer",shaders:function(e){return{vertexShader:i(e)+r.resolveIncludes("pointRenderer/pointRenderer.vert"),fragmentShader:i(e)+r.resolveIncludes("pointRenderer/pointRenderer.frag")}},attributes:{aPosition:0,aColor:1}}}.apply(null,n))||(e.exports=i)}}]);